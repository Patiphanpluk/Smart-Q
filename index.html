<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Q-Master Queue System</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <!-- HTML5-QRCode Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Sarabun', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            overflow-x: hidden; 
            background-color: #f8fafc; 
        }
        
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        .animate-bounce-slow { animation: bounce 2s infinite; }
        .animate-pop-in { animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop-in { from { opacity: 0; transform: scale(0.9) translate(-50%, -50%); } to { opacity: 1; transform: scale(1) translate(-50%, -50%); } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-900 min-h-screen w-screen">
    <div id="root" class="w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // ==========================================
        // 1. ตั้งค่า FIREBASE Config
        // ==========================================
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBsN1ACDYvJzoVc6mhtu9n-HNi1KDNFV24",
            authDomain: "project-6337867036145290950.firebaseapp.com",
            projectId: "project-6337867036145290950",
            storageBucket: "project-6337867036145290950.firebasestorage.app",
            messagingSenderId: "298203222498",
            appId: "1:298203222498:web:b3ef416d58b79c748ba9bb",
            measurementId: "G-1LJY6YJQBZ"
        };

        const initFirebase = () => {
            let config;
            if (YOUR_FIREBASE_CONFIG.apiKey === "วาง_API_KEY_ที่นี่" || YOUR_FIREBASE_CONFIG.apiKey === "") {
                 if (typeof __firebase_config !== 'undefined') {
                    config = JSON.parse(__firebase_config);
                 } else {
                    throw new Error("PLEASE_SETUP_FIREBASE");
                 }
            } else {
                config = YOUR_FIREBASE_CONFIG;
            }

            if (!firebase.apps.length) {
                try {
                    firebase.initializeApp(config);
                } catch (e) {
                    console.error("Firebase init failed", e);
                    throw e;
                }
            }
            return {
                auth: firebase.auth(),
                db: firebase.firestore()
            };
        };

        const Icon = ({ d, size=24, className="" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d}/></svg>
        );
        const Icons = {
            User: (p) => <Icon d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2 M12 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8" {...p} />,
            Monitor: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>,
            Bell: (p) => <Icon d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9 M10.3 21a1.94 1.94 0 0 0 3.4 0" {...p} />,
            Check: (p) => <Icon d="M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4 12 14.01l-3-3" {...p} />,
            Clock: (p) => <Icon d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20 M12 6v6l4 2" {...p} />,
            Users: (p) => <Icon d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8 M22 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75" {...p} />,
            Cross: (p) => <Icon d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20 M15 9l-6 6 M9 9l6 6" {...p} />,
            Volume: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>,
            Link: (p) => <Icon d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6 M15 3h6v6 M10 14L21 3" {...p} />,
            Alert: (p) => <Icon d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z M12 9v4 M12 17h.01" {...p} />,
            Loader: (p) => <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width={24} height={24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56" /></svg>,
            Settings: (p) => (
                <img src="https://img2.pic.in.th/pic/settings3209826b30ab5f22.png" width={p.size||24} height={p.size||24} className={`object-contain ${p.className||''}`} alt="Settings" />
            ),
            Trash: (p) => <Icon d="M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" {...p} />,
            History: (p) => <Icon d="M3 3v5h5 M3.05 13A9 9 0 1 0 6 5.3L3 8" {...p} />,
            Skip: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="m13 19 6-6-6-6"/><path d="M5 12h14"/></svg>,
            Edit: (p) => <Icon d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7 M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" {...p} />,
            Lock: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            QrCode: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
            Scan: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/></svg>,
            Speaker: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><rect x="4" y="9" width="6" height="6" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" /><path d="M11 5L6 9H2v6h4l5 4V5z" /></svg>,
            Repeat: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>
        };

        // --- Audio Singleton to ensure persistent audio context ---
        let globalAudioContext = null;

        const initGlobalAudio = () => {
            if (!globalAudioContext) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    globalAudioContext = new AudioContext();
                }
            }
            if (globalAudioContext && globalAudioContext.state === 'suspended') {
                globalAudioContext.resume();
            }
        };

        const playBeepSound = () => {
            if ("vibrate" in navigator) { try { navigator.vibrate([200, 100, 200]); } catch(e){} }
            
            initGlobalAudio(); 
            
            if (!globalAudioContext) return;

            const ctx = globalAudioContext;
            const beep = (startTime, freq) => {
                const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(freq, startTime);
                gain.gain.setValueAtTime(0.1, startTime);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.1);
                osc.start(startTime); osc.stop(startTime + 0.1);
            };
            
            const now = ctx.currentTime;
            beep(now, 800); beep(now + 0.15, 800); beep(now + 0.3, 1000);
        };

        const announceQueue = (queueNumber, customerName, mode = 'display') => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const parts = queueNumber.split('-');
                let numberText = "";
                if (parts[0]) {
                    if (parts[0] === 'A') numberText += "เอ ";
                    else if (parts[0] === 'B') numberText += "บี ";
                    else numberText += parts[0] + " ";
                }
                if (parts[1]) {
                    for (let char of parts[1]) {
                        if (char === '0') numberText += "ศูนย์ ";
                        else if (char === '1') numberText += "หนึ่ง ";
                        else if (char === '2') numberText += "สอง ";
                        else if (char === '3') numberText += "สาม ";
                        else if (char === '4') numberText += "สี่ ";
                        else if (char === '5') numberText += "ห้า ";
                        else if (char === '6') numberText += "หก ";
                        else if (char === '7') numberText += "เจ็ด ";
                        else if (char === '8') numberText += "แปด ";
                        else if (char === '9') numberText += "เก้า ";
                    }
                }
                let spokenText = "";
                if (mode === 'display') {
                    spokenText = "ขอเชิญหมายเลข " + numberText;
                    if (customerName) spokenText += " คุณ" + customerName;
                    spokenText += " เข้ารับบริการ"; 
                } else {
                    spokenText = "คิว " + numberText;
                    spokenText += " ถึงคิวของคุณแล้ว";
                }
                const utterance = new SpeechSynthesisUtterance(spokenText);
                utterance.lang = 'th-TH'; utterance.rate = 0.85; utterance.volume = 1;
                window.speechSynthesis.speak(utterance);
            }
        };

        const SetupError = ({ errorMsg }) => (
            <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                <div className="bg-white max-w-lg w-full rounded-2xl shadow-xl p-8 text-center border-t-4 border-red-500">
                    <div className="flex justify-center mb-4 text-red-500"><Icons.Alert size={64}/></div>
                    <h1 className="text-2xl font-bold text-slate-800 mb-2">เกิดข้อผิดพลาดในการเชื่อมต่อ</h1>
                    <p className="text-slate-600 mb-6 font-mono text-sm bg-slate-100 p-2 rounded break-all">{errorMsg}</p>
                    <a href="https://console.firebase.google.com/" target="_blank" className="inline-block bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-colors">ไปที่ Firebase Console</a>
                </div>
            </div>
        );

        const useWakeLock = () => {
            const wakeLockRef = useRef(null);
            const requestWakeLock = async () => {
                if ('wakeLock' in navigator) { try { wakeLockRef.current = await navigator.wakeLock.request('screen'); } catch (err) { console.error(err); } }
            };
            const releaseWakeLock = async () => {
                if (wakeLockRef.current) { await wakeLockRef.current.release(); wakeLockRef.current = null; }
            };
            useEffect(() => {
                const handleVisibilityChange = () => { if (wakeLockRef.current !== null && document.visibilityState === 'visible') requestWakeLock(); };
                document.addEventListener('visibilitychange', handleVisibilityChange);
                return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
            }, []);
            return { requestWakeLock, releaseWakeLock };
        };

        const AdminLogin = ({ onLogin }) => {
            const [pass, setPass] = useState('');
            const [err, setErr] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                if (pass === 'Admin123') onLogin(); else setErr('รหัสผ่านไม่ถูกต้อง');
            };
            return (
                <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
                        <div className="flex justify-center mb-6 text-indigo-600"><Icons.Lock size={48}/></div>
                        <h2 className="text-2xl font-bold text-center mb-6 text-slate-800">เข้าสู่ระบบ Admin</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <input type="password" value={pass} onChange={e => {setPass(e.target.value); setErr('');}} className="w-full border border-slate-200 rounded-xl px-4 py-3 text-center text-lg outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ใส่รหัสผ่าน" autoFocus />
                                {err && <div className="text-red-500 text-sm text-center mt-2">{err}</div>}
                            </div>
                            <button type="submit" className="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition-colors">เข้าสู่ระบบ</button>
                        </form>
                    </div>
                </div>
            );
        };

        const Toast = ({ message, type, show }) => {
            if (!show) return null;
            return (
                <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[100] animate-pop-in">
                    <div className={`px-8 py-5 rounded-2xl shadow-2xl font-bold text-white text-xl flex flex-col items-center gap-3 min-w-[240px] text-center backdrop-blur-md border border-white/20 ${type === 'error' ? 'bg-slate-800/90 text-red-400' : 'bg-slate-800/90 text-green-400'}`}>
                        <div className={`p-4 rounded-full ${type === 'error' ? 'bg-red-500/20' : 'bg-green-500/20'} mb-1`}>
                            {type === 'error' ? <Icons.Alert size={40}/> : <Icons.Check size={40}/>}
                        </div>
                        <span className="text-white">{message}</span>
                    </div>
                </div>
            );
        };

        function App() {
            const [viewMode, setViewMode] = useState('admin');
            const [queues, setQueues] = useState([]);
            const [myQueueId, setMyQueueId] = useState(() => localStorage.getItem('my_queue_id'));
            const [customerName, setCustomerName] = useState('');
            const [loading, setLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [services, setServices] = useState(null);
            const [user, setUser] = useState(null); 
            const [configError, setConfigError] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            const [audioEnabled, setAudioEnabled] = useState(false);
            const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
            
            // Settings State
            const [queuePrefix, setQueuePrefix] = useState('A'); 
            const [qrEnabled, setQrEnabled] = useState(false); 
            
            const [showSettings, setShowSettings] = useState(false);
            const [showHistory, setShowHistory] = useState(null); 
            
            // Popups & Toast State
            const [showSkipPopup, setShowSkipPopup] = useState(false);
            const [showClearPopup, setShowClearPopup] = useState(false);
            const [showConfirmPopup, setShowConfirmPopup] = useState(null); 
            const [showEditPopup, setShowEditPopup] = useState(null); 
            const [showScanner, setShowScanner] = useState(false); 
            const [showScannedAction, setShowScannedAction] = useState(null); 
            const [showRecallWait, setShowRecallWait] = useState(false); 
            const [recallCountdown, setRecallCountdown] = useState(0);

            // Auto Recall States
            const [showAutoRecallModal, setShowAutoRecallModal] = useState(false);
            const [autoRecallConfig, setAutoRecallConfig] = useState({ count: 3, interval: 10 });
            const [autoRecallState, setAutoRecallState] = useState({ active: false, current: 0, total: 0, timer: null });
            
            // New State for QR Modal
            const [showMyQR, setShowMyQR] = useState(false);
            
            const [skipNote, setSkipNote] = useState('');
            const [clearPassword, setClearPassword] = useState('');
            const [editName, setEditName] = useState('');
            const [queueToSkip, setQueueToSkip] = useState(null);
            const [savedNotes, setSavedNotes] = useState([]);
            
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });

            const skipInputRef = useRef(null);
            const clearInputRef = useRef(null);
            const editInputRef = useRef(null);
            const scannerRef = useRef(null); 

            const lastAnnouncedMyQueueRef = useRef(null);
            const lastAnnouncedDisplayRef = useRef(null);
            const { requestWakeLock } = useWakeLock();
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-queue-app';

            const showToastFn = (message, type = 'success') => {
                setToast({ show: true, message, type });
                setTimeout(() => setToast(prev => ({ ...prev, show: false })), 2000);
            };

            // --- Handle Audio Enable ---
            const handleEnableAudio = () => {
                initGlobalAudio();
                const silentAudio = "data:audio/mp3;base64,SUQzBAAAAAAAI1RTSVAAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD//////////////////////////////////wAAAAD/84QAAAAAExAAAAAAAAABAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA";
                const audio = new Audio(silentAudio);
                
                audio.play().then(() => { 
                    setAudioEnabled(true); 
                    showToastFn("เปิดเสียงเรียบร้อยแล้ว", "success");
                }).catch(e => {
                    console.error("Enable audio failed", e);
                    setAudioEnabled(true); 
                });
            };

            // Cleanup auto recall timer on unmount
            useEffect(() => {
                return () => { if (autoRecallState.timer) clearTimeout(autoRecallState.timer); };
            }, [autoRecallState.timer]);

            // Keyboard Shortcuts
            useEffect(() => {
                if (viewMode !== 'admin' || !isAdminAuthenticated) return;

                const handleKeyDown = (e) => {
                    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) return;
                    if (showSkipPopup || showClearPopup || showConfirmPopup || showEditPopup || showScanner || showScannedAction || showRecallWait || showAutoRecallModal) return;

                    if (e.key === 'ArrowRight') {
                        const currentServing = queues.find(q => q.status === 'serving');
                        if (currentServing) {
                            showToastFn("ยังมีคิวที่กำลังให้บริการอยู่ (กด Enter เพื่อจบงาน)", 'error');
                            return;
                        }
                        const nextQueue = queues.find(q => q.status === 'waiting');
                        if (nextQueue) updateStatus(nextQueue.id, 'serving');
                        else showToastFn("ไม่มีคิวรอเรียก", 'error');
                    } 
                    
                    if (e.key === 'Enter') {
                        const currentServing = queues.find(q => q.status === 'serving');
                        if (currentServing) updateStatus(currentServing.id, 'completed');
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [viewMode, isAdminAuthenticated, queues, showSkipPopup, showClearPopup, showConfirmPopup, showEditPopup, showScanner, showScannedAction, showRecallWait, showAutoRecallModal]);

            // Recall Countdown Logic
            useEffect(() => {
                let interval = null;
                if (showRecallWait && recallCountdown > 0) {
                    interval = setInterval(() => {
                        setRecallCountdown((prev) => prev - 1);
                    }, 1000);
                } else if (showRecallWait && recallCountdown === 0) {
                    setShowRecallWait(false);
                }
                return () => clearInterval(interval);
            }, [showRecallWait, recallCountdown]);


            // Scanner Logic
            useEffect(() => {
                if (showScanner) {
                    const timer = setTimeout(() => {
                        if (!scannerRef.current) {
                            const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 }, false);
                            html5QrcodeScanner.render((decodedText, decodedResult) => {
                                html5QrcodeScanner.clear().catch(e => console.error(e));
                                setShowScanner(false);
                                const scannedQ = queues.find(q => q.id === decodedText);
                                if (scannedQ) {
                                    setShowScannedAction({ queue: scannedQ });
                                } else {
                                    showToastFn("ไม่พบข้อมูลคิวนี้", "error");
                                }
                            }, (errorMessage) => {});
                            scannerRef.current = html5QrcodeScanner;
                        }
                    }, 100);
                    return () => clearTimeout(timer);
                } else {
                    if (scannerRef.current) {
                        scannerRef.current.clear().catch(e => console.error(e));
                        scannerRef.current = null;
                    }
                }
            }, [showScanner, queues]);

            useEffect(() => {
                try {
                    const { auth, db } = initFirebase();
                    setServices({ auth, db });
                    const unsubAuth = auth.onAuthStateChanged(async (u) => {
                        if (u) { setUser(u); } else {
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    try { await auth.signInWithCustomToken(__initial_auth_token); } catch { await auth.signInAnonymously(); }
                                } else { await auth.signInAnonymously(); }
                            } catch (authErr) { setErrorMsg("Auth Error: " + authErr.message); setConfigError(true); setLoading(false); }
                        }
                    });
                    const params = new URLSearchParams(window.location.search);
                    const mode = params.get('mode');
                    if (mode === 'kiosk') setViewMode('kiosk');
                    if (mode === 'display') setViewMode('display');
                    return () => unsubAuth();
                } catch (err) { setErrorMsg(err.message); setConfigError(true); setLoading(false); }
            }, []);

            useEffect(() => { if (showSkipPopup && skipInputRef.current) setTimeout(() => skipInputRef.current?.focus({ preventScroll: true }), 50); }, [showSkipPopup]);
            useEffect(() => { if (showClearPopup) { setClearPassword(''); setTimeout(() => clearInputRef.current?.focus({ preventScroll: true }), 50); } }, [showClearPopup]);
            useEffect(() => { if (showEditPopup) { setEditName(showEditPopup.queue.name); setTimeout(() => editInputRef.current?.focus({ preventScroll: true }), 50); } }, [showEditPopup]);

            useEffect(() => {
                if (!services?.db || !user) return; 
                let collectionRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues') : services.db.collection('queues');
                const unsubQueues = collectionRef.onSnapshot(snapshot => {
                    const loaded = [];
                    snapshot.forEach(doc => loaded.push({ id: doc.id, ...doc.data() }));
                    loaded.sort((a, b) => a.createdAt - b.createdAt);
                    setQueues(loaded); setLoading(false);
                }, err => { if (err.code !== 'permission-denied') console.error(err); setLoading(false); });

                let settingsRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('main') : services.db.collection('settings').doc('main');
                const unsubSettings = settingsRef.onSnapshot(doc => {
                    if (doc.exists) { 
                        const data = doc.data(); 
                        if (data.queuePrefix) setQueuePrefix(data.queuePrefix); 
                        setSavedNotes(data.savedNotes || []); // Ensure array or empty
                        if (data.qrEnabled !== undefined) setQrEnabled(data.qrEnabled);
                    }
                }, err => console.log("Settings sync skipped"));
                return () => { unsubQueues(); unsubSettings(); };
            }, [services, user]); 

            useEffect(() => {
                if (!myQueueId || queues.length === 0) return;
                const myQ = queues.find(q => q.id === myQueueId);
                if (myQ && myQ.status === 'serving') {
                    const lastPlayed = lastAnnouncedMyQueueRef.current;
                    const isNewCall = !lastPlayed || lastPlayed.id !== myQ.id || lastPlayed.calledAt !== myQ.calledAt;
                    if (isNewCall) {
                        playBeepSound(); 
                        setTimeout(() => announceQueue(myQ.number, myQ.name, 'client'), 1000);
                        lastAnnouncedMyQueueRef.current = { id: myQ.id, calledAt: myQ.calledAt };
                    }
                }
            }, [queues, myQueueId]);

            useEffect(() => {
                if (viewMode !== 'display' || queues.length === 0) return;
                const currentServing = queues.find(q => q.status === 'serving');
                if (currentServing) {
                    const lastPlayed = lastAnnouncedDisplayRef.current;
                    const isNewCall = !lastPlayed || lastPlayed.id !== currentServing.id || lastPlayed.calledAt !== currentServing.calledAt;
                    if (isNewCall) {
                        setTimeout(() => announceQueue(currentServing.number, currentServing.name, 'display'), 500);
                        lastAnnouncedDisplayRef.current = { id: currentServing.id, calledAt: currentServing.calledAt };
                    }
                }
            }, [queues, viewMode]);

            const handleBookQueue = async (e) => {
                e.preventDefault();
                if (!customerName.trim() || !services || !user) return;
                setIsSubmitting(true);
                await requestWakeLock();
                
                // Initialize audio on interaction
                initGlobalAudio();

                const prefixQueues = queues.filter(q => q.number.startsWith(queuePrefix));
                const maxNum = prefixQueues.reduce((max, q) => { const parts = q.number.split('-'); if (parts.length < 2) return max; const n = parseInt(parts[1]); return n > max ? n : max; }, 0);
                const nextNum = String(maxNum + 1).padStart(3, '0');
                const queueNumber = `${queuePrefix}-${nextNum}`;
                try {
                    let collectionRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues') : services.db.collection('queues');
                    const ref = await collectionRef.add({ number: queueNumber, name: customerName, status: 'waiting', createdAt: Date.now(), timestamp: new Date().toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'}), skipCount: 0, note: '' });
                    localStorage.setItem('my_queue_id', ref.id); setMyQueueId(ref.id); setCustomerName('');
                    
                    // Ensure audio enabled state in UI
                    setAudioEnabled(true);

                } catch (err) { showToastFn(err.message, 'error'); } finally { setIsSubmitting(false); }
            };

            const updateStatus = async (id, status) => {
                if (!user) return;
                try {
                    // Check if stopping auto recall is needed
                    if (autoRecallState.active) {
                        stopAutoRecall();
                    }

                    let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues').doc(id) : services.db.collection('queues').doc(id);
                    const updateData = { status }; if (status === 'serving') updateData.calledAt = Date.now();
                    await docRef.update(updateData);
                    if(showScannedAction) setShowScannedAction(null); 
                } catch (err) { console.error(err); }
            };

            const openSkipPopup = (queue) => { setQueueToSkip(queue); setSkipNote(''); setShowSkipPopup(true); };

            const handleConfirmSkip = async () => {
                if (!user || !queueToSkip) return;
                
                if (autoRecallState.active) stopAutoRecall();

                const noteToSave = skipNote.trim() === "" ? "ข้าม" : skipNote.trim();
                if (!savedNotes.includes(noteToSave)) {
                    try {
                        let settingsRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('main') : services.db.collection('settings').doc('main');
                        await settingsRef.set({ savedNotes: [...savedNotes, noteToSave] }, { merge: true });
                    } catch(e) {}
                }
                const currentSkipCount = queueToSkip.skipCount || 0;
                let newCreatedAt = queueToSkip.createdAt;
                const waitingList = queues.filter(q => q.status === 'waiting');
                if (currentSkipCount === 0) { if (waitingList.length > 0) newCreatedAt = waitingList[0].createdAt + 1; else newCreatedAt = Date.now(); } else { newCreatedAt = Date.now(); }
                try {
                    let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues').doc(queueToSkip.id) : services.db.collection('queues').doc(queueToSkip.id);
                    await docRef.update({ status: 'waiting', note: noteToSave, skipCount: currentSkipCount + 1, createdAt: newCreatedAt });
                    setShowSkipPopup(false); setQueueToSkip(null);
                    if(showScannedAction) setShowScannedAction(null);
                } catch (err) { showToastFn(err.message, 'error'); }
            };

            // Standard Single Recall
            const handleRecall = async (id) => {
                if (!user) return;
                
                // If manual recall is pressed while auto is running, stop auto first? 
                // Or just let it be. Let's safeguard by stopping auto if manual is pressed.
                if (autoRecallState.active && autoRecallState.timer) {
                    stopAutoRecall();
                }
                
                // Start Cooldown Logic
                setRecallCountdown(5); // 5 seconds cooldown
                setShowRecallWait(true);

                try {
                    let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues').doc(id) : services.db.collection('queues').doc(id);
                    await docRef.update({ status: 'serving', calledAt: Date.now() });
                    setShowHistory(null);
                    if(showScannedAction) setShowScannedAction(null);
                } catch (err) { console.error(err); }
            };

            // --- Auto Recall Logic ---

            const startAutoRecall = (queueId) => {
                const interval = parseInt(autoRecallConfig.interval);
                if (interval < 7) {
                    showToastFn("ระยะห่างต้องไม่ต่ำกว่า 7 วินาที", "error");
                    setAutoRecallConfig(prev => ({...prev, interval: 7}));
                    return;
                }
                setShowAutoRecallModal(false);
                performAutoRecallStep(queueId, 1, parseInt(autoRecallConfig.count));
            };

            const performAutoRecallStep = async (queueId, currentStep, totalSteps) => {
                if (currentStep > totalSteps) {
                    stopAutoRecall();
                    return;
                }
                
                // Update UI State
                setAutoRecallState(prev => ({ ...prev, active: true, current: currentStep, total: totalSteps }));
                
                // Trigger Recall (Update Firestore)
                try {
                    let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues').doc(queueId) : services.db.collection('queues').doc(queueId);
                    await docRef.update({ status: 'serving', calledAt: Date.now() });
                } catch (err) { console.error("Auto recall error", err); }

                // Schedule Next Step if not finished
                if (currentStep < totalSteps) {
                    const timer = setTimeout(() => {
                        performAutoRecallStep(queueId, currentStep + 1, totalSteps);
                    }, parseInt(autoRecallConfig.interval) * 1000);
                    setAutoRecallState(prev => ({ ...prev, timer }));
                } else {
                    // Cleanup after last step delay (to show completed state briefly)
                    setTimeout(() => stopAutoRecall(), 2000);
                }
            };

            const stopAutoRecall = () => {
                if (autoRecallState.timer) clearTimeout(autoRecallState.timer);
                setAutoRecallState({ active: false, current: 0, total: 0, timer: null });
            };


            const handleDeleteConfirm = async () => {
                if (!user || !showConfirmPopup) return;
                try {
                    let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues').doc(showConfirmPopup.id) : services.db.collection('queues').doc(showConfirmPopup.id);
                    await docRef.delete();
                    setShowConfirmPopup(null);
                    showToastFn("ลบรายการเรียบร้อย", 'success');
                } catch (err) { showToastFn("ลบไม่สำเร็จ: " + err.message, 'error'); }
            };

            const handleEditSubmit = async () => {
                if (!user || !showEditPopup) return;
                if (!editName.trim()) return;
                try {
                    let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues').doc(showEditPopup.queue.id) : services.db.collection('queues').doc(showEditPopup.queue.id);
                    await docRef.update({ name: editName.trim() });
                    setShowEditPopup(null);
                    showToastFn("แก้ไขชื่อเรียบร้อย", 'success');
                } catch (err) { showToastFn("แก้ไขไม่สำเร็จ: " + err.message, 'error'); }
            };

            const handleClearQueuesSubmit = async () => {
                if (clearPassword !== 'Admin123') { showToastFn('รหัสผ่านไม่ถูกต้อง', 'error'); return; }
                if (!user) return;
                try {
                    const batch = services.db.batch();
                    let collectionRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues') : services.db.collection('queues');
                    const snapshot = await collectionRef.get();
                    snapshot.docs.forEach((doc) => batch.delete(doc.ref));

                    let settingsRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('main') : services.db.collection('settings').doc('main');
                    batch.set(settingsRef, { savedNotes: [] }, { merge: true });

                    await batch.commit();
                    setSavedNotes([]); setQueues([]); // Instant UI update
                    setShowClearPopup(false);
                    showToastFn("ล้างข้อมูลและประวัติเรียบร้อยแล้ว", 'success');
                } catch (err) { showToastFn("Error clearing: " + err.message, 'error'); }
            };

            const handleSaveSettings = async () => {
                if (!user || !services) return;
                try {
                    let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('main') : services.db.collection('settings').doc('main');
                    await docRef.set({ queuePrefix: queuePrefix, qrEnabled: qrEnabled }, { merge: true });
                    setShowSettings(false);
                    showToastFn("บันทึกการตั้งค่าเรียบร้อย", 'success');
                } catch (err) { showToastFn("บันทึกไม่สำเร็จ: " + err.message, 'error'); }
            };

            const openKioskLink = () => { const url = new URL(window.location.href); url.searchParams.set('mode', 'kiosk'); window.open(url.toString(), '_blank'); };

            const waitingQueues = queues.filter(q => q.status === 'waiting');
            const currentServing = queues.find(q => q.status === 'serving');
            const myQueue = queues.find(q => q.id === myQueueId);
            
            let historyList = [];
            if (showHistory === 'all') historyList = [...queues].sort((a, b) => b.createdAt - a.createdAt);
            else if (showHistory) historyList = queues.filter(q => q.status === showHistory).sort((a, b) => b.createdAt - a.createdAt);

            if (configError) return <SetupError errorMsg={errorMsg} />;
            if (loading) return <div className="h-screen flex items-center justify-center text-slate-400">กำลังเชื่อมต่อระบบ...</div>;

            if (viewMode === 'admin' && !isAdminAuthenticated) return <AdminLogin onLogin={() => setIsAdminAuthenticated(true)} />;

            if (viewMode === 'kiosk') {
                return (
                    // Center Alignment Fix: Changed to h-[100dvh] and overflow-hidden to prevent scrolling as requested
                    <div className="h-[100dvh] w-screen bg-slate-100 flex flex-col items-center justify-center p-4 relative overflow-hidden fixed inset-0">
                        <Toast message={toast.message} type={toast.type} show={toast.show} />
                        
                        {/* 1. Missing Message Area - Alert Box (Top Overlay) */}
                        {myQueue && myQueue.status === 'serving' && (
                           <div className="fixed top-0 left-0 w-full bg-red-600 text-white p-4 z-50 animate-bounce-slow text-center shadow-lg flex flex-col items-center justify-center">
                              <div className="text-xl sm:text-2xl font-black flex items-center justify-center gap-2">
                                 <Icons.Bell size={28} className="animate-pulse"/> 
                                 คิว {myQueue.number} ถึงคิวของคุณแล้ว
                              </div>
                              <div className="text-sm opacity-90 mt-1">กรุณาติดต่อช่องบริการทันที</div>
                           </div>
                        )}
                        
                        {/* New: Skipped Message Area - Alert Box (Top Overlay) */}
                        {myQueue && myQueue.status === 'waiting' && myQueue.skipCount > 0 && (
                           <div className="fixed top-0 left-0 w-full bg-amber-500 text-white p-4 z-50 animate-bounce-slow text-center shadow-lg flex flex-col items-center justify-center">
                              <div className="text-xl sm:text-2xl font-black flex items-center justify-center gap-2">
                                 <Icons.Skip size={28} className="animate-pulse"/> 
                                 คุณถูกข้ามคิว
                              </div>
                              <div className="text-sm opacity-90 mt-1">เหตุผล: {myQueue.note} | กรุณารอเรียกอีกครั้ง</div>
                           </div>
                        )}

                        <div className="absolute top-4 text-slate-400 text-sm font-bold tracking-widest uppercase">Q-Master Kiosk</div>
                        
                        {(!myQueue || myQueue.status === 'completed' || myQueue.status === 'cancelled') ? (
                            <div className="bg-white w-full max-w-md rounded-3xl shadow-xl overflow-hidden animate-fade-in flex flex-col max-h-[90vh]">
                                <div className="bg-indigo-600 p-6 text-white text-center">
                                    <h1 className="text-2xl font-bold mb-2">รับบัตรคิว</h1>
                                    <p className="text-indigo-100 text-sm">กรอกชื่อเพื่อรับคิว ({queuePrefix})</p>
                                </div>
                                <div className="p-6 flex-1 overflow-y-auto">
                                    <form onSubmit={handleBookQueue} className="space-y-6">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-2">ชื่อของคุณ</label>
                                            <input autoFocus type="text" value={customerName} onChange={e => setCustomerName(e.target.value)} className="w-full px-4 py-4 text-lg border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="เช่น คุณสมชาย" disabled={isSubmitting} />
                                        </div>
                                        <button type="submit" disabled={isSubmitting} className={`w-full text-white font-bold py-4 rounded-xl text-lg shadow-lg shadow-indigo-200 transition-all flex items-center justify-center gap-2 ${isSubmitting ? 'bg-indigo-400' : 'bg-indigo-600 hover:bg-indigo-700 active:scale-95'}`}>
                                            {isSubmitting ? <><Icons.Loader size={24}/> กำลังบันทึก...</> : 'รับบัตรคิว'}
                                        </button>
                                        <div className="text-center text-slate-400 text-sm">รออยู่ <span className="text-indigo-600 font-bold">{waitingQueues.length}</span> คิว</div>
                                    </form>
                                </div>
                            </div>
                        ) : (
                            <div className="bg-white w-full max-w-md rounded-3xl shadow-xl overflow-hidden animate-fade-in relative flex flex-col max-h-[90vh] mt-8">
                                <div className="h-2 bg-gradient-to-r from-indigo-500 to-purple-500 flex-shrink-0"></div>
                                <div className="p-6 text-center space-y-4 flex-1 overflow-y-auto flex flex-col">
                                    <div className="flex-shrink-0"><span className="bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-xs font-bold tracking-wide">YOUR QUEUE</span><h1 className="text-6xl sm:text-7xl font-black text-slate-800 mt-4 tracking-tighter">{myQueue.number}</h1></div>
                                    
                                    <div className={`flex-shrink-0 inline-flex items-center justify-center gap-2 px-6 py-2 rounded-full font-bold shadow-sm mx-auto w-fit ${myQueue.status === 'waiting' ? (myQueue.skipCount > 0 ? 'bg-amber-100 text-amber-700 border border-amber-200' : 'bg-amber-50 text-amber-600') : 'bg-green-50 text-green-600 animate-pulse'}`}>
                                        {myQueue.status === 'waiting' ? (
                                            myQueue.skipCount > 0 ? (
                                                <><Icons.Skip size={20}/> ถูกข้าม: {myQueue.note}</>
                                            ) : (
                                                <><Icons.Clock size={20}/> กำลังรอเรียก...</>
                                            )
                                        ) : (
                                            <><Icons.Volume size={20}/> ถึงคิวคุณแล้ว!</>
                                        )}
                                    </div>

                                    <div className="bg-slate-50 rounded-2xl p-4 border border-slate-100 space-y-2 flex-shrink-0">
                                        <div className="flex justify-between items-end border-b border-slate-200 pb-2">
                                            <div className="text-left">
                                                <div className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">คิวปัจจุบัน</div>
                                                <div className="text-2xl font-black text-indigo-600 leading-none">{currentServing ? currentServing.number : '--'}</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">รออีก (คิว)</div>
                                                <div className="text-2xl font-black text-slate-700 leading-none">{queues.filter(q => q.status === 'waiting' && q.createdAt < myQueue.createdAt).length}</div>
                                            </div>
                                        </div>
                                        <div className="flex justify-between items-center text-sm pt-1">
                                            <span className="text-slate-400">ชื่อผู้จอง</span>
                                            <span className="font-bold text-slate-700 truncate max-w-[150px]">{myQueue.name}</span>
                                        </div>
                                        
                                        {/* QR Code Button Replacement */}
                                        {qrEnabled && (
                                            <div className="pt-2 mt-2 border-t border-slate-200">
                                                <button onClick={() => setShowMyQR(true)} className="w-full py-2 bg-white border border-slate-200 hover:bg-slate-50 rounded-lg flex items-center justify-center gap-2 text-slate-600 font-bold text-sm transition-colors">
                                                    <Icons.QrCode size={18} /> แสดง QR Code
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Audio Enable Button (Small) */}
                                    {!audioEnabled && (
                                        <button onClick={handleEnableAudio} className="flex-shrink-0 flex items-center justify-center gap-2 w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-600 py-2 rounded-xl font-bold text-sm transition-colors border border-indigo-200">
                                            <Icons.Speaker size={16}/> 🔔 เปิดเสียงแจ้งเตือน
                                        </button>
                                    )}

                                    <div className="flex-shrink-0 text-xs text-slate-400 bg-yellow-50 p-2 rounded text-center border border-yellow-100">
                                        ⚠️ กรุณาเปิดหน้านี้ค้างไว้เพื่อรับการแจ้งเตือนเมื่อถึงคิว
                                    </div>

                                    <button onClick={() => {localStorage.removeItem('my_queue_id'); setMyQueueId(null);}} className="flex-shrink-0 text-slate-400 text-sm hover:text-slate-600 underline mt-auto">จองคิวใหม่ / ออกจากหน้านี้</button>
                                </div>
                            </div>
                        )}

                        {/* QR Modal Overlay */}
                        {showMyQR && (
                            <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
                                 <div className="bg-white p-6 rounded-2xl w-full max-w-sm relative text-center shadow-2xl">
                                     <button onClick={() => setShowMyQR(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icons.Cross size={24}/></button>
                                     <h3 className="text-xl font-bold text-slate-800 mb-2">QR Code ของคุณ</h3>
                                     <p className="text-slate-500 text-sm mb-6">สแกนเพื่อติดตามสถานะคิวบนมือถือ</p>
                                     <div className="bg-slate-100 p-4 rounded-xl inline-block mb-6">
                                         <img src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${myQueue.id}`} alt="QR Code" className="w-48 h-48 mix-blend-multiply mx-auto" />
                                     </div>
                                     <button onClick={() => setShowMyQR(false)} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700">ปิดหน้าต่าง</button>
                                 </div>
                            </div>
                        )}
                    </div>
                );
            }

            if (viewMode === 'display') {
                return (
                    <div className="min-h-screen bg-slate-100 flex flex-col overflow-y-auto">
                        <div className="flex-1 w-full max-w-[95vw] mx-auto p-4 lg:p-8 flex flex-col justify-center my-auto">
                           <div className="flex flex-col lg:flex-row gap-6 lg:h-[85vh]">
                            <div className="flex-1 bg-gradient-to-br from-indigo-600 to-purple-700 rounded-3xl shadow-2xl flex flex-col items-center justify-center text-white relative overflow-hidden p-8 min-h-[50vh] lg:min-h-0">
                                {!audioEnabled && <button onClick={handleEnableAudio} className="absolute top-4 right-4 bg-white/20 px-4 py-2 rounded-full text-sm flex gap-2 z-50 hover:bg-white/30 transition-all"><Icons.Volume size={16}/> คลิกเพื่อเปิดเสียงพูด</button>}
                                <div className="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl transform translate-x-1/2 -translate-y-1/2"></div>
                                <h2 className="text-2xl font-medium opacity-80 mb-8 uppercase tracking-widest">Calling Queue</h2>
                                {currentServing ? (
                                    <div className="text-center animate-bounce-slow w-full">
                                        <div className="text-8xl md:text-[10rem] lg:text-[12rem] font-black leading-none tracking-normal drop-shadow-lg">{currentServing.number}</div>
                                        <div className="mt-8 bg-white/20 backdrop-blur-md px-12 py-6 rounded-full inline-block max-w-full"><span className="text-3xl md:text-4xl font-bold truncate block">{currentServing.name}</span></div>
                                        <div className="mt-10 text-2xl md:text-3xl text-indigo-200 font-bold animate-pulse">เชิญเข้ารับบริการ</div>
                                    </div>
                                ) : (
                                    <div className="text-center opacity-40"><div className="text-8xl md:text-9xl font-black">---</div><div className="text-2xl mt-4">Waiting...</div></div>
                                )}
                            </div>
                            <div className="w-full lg:w-[35rem] bg-white rounded-3xl shadow-xl border border-slate-100 flex flex-col overflow-hidden h-[40vh] lg:h-auto">
                                <div className="p-6 bg-slate-50 border-b border-slate-100 font-bold text-slate-600 flex items-center gap-2"><Icons.Clock size={20} className="text-indigo-500"/> Next Queue</div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar">
                                    {waitingQueues.slice(0, 7).map((q) => (
                                        <div key={q.id} className="flex items-center justify-between p-5 bg-white border border-slate-100 rounded-xl shadow-sm">
                                            <div className="flex items-center gap-4 w-full">
                                                <div className="w-24 h-16 bg-slate-100 rounded-xl flex-shrink-0 flex items-center justify-center font-bold text-2xl text-slate-600 whitespace-nowrap">{q.number}</div>
                                                <div className="min-w-0 flex-1">
                                                    <div className="font-bold text-slate-800 text-xl truncate">{q.name}</div>
                                                    <div className="text-sm text-slate-400 flex items-center gap-2"><span>Waiting</span><span>• {q.timestamp}</span></div>
                                                </div>
                                                {q.note && <div className="ml-auto text-xs text-red-500 bg-red-50 px-3 py-1 rounded-lg font-bold border border-red-100 whitespace-nowrap">{q.note}</div>}
                                            </div>
                                        </div>
                                    ))}
                                    {waitingQueues.length === 0 && <div className="text-center py-10 text-slate-300">No waiting queues</div>}
                                </div>
                            </div>
                           </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 pb-10 flex flex-col justify-start">
                    <Toast message={toast.message} type={toast.type} show={toast.show} />
                    
                    {/* Auto Recall Modal */}
                    {showAutoRecallModal && (
                        <div className="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in">
                                <h2 className="font-bold text-xl mb-4 text-indigo-900 flex items-center gap-2"><Icons.Repeat size={24}/> ตั้งค่าเรียกอัตโนมัติ</h2>
                                <div className="space-y-4 mb-6">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">จำนวนครั้งที่จะเรียกซ้ำ</label>
                                        <input 
                                            type="number" 
                                            min="1" max="10"
                                            value={autoRecallConfig.count}
                                            onChange={(e) => setAutoRecallConfig(prev => ({...prev, count: e.target.value}))}
                                            className="w-full border border-slate-200 rounded-xl px-4 py-3 text-lg text-center"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">ระยะห่างแต่ละครั้ง (วินาที)</label>
                                        <input 
                                            type="number" 
                                            min="7" max="60"
                                            value={autoRecallConfig.interval}
                                            onChange={(e) => setAutoRecallConfig(prev => ({...prev, interval: e.target.value}))}
                                            className="w-full border border-slate-200 rounded-xl px-4 py-3 text-lg text-center"
                                        />
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowAutoRecallModal(false)} className="flex-1 py-3 text-slate-500 hover:bg-slate-100 rounded-xl">ยกเลิก</button>
                                    <button onClick={() => startAutoRecall(currentServing.id)} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700">เริ่มทันที</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Recall Wait Popup (Single Recall) */}
                    {showRecallWait && (
                        <div className="fixed inset-0 z-[90] bg-black/70 flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl p-8 text-center max-w-sm w-full animate-bounce-slow shadow-2xl">
                                <div className="text-6xl font-black text-indigo-600 mb-4">{recallCountdown}</div>
                                <h2 className="text-xl font-bold text-slate-800">กรุณารอสักครู่...</h2>
                                <p className="text-slate-500 text-sm mt-2">ระบบกำลังเรียกคิว เพื่อป้องกันเสียงซ้อนกัน</p>
                            </div>
                        </div>
                    )}

                    <div className="bg-white border-b border-slate-200 sticky top-0 z-50 px-2 py-2 sm:px-4 sm:py-3 shadow-sm">
                        <div className="max-w-7xl mx-auto flex justify-between items-center gap-2">
                            <div className="flex items-center gap-2 font-bold text-xl text-indigo-900 flex-shrink-0">
                                <div className="bg-indigo-600 text-white w-8 h-8 rounded flex items-center justify-center">Q</div>
                                <span className="hidden md:inline">Q-Master Admin</span>
                            </div>
                            <div className="flex gap-1 bg-slate-100 p-1 rounded-lg flex-shrink-0">
                                <button onClick={() => setViewMode('admin')} className={`px-3 py-1.5 rounded-md text-xs sm:text-sm font-bold ${viewMode==='admin'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>Admin</button>
                                <button onClick={() => setViewMode('display')} className={`px-3 py-1.5 rounded-md text-xs sm:text-sm font-bold ${viewMode==='display'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>Display</button>
                            </div>
                            <div className="flex gap-1 sm:gap-2 flex-shrink-0">
                                <button onClick={() => setShowScanner(true)} className="p-2 text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-full flex-shrink-0 transition-colors"><Icons.Scan size={20} className="sm:w-6 sm:h-6"/></button>
                                <button onClick={() => setShowSettings(true)} className="p-2 text-slate-500 hover:bg-slate-100 rounded-full flex-shrink-0"><Icons.Settings size={20} className="sm:w-6 sm:h-6"/></button>
                                <button onClick={openKioskLink} className="flex items-center gap-2 bg-indigo-600 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-md"><Icons.Link size={16}/> <span className="hidden sm:inline">Kiosk Link</span></button>
                            </div>
                        </div>
                    </div>

                    <main className="max-w-7xl mx-auto p-4 md:p-6 w-full">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-2 space-y-6">
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                                        <h2 className="font-bold text-slate-800 flex items-center gap-2"><Icons.Monitor className="text-indigo-600"/> Calling</h2>
                                        
                                        {/* Auto Recall Status Indicator */}
                                        {autoRecallState.active && (
                                            <div className="w-full sm:w-auto flex items-center justify-center gap-2 bg-indigo-50 px-3 py-1.5 rounded-full border border-indigo-100 animate-pulse mt-2 sm:mt-0">
                                                <div className="w-2 h-2 bg-indigo-500 rounded-full"></div>
                                                <span className="text-xs font-bold text-indigo-700 whitespace-nowrap">กำลังเรียกอัตโนมัติ {autoRecallState.current}/{autoRecallState.total}</span>
                                                <button onClick={stopAutoRecall} className="ml-2 bg-white text-slate-400 hover:text-red-500 rounded-full p-0.5"><Icons.Cross size={14}/></button>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {currentServing ? (
                                        <div className="flex flex-col md:flex-row items-center justify-between gap-6 bg-indigo-50 rounded-xl p-6 border border-indigo-100">
                                            <div className="text-center md:text-left flex-shrink-0">
                                                <div className="text-xs font-bold text-indigo-400 uppercase">Serving Now</div>
                                                <div className="text-5xl font-black text-slate-800 mt-1 mb-2 whitespace-nowrap">{currentServing.number}</div>
                                                <div className="text-xl font-medium text-slate-600 whitespace-nowrap">คุณ {currentServing.name}</div>
                                            </div>
                                            <div className="flex flex-col gap-2 w-full md:w-auto md:ml-auto">
                                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                                    <div className="flex gap-1">
                                                        <button onClick={() => handleRecall(currentServing.id)} className="flex-1 flex items-center justify-center gap-1 bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-3 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all whitespace-nowrap"><Icons.Volume size={18}/> เรียก</button>
                                                        <button onClick={() => setShowAutoRecallModal(true)} className="flex items-center justify-center bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-2 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all" title="เรียกซ้ำอัตโนมัติ"><Icons.Repeat size={18}/></button>
                                                    </div>
                                                    <button onClick={(e) => { e.preventDefault(); openSkipPopup(currentServing); }} className="flex items-center justify-center gap-1 bg-amber-100 text-amber-700 hover:bg-amber-200 px-3 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all whitespace-nowrap"><Icons.Skip size={18}/> ข้าม</button>
                                                    <button onClick={() => updateStatus(currentServing.id, 'cancelled')} className="flex items-center justify-center gap-1 bg-white border border-red-200 text-red-500 hover:bg-red-50 px-3 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all whitespace-nowrap"><Icons.Cross size={18}/> ยกเลิก</button>
                                                </div>
                                                <button onClick={() => updateStatus(currentServing.id, 'completed')} className="w-full flex items-center justify-center gap-2 bg-green-500 text-white px-4 py-2 rounded-xl font-bold text-lg shadow-lg shadow-green-200 hover:bg-green-600 active:scale-95 transition-all"><Icons.Check/> เสร็จสิ้น</button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="border-2 border-dashed border-slate-200 rounded-xl p-10 text-center text-slate-400">ยังไม่มีการเรียกคิว</div>
                                    )}
                                </div>

                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                    <div className="p-6 border-b border-slate-100 h-16 flex justify-between items-center"><h2 className="font-bold text-slate-800 flex items-center gap-2"><Icons.Users className="text-indigo-600"/> Waiting ({waitingQueues.length})</h2></div>
                                    <div className="divide-y divide-slate-50">
                                        {waitingQueues.length > 0 ? waitingQueues.map((q) => (
                                            <div key={q.id} className="p-4 flex flex-col sm:flex-row items-center justify-between hover:bg-slate-50 gap-4">
                                                <div className="flex items-center gap-4 w-full sm:w-auto">
                                                    <div className="w-14 h-14 bg-slate-100 rounded-lg flex-shrink-0 flex items-center justify-center font-bold text-xl text-slate-600">{q.number}</div>
                                                    <div>
                                                        <div className="font-bold text-slate-800 text-lg">{q.name}</div>
                                                        <div className="text-xs text-slate-400 flex gap-2">
                                                            <span>{q.timestamp}</span>
                                                            {q.note && <span className="text-red-500 font-bold bg-red-50 px-1 rounded">({q.note})</span>}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2 w-full sm:w-auto mt-2 sm:mt-0">
                                                    <button onClick={() => updateStatus(q.id, 'serving')} disabled={!!currentServing} className={`flex-1 sm:flex-none flex items-center justify-center gap-2 px-6 py-2 rounded-lg font-bold text-sm shadow-sm ${currentServing ? 'bg-slate-100 text-slate-400' : 'bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95'}`}>
                                                        <Icons.Bell size={18}/> เรียกคิว
                                                    </button>
                                                </div>
                                            </div>
                                        )) : <div className="p-10 text-center text-slate-400">ไม่มีคิวรอเรียก</div>}
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 sticky top-24">
                                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wide mb-4">ภาพรวมวันนี้ (กดเพื่อดูประวัติ)</h3>
                                    <div className="space-y-3">
                                        <button onClick={() => setShowHistory('all')} className="w-full flex justify-between items-center p-4 bg-slate-50 hover:bg-slate-100 rounded-xl transition-colors">
                                            <span className="text-slate-600 font-medium">ทั้งหมด</span>
                                            <span className="text-2xl font-black text-slate-800">{queues.length}</span>
                                        </button>
                                        <button onClick={() => setShowHistory('completed')} className="w-full flex justify-between items-center p-4 bg-green-50 hover:bg-green-100 rounded-xl transition-colors text-green-700"><span className="font-medium flex items-center gap-2"><Icons.History size={16}/> เสร็จสิ้น</span><span className="text-2xl font-black">{queues.filter(q => q.status==='completed').length}</span></button>
                                        <button onClick={() => setShowHistory('cancelled')} className="w-full flex justify-between items-center p-4 bg-red-50 hover:bg-red-100 rounded-xl transition-colors text-red-700"><span className="font-medium flex items-center gap-2"><Icons.History size={16}/> ยกเลิก</span><span className="text-2xl font-black">{queues.filter(q => q.status==='cancelled').length}</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>

                    {showScanner && (
                        <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-[70]">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl animate-fade-in relative">
                                <button onClick={() => setShowScanner(false)} className="absolute top-2 right-2 text-slate-400 hover:text-slate-600"><Icons.Cross size={24}/></button>
                                <h2 className="font-bold text-xl mb-4 text-center">สแกน QR Code</h2>
                                <div id="reader" className="w-full bg-slate-100 rounded-lg overflow-hidden min-h-[300px]"></div>
                                <p className="text-xs text-center text-slate-400 mt-2">วาง QR Code ให้อยู่ในกรอบ</p>
                            </div>
                        </div>
                    )}

                    {showScannedAction && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[80]">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in text-center">
                                <h2 className="font-bold text-2xl mb-1 text-indigo-600">{showScannedAction.queue.number}</h2>
                                <p className="text-slate-500 mb-6 font-medium">คุณ {showScannedAction.queue.name}</p>
                                
                                <div className="grid grid-cols-2 gap-3">
                                    {showScannedAction.queue.status === 'waiting' && (
                                        <>
                                            <button onClick={() => updateStatus(showScannedAction.queue.id, 'serving')} className="col-span-2 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">เรียกคิว</button>
                                            <button onClick={() => openSkipPopup(showScannedAction.queue)} className="py-3 bg-amber-100 text-amber-700 rounded-xl font-bold hover:bg-amber-200">ข้าม</button>
                                            <button onClick={() => updateStatus(showScannedAction.queue.id, 'cancelled')} className="py-3 bg-red-50 text-red-600 rounded-xl font-bold hover:bg-red-100">ยกเลิก</button>
                                        </>
                                    )}
                                    {showScannedAction.queue.status === 'serving' && (
                                        <>
                                            <button onClick={() => updateStatus(showScannedAction.queue.id, 'completed')} className="col-span-2 py-3 bg-green-500 text-white rounded-xl font-bold hover:bg-green-600">เสร็จสิ้น</button>
                                            <button onClick={() => handleRecall(showScannedAction.queue.id)} className="py-3 bg-indigo-100 text-indigo-700 rounded-xl font-bold hover:bg-indigo-200">เรียกซ้ำ</button>
                                            <button onClick={() => openSkipPopup(showScannedAction.queue)} className="py-3 bg-amber-100 text-amber-700 rounded-xl font-bold hover:bg-amber-200">ข้าม</button>
                                        </>
                                    )}
                                    {(showScannedAction.queue.status === 'completed' || showScannedAction.queue.status === 'cancelled') && (
                                        <button onClick={() => handleRecall(showScannedAction.queue.id)} className="col-span-2 py-3 bg-indigo-100 text-indigo-700 rounded-xl font-bold hover:bg-indigo-200">เรียกคิวอีกครั้ง</button>
                                    )}
                                </div>
                                <button onClick={() => setShowScannedAction(null)} className="mt-4 text-slate-400 text-sm underline">ปิดหน้าต่าง</button>
                            </div>
                        </div>
                    )}

                    {showSkipPopup && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in">
                                <h2 className="font-bold text-xl mb-4 text-amber-600 flex items-center gap-2"><Icons.Skip size={24}/> ข้ามคิว {queueToSkip?.number}</h2>
                                <label className="block text-sm font-medium text-slate-700 mb-2">ระบุหมายเหตุการข้าม</label>
                                <input 
                                    ref={skipInputRef}
                                    type="text" 
                                    value={skipNote} 
                                    onChange={e => setSkipNote(e.target.value)} 
                                    onKeyDown={e => { if (e.key === 'Enter') handleConfirmSkip(); }}
                                    className="w-full border border-slate-200 rounded-xl px-4 py-3 text-lg outline-none focus:ring-2 focus:ring-amber-500 transition-all mb-4" 
                                    placeholder="เช่น ไม่พร้อม, เข้าห้องน้ำ" 
                                />
                                
                                {savedNotes.length > 0 && (
                                    <div className="mb-4">
                                        <div className="text-xs text-slate-400 mb-2">เลือกข้อความเดิม:</div>
                                        <div className="flex flex-wrap gap-2">
                                            {savedNotes.map((note, idx) => (
                                                <button key={idx} onClick={() => setSkipNote(note)} className="text-xs bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded-md text-slate-600 transition-colors">
                                                    {note}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                <div className="flex gap-2">
                                    <button onClick={() => setShowSkipPopup(false)} className="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-xl">ยกเลิก</button>
                                    <button onClick={handleConfirmSkip} className="flex-1 py-2 bg-amber-500 text-white rounded-xl font-bold hover:bg-amber-600">ยืนยันข้าม</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showSettings && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in">
                                <h2 className="font-bold text-xl mb-4">ตั้งค่าระบบ</h2>
                                <label className="block text-sm font-medium text-slate-700 mb-2">ตัวอักษรนำหน้าคิว (Prefix)</label>
                                <input type="text" value={queuePrefix} onChange={e => setQueuePrefix(e.target.value.toUpperCase())} className="w-full border border-slate-200 rounded-xl px-4 py-2 mb-4 text-center text-2xl font-bold uppercase" maxLength={2} />
                                
                                <div className="flex items-center justify-between mb-6 p-3 bg-slate-50 rounded-xl">
                                    <span className="text-sm font-medium text-slate-700 flex items-center gap-2"><Icons.QrCode size={18}/> ระบบ QR Code</span>
                                    <button 
                                        onClick={() => setQrEnabled(!qrEnabled)} 
                                        className={`w-12 h-6 rounded-full transition-colors relative ${qrEnabled ? 'bg-indigo-600' : 'bg-slate-300'}`}
                                    >
                                        <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${qrEnabled ? 'left-7' : 'left-1'}`}></div>
                                    </button>
                                </div>

                                <div className="flex gap-2">
                                    <button onClick={() => setShowSettings(false)} className="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-xl">ยกเลิก</button>
                                    <button onClick={handleSaveSettings} className="flex-1 py-2 bg-indigo-600 text-white rounded-xl font-bold">บันทึก</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showHistory && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl animate-fade-in h-[80vh] flex flex-col">
                                <div className="p-6 border-b border-slate-100 flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <h2 className="font-bold text-xl flex items-center gap-2">
                                            <Icons.History/> 
                                            {showHistory === 'all' ? 'ประวัติทั้งหมด' : (showHistory === 'completed' ? 'รายการเสร็จสิ้น' : 'รายการยกเลิก')}
                                        </h2>
                                        {showHistory === 'all' && (
                                            <button onClick={() => setShowClearPopup(true)} className="text-xs text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 border border-red-200 px-3 py-1.5 rounded-lg flex items-center gap-1 transition-colors">
                                                <Icons.Trash size={12}/> ล้างข้อมูล
                                            </button>
                                        )}
                                    </div>
                                    <button onClick={() => setShowHistory(null)} className="p-2 hover:bg-slate-100 rounded-full transition-colors"><Icons.Cross/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                    {historyList.length > 0 ? historyList.map(q => (
                                        <div key={q.id} className="flex justify-between items-center p-4 bg-slate-50 rounded-xl">
                                            <div>
                                                <div className="font-bold text-slate-700 flex items-center gap-2">
                                                    {q.number} - {q.name}
                                                    <button onClick={() => setShowEditPopup({ queue: q })} className="text-slate-400 hover:text-indigo-600"><Icons.Edit size={16}/></button>
                                                </div>
                                                <div className="text-xs text-slate-400">
                                                    {q.timestamp} • <span className={`uppercase font-bold ${q.status==='completed'?'text-green-500':(q.status==='cancelled'?'text-red-500':'text-amber-500')}`}>{q.status}</span>
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => handleRecall(q.id)} className="text-sm bg-white border border-slate-200 px-3 py-1 rounded-lg hover:bg-indigo-50 hover:text-indigo-600 shadow-sm">เรียกซ้ำ</button>
                                                <button onClick={() => setShowConfirmPopup({ id: q.id, type: 'delete' })} className="text-sm bg-white border border-red-200 text-red-400 px-2 py-1 rounded-lg hover:bg-red-50 hover:text-red-600 shadow-sm"><Icons.Trash size={16}/></button>
                                            </div>
                                        </div>
                                    )) : <div className="text-center text-slate-400 mt-10">ไม่มีข้อมูล</div>}
                                </div>
                            </div>
                        </div>
                    )}

                    {showClearPopup && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[60]">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in border-t-4 border-red-500">
                                <h2 className="font-bold text-xl mb-4 text-red-600 flex items-center gap-2"><Icons.Trash size={24}/> ยืนยันการล้างคิว</h2>
                                <p className="text-sm text-slate-600 mb-4">การกระทำนี้ไม่สามารถกู้คืนได้ กรุณาใส่รหัสผ่านเพื่อยืนยัน</p>
                                <label className="block text-sm font-medium text-slate-700 mb-2">รหัสผ่าน Admin</label>
                                <input 
                                    ref={clearInputRef}
                                    type="password" 
                                    value={clearPassword} 
                                    onChange={e => setClearPassword(e.target.value)} 
                                    onKeyDown={e => { if (e.key === 'Enter') handleClearQueuesSubmit(); }}
                                    className="w-full border border-slate-200 rounded-xl px-4 py-3 text-lg outline-none focus:ring-2 focus:ring-red-500 transition-all mb-4 text-center" 
                                    placeholder="ใส่รหัสผ่าน" 
                                />
                                <div className="flex gap-2">
                                    <button onClick={() => setShowClearPopup(false)} className="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-xl">ยกเลิก</button>
                                    <button onClick={handleClearQueuesSubmit} className="flex-1 py-2 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700">ลบทั้งหมด</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showConfirmPopup && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[60]">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in">
                                <h2 className="font-bold text-xl mb-4 text-slate-800">ยืนยันการลบ</h2>
                                <p className="text-slate-600 mb-6">ต้องการลบรายการนี้ใช่หรือไม่?</p>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowConfirmPopup(null)} className="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-xl">ยกเลิก</button>
                                    <button onClick={handleDeleteConfirm} className="flex-1 py-2 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700">ลบ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showEditPopup && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[60]">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in">
                                <h2 className="font-bold text-xl mb-4 text-indigo-800 flex items-center gap-2"><Icons.Edit size={24}/> แก้ไขชื่อ</h2>
                                <input 
                                    ref={editInputRef}
                                    type="text" 
                                    value={editName} 
                                    onChange={e => setEditName(e.target.value)} 
                                    onKeyDown={e => { if (e.key === 'Enter') handleEditSubmit(); }}
                                    className="w-full border border-slate-200 rounded-xl px-4 py-3 text-lg outline-none focus:ring-2 focus:ring-indigo-500 transition-all mb-4" 
                                    placeholder="ชื่อใหม่" 
                                />
                                <div className="flex gap-2">
                                    <button onClick={() => setShowEditPopup(null)} className="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-xl">ยกเลิก</button>
                                    <button onClick={handleEditSubmit} className="flex-1 py-2 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">บันทึก</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
