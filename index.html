<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Queue System</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <!-- HTML5-QRCode Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Sarabun', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f8fafc; 
        }
        
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        .animate-bounce-slow { animation: bounce 2s infinite; }
        .animate-pop-in { animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop-in { from { opacity: 0; transform: scale(0.9) translate(-50%, -50%); } to { opacity: 1; transform: scale(1) translate(-50%, -50%); } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Custom Scrollbar for Settings */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

        /* Toggle Switch Animation */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4F46E5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4F46E5;
        }
        /* Custom class for current serving name: Ensure single line (no-wrap) */
        .display-name-nowrap {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="text-slate-900 min-h-screen w-screen">
    <div id="root" class="w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // ==========================================
        // 1. ตั้งค่า FIREBASE Config
        // ==========================================
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBsN1ACDYvJzoVc6mhtu9n-HNi1KDNFV24",
            authDomain: "project-6337867036145290950.firebaseapp.com",
            projectId: "project-6337867036145290950",
            storageBucket: "project-6337867036145290950.firebasestorage.app",
            messagingSenderId: "298203222498",
            appId: "1:298203222498:web:b3ef416666666c748ba9bb",
            measurementId: "G-1LJY6YJQBZ"
        };

        const initFirebase = () => {
            let config;
            if (YOUR_FIREBASE_CONFIG.apiKey === "วาง_API_KEY_ที่นี่" || YOUR_FIREBASE_CONFIG.apiKey === "") {
                 if (typeof __firebase_config !== 'undefined') {
                    config = JSON.parse(__firebase_config);
                 } else {
                    throw new Error("PLEASE_SETUP_FIREBASE");
                 }
            } else {
                config = YOUR_FIREBASE_CONFIG;
            }

            if (!firebase.apps.length) {
                try {
                    firebase.initializeApp(config);
                } catch (e) {
                    console.error("Firebase init failed", e);
                    throw e;
                }
            }
            return {
                auth: firebase.auth(),
                db: firebase.firestore()
            };
        };

        const Icon = ({ d, size=24, className="" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d}/></svg>
        );
        
        const Icons = {
            User: (p) => <Icon d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2 M12 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8" {...p} />,
            // แก้ไข Icons.Monitor เพื่อให้ใส่ overflow-visible ได้
            Monitor: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`${p.className} ${p.overflowVisible ? 'overflow-visible' : ''}`}><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>,
            Bell: (p) => <Icon d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9 M10.3 21a1.94 1.94 0 0 0 3.4 0" {...p} />,
            // FIXED: แก้ไข SyntaxError: Unterminated string constant.
            Check: (p) => <Icon d="M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4 12 14.01l-3-3" {...p} />,
            Clock: (p) => <Icon d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20 M12 6v6l4 2" {...p} />,
            Users: (p) => <Icon d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8 M22 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75" {...p} />,
            Cross: (p) => <Icon d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20 M15 9l-6 6 M9 9l6 6" {...p} />,
            Volume: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>,
            Link: (p) => <Icon d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6 M15 3h6v6 M10 14L21 3" {...p} />,
            Alert: (p) => <Icon d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z M12 9v4 M12 17h.01" {...p} />,
            Loader: (p) => <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width={24} height={24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56" /></svg>,
            Settings: (p) => (
                <img src="https://img2.pic.in.th/pic/settings3209826b30ab5f22.png" width={p.size||24} height={p.size||24} className={`object-contain ${p.className||''}`} alt="Settings" />
            ),
            Trash: (p) => <Icon d="M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" {...p} />,
            History: (p) => <Icon d="M3 3v5h5 M3.05 13A9 9 0 1 0 6 5.3L3 8" {...p} />,
            Skip: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><polygon points="5 4 15 12 5 20 5 4" /><line x1="19" x2="19" y1="5" y2="19" /></svg>,
            Edit: (p) => <Icon d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7 M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" {...p} />,
            Lock: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            QrCode: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
            Scan: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/></svg>,
            Speaker: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><rect x="4" y="9" width="6" height="6" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" /><path d="M11 5L6 9H2v6h4l5 4V5z" /></svg>,
            Repeat: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>,
            Power: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><path d="M18.36 6.64a9 9 0 1 1-12.73 0" /><line x1="12" y1="2" x2="12" y2="12" /></svg>,
            Folder: (p) => <Icon d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" {...p} />,
            Search: (p) => <Icon d="M11 11a8 8 0 1 0 0 16 8 8 0 0 0 0-16 M21 21l-4.35-4.35" {...p} />,
            Sheet: (p) => <Icon d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z M14 2v6h6 M16 13H8 M16 17H8 M10 9H8" {...p} />,
            Sync: (p) => <Icon d="M21.5 2v6h-6 M21.34 5.5A10 10 0 1 0 22 12 M2.5 22v-6h6 M2.66 18.5A10 10 0 1 0 2 12" {...p} />,
            GoogleScript: (p) => <Icon d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71 M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" {...p} />,
            Link2: (p) => <Icon d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71 M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" {...p} />,
            Time: (p) => <Icon d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20 M12 6v6l4 2 M6 3h12" {...p} /> // New Time/ETA icon
        };

        // --- UI Components ---
        const ToggleSwitch = ({ checked, onChange }) => (
            <button onClick={onChange} className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-300 focus:outline-none ${checked ? 'bg-green-500' : 'bg-slate-200'}`}><span className={`inline-block h-4 w-4 transform rounded-full bg-white shadow-sm transition-transform duration-300 ${checked ? 'translate-x-6' : 'translate-x-1'}`} /></button>
        );

        // --- Audio Singleton to ensure persistent audio context ---
        let globalAudioContext = null;

        const initGlobalAudio = () => {
            if (!globalAudioContext) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    globalAudioContext = new AudioContext();
                }
            }
            if (globalAudioContext && globalAudioContext.state === 'suspended') {
                globalAudioContext.resume();
            }
        };

        const playBeepSound = () => {
            if ("vibrate" in navigator) { try { navigator.vibrate([200, 100, 200]); } catch(e){} }
            
            initGlobalAudio(); 
            
            if (!globalAudioContext) return;

            const ctx = globalAudioContext;
            const beep = (startTime, freq) => {
                const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(freq, startTime);
                gain.gain.setValueAtTime(0.1, startTime);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.1);
                osc.start(startTime); osc.stop(startTime + 0.1);
            };
            
            const now = ctx.currentTime;
            beep(now, 800); beep(now + 0.15, 800); beep(now + 0.3, 1000);
        };

        const announceQueue = (queueNumber, customerName, mode = 'display') => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const parts = queueNumber.split('-');
                let numberText = "";
                if (parts[0]) {
                    if (parts[0] === 'A') numberText += "เอ ";
                    else if (parts[0] === 'B') numberText += "บี ";
                    else numberText += parts[0] + " ";
                }
                if (parts[1]) {
                    for (let char of parts[1]) {
                        if (char === '0') numberText += "ศูนย์ ";
                        else if (char === '1') numberText += "หนึ่ง ";
                        else if (char === '2') numberText += "สอง ";
                        else if (char === '3') numberText += "สาม ";
                        else if (char === '4') numberText += "สี่ ";
                        else if (char === '5') numberText += "ห้า ";
                        else if (char === '6') numberText += "หก ";
                        else if (char === '7') numberText += "เจ็ด ";
                        else if (char === '8') numberText += "แปด ";
                        else if (char === '9') numberText += "เก้า ";
                    }
                }
                let spokenText = "";
                if (mode === 'display') {
                    spokenText = "ขอเชิญหมายเลข " + numberText;
                    if (customerName) spokenText += " คุณ" + customerName;
                    spokenText += " เข้ารับบริการ"; 
                } else {
                    spokenText = "คิว " + numberText;
                    spokenText += " ถึงคิวของคุณแล้ว";
                }
                const utterance = new SpeechSynthesisUtterance(spokenText);
                utterance.lang = 'th-TH'; utterance.rate = 0.85; utterance.volume = 1;
                window.speechSynthesis.speak(utterance);
            }
        };

        const SetupError = ({ errorMsg }) => (
            <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                <div className="bg-white max-w-lg w-full rounded-2xl shadow-xl p-8 text-center border-t-4 border-red-500">
                    <div className="flex justify-center mb-4 text-red-500"><Icons.Alert size={64}/></div>
                    <h1 className="text-2xl font-bold text-slate-800 mb-2">เกิดข้อผิดพลาดในการเชื่อมต่อ</h1>
                    <p className="text-slate-600 mb-6 font-mono text-sm bg-slate-100 p-2 rounded break-all">{errorMsg}</p>
                    <a href="https://console.firebase.google.com/" target="_blank" className="inline-block bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-colors">ไปที่ Firebase Console</a>
                </div>
            </div>
        );

        const useWakeLock = () => {
            const wakeLockRef = useRef(null);
            const requestWakeLock = async () => {
                if ('wakeLock' in navigator) { try { wakeLockRef.current = await navigator.wakeLock.request('screen'); } catch (err) { console.error(err); } }
            };
            const releaseWakeLock = async () => {
                if (wakeLockRef.current) { await wakeLockRef.current.release(); wakeLockRef.current = null; }
            };
            useEffect(() => {
                const handleVisibilityChange = () => { if (wakeLockRef.current !== null && document.visibilityState === 'visible') requestWakeLock(); };
                document.addEventListener('visibilitychange', handleVisibilityChange);
                return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
            }, []);
            return { requestWakeLock, releaseWakeLock };
        };
        
        // --- Admin Login Component (Updated with Duration) ---
        const AdminLogin = ({ onLogin, durationMinutes }) => {
            const [pass, setPass] = useState('');
            const [err, setErr] = useState('');
            
            const ADMIN_EXPIRY_KEY = 'admin_session_expiry';

            const handleSubmit = (e) => {
                e.preventDefault();
                if (pass === 'Admin123') {
                    // Calculate expiry time and store it locally
                    const expiry = Date.now() + durationMinutes * 60 * 1000;
                    localStorage.setItem(ADMIN_EXPIRY_KEY, expiry.toString());
                    onLogin(); 
                } else {
                    setErr('รหัสผ่านไม่ถูกต้อง');
                }
            };
            
            return (
                <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
                        <div className="flex justify-center mb-6 text-indigo-600"><Icons.Lock size={48}/></div>
                        <h2 className="text-2xl font-bold text-center mb-6 text-slate-800">เข้าสู่ระบบ Admin</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <input type="password" value={pass} onChange={e => {setPass(e.target.value); setErr('');}} className="w-full border border-slate-200 rounded-xl px-4 py-3 text-center text-lg outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ใส่รหัสผ่าน" autoFocus />
                                {err && <div className="text-red-500 text-sm text-center mt-2">{err}</div>}
                            </div>
                            <button type="submit" className="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition-colors">เข้าสู่ระบบ</button>
                            <p className="text-center text-xs text-slate-400">เซสชันจะหมดอายุใน {durationMinutes} นาที</p>
                        </form>
                    </div>
                </div>
            );
        };
        // --- End Admin Login Component ---

        const Toast = ({ message, type, show }) => {
            if (!show) return null;
            return (
                <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[100] animate-pop-in">
                    <div className={`px-8 py-5 rounded-2xl shadow-2xl font-bold text-white text-xl flex flex-col items-center gap-3 min-w-[240px] text-center backdrop-blur-md border border-white/20 ${type === 'error' ? 'bg-slate-800/90 text-red-400' : 'bg-slate-800/90 text-green-400'}`}>
                        <div className={`p-4 rounded-full ${type === 'error' ? 'bg-red-500/20' : 'bg-green-500/20'} mb-1`}>
                            {type === 'error' ? <Icons.Alert size={40}/> : <Icons.Check size={40}/>}
                        </div>
                        <span className="text-white">{message}</span>
                    </div>
                </div>
            );
        };
        
        /**
         * Converts total seconds into "MM:SS" format.
         * @param {number} seconds - Total seconds remaining.
         * @returns {string} Formatted time string.
         */
        const formatSecondsToMinutes = (seconds) => {
            const totalSeconds = Math.max(0, Math.floor(seconds));
            const min = Math.floor(totalSeconds / 60);
            const sec = totalSeconds % 60;
            return `${String(min).padStart(2, '0')} นาที ${String(sec).padStart(2, '0')} วินาที`;
        };

        /**
         * Estimates the remaining time for a waiting queue based on past service history.
         * @param {Array<Object>} queues - All queue objects.
         * @param {string|null} myQueueId - The ID of the current user's queue (for Kiosk Mode).
         * @param {Object} config - AI time configuration {enabled, limit}.
         * @returns {number|null} Estimated time remaining in seconds, or null if calculation is not possible.
         */
        const getEstimatedTime = (queues, myQueueId, config) => {
            if (!config.enabled) return null;
            
            // 1. Filter and sort queues that have completed service time metrics
            const completedQueues = queues
                .filter(q => q.status === 'completed' && q.calledAt && q.completedAt)
                .sort((a, b) => b.completedAt - a.completedAt); // Sort by most recently completed

            // 2. Calculate average service time (in milliseconds)
            let totalServiceTime = 0;
            const limit = config.limit || 5;
            const queuesToAverage = completedQueues.slice(0, limit);

            if (queuesToAverage.length < 3) {
                // Not enough history for a reliable estimate
                return null;
            }

            queuesToAverage.forEach(q => {
                const serviceDuration = q.completedAt - q.calledAt;
                totalServiceTime += serviceDuration;
            });

            // Ensure the average is at least 30 seconds (30000ms) to prevent overly aggressive estimates
            const averageServiceTimeMs = Math.max(30000, totalServiceTime / queuesToAverage.length); // in ms

            // 3. Determine how many people are ahead of the current waiting queue
            const currentServing = queues.find(q => q.status === 'serving');
            
            let targetQueue;
            if (myQueueId) {
                // Kiosk Mode: Find my queue and count those ahead of it
                targetQueue = queues.find(q => q.id === myQueueId && q.status === 'waiting');
            } else {
                // Display Mode: Target the first waiting queue
                targetQueue = queues.find(q => q.status === 'waiting');
            }
            
            if (!targetQueue) {
                return null; // No one waiting or my queue is already serving/completed
            }
            
            // Count people *waiting* ahead of the target queue
            const queuesAhead = queues.filter(q => 
                q.status === 'waiting' && q.createdAt < targetQueue.createdAt
            ).length;
            
            // Add 1 more if someone is currently being served
            const currentServingFactor = currentServing ? 1 : 0;
            
            const totalPeopleAhead = queuesAhead + currentServingFactor;

            if (totalPeopleAhead === 0) {
                // If there is no one ahead, estimate 1 average service time (or 1 minute minimum)
                return Math.max(60, Math.ceil(averageServiceTimeMs / 1000));
            }
            
            // 4. Calculate estimated time remaining
            const estimatedTotalMs = totalPeopleAhead * averageServiceTimeMs;
            
            return Math.ceil(estimatedTotalMs / 1000); // return in seconds
        };


        function App() {
            const ADMIN_EXPIRY_KEY = 'admin_session_expiry';
            const ADMIN_DURATION_KEY = 'admin_session_duration';

            const [viewMode, setViewMode] = useState('admin');
            const [queues, setQueues] = useState([]);
            const [myQueueId, setMyQueueId] = useState(() => localStorage.getItem('my_queue_id'));
            const [customerName, setCustomerName] = useState('');
            const [loading, setLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [services, setServices] = useState(null);
            const [user, setUser] = useState(null); 
            const [configError, setConfigError] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            const [audioEnabled, setAudioEnabled] = useState(false);
            
            const initialAdminAuth = () => {
                const storedExpiry = localStorage.getItem(ADMIN_EXPIRY_KEY);
                return storedExpiry && Date.now() < parseInt(storedExpiry);
            };
            const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(initialAdminAuth);
            
            // Settings State
            const [queuePrefix, setQueuePrefix] = useState('A'); 
            const [qrEnabled, setQrEnabled] = useState(false); 
            const [serviceOpen, setServiceOpen] = useState(true);
            const [closedReason, setClosedReason] = useState('');
            const [historyEnabled, setHistoryEnabled] = useState(false); 
            const [externalLinkEnabled, setExternalLinkEnabled] = useState(false); 
            const [externalLinkMapping, setExternalLinkMapping] = useState(''); 
            const [externalLinkLabel, setExternalLinkLabel] = useState('เปิดเอกสาร / โฟลเดอร์คิว'); 
            const [gasWebAppUrl, setGasWebAppUrl] = useState('https://script.google.com/macros/s/AKfycbyHQ4b_69fLsfIV2rh8EMIkE3s3KlZVTz6im2btIAsvVAQJWJ5N6OrjO6sfLtNtSjykaQ/exec'); 
            const [masterLinkC1, setMasterLinkC1] = useState(''); 
            const [masterLinkTitle, setMasterLinkTitle] = useState(''); 
            const [lastGasSyncTime, setLastGasSyncTime] = useState(null); 
            const [lastSentLink, setLastSentLink] = useState(''); 
            
            const [adminSessionDuration, setAdminSessionDuration] = useState(() => parseInt(localStorage.getItem(ADMIN_DURATION_KEY) || 60)); 
            
            // --- NEW: AI Time Estimation States ---
            const [aiQueueTimeEnabled, setAiQueueTimeEnabled] = useState(false);
            const [aiQueueTimeHistoryLimit, setAiQueueTimeHistoryLimit] = useState(5); // Use last 5 completed queues
            const [estimatedTimeSeconds, setEstimatedTimeSeconds] = useState(null); // Estimated time in seconds
            // ---------------------------------------
            
            const [useGasForLink, setUseGasForLink] = useState(true); 
            const [testQueueId, setTestQueueId] = useState(''); 
            
            const [showSettings, setShowSettings] = useState(false);
            const [showHistory, setShowHistory] = useState(null); 
            const [showMyHistory, setShowMyHistory] = useState(false); 
            const [selectedHistoryItem, setSelectedHistoryItem] = useState(null); 
            
            // Popups & Toast State
            const [showSkipPopup, setShowSkipPopup] = useState(false);
            const [showClearPopup, setShowClearPopup] = useState(false);
            const [showConfirmPopup, setShowConfirmPopup] = useState(null); 
            const [showEditPopup, setShowEditPopup] = useState(null); 
            const [showScanner, setShowScanner] = useState(false); 
            const [showScannedAction, setShowScannedAction] = useState(null); 
            const [showRecallWait, setShowRecallWait] = useState(false); 
            const [recallCountdown, setRecallCountdown] = useState(0);
            const [showLinkDataModal, setShowLinkDataModal] = useState(false); 
            
            // Service Close Reason Modal
            const [showCloseReasonModal, setShowCloseReasonModal] = useState(false);
            const [tempClosedReason, setTempClosedReason] = useState('');

            // Auto Recall States
            const [showAutoRecallModal, setShowAutoRecallModal] = useState(false);
            const [autoRecallConfig, setAutoRecallConfig] = useState({ count: 3, interval: 10 });
            const [autoRecallState, setAutoRecallState] = useState({ active: false, current: 0, total: 0, timer: null });
            
            // New State for QR Modal
            const [showMyQR, setShowMyQR] = useState(false);
            
            const [skipNote, setSkipNote] = useState('');
            const [clearPassword, setClearPassword] = useState('');
            const [editName, setEditName] = useState('');
            const [queueToSkip, setQueueToSkip] = useState(null);
            const [savedNotes, setSavedNotes] = useState([]);
            
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
            
            // NEW: State for Send Link Status
            const [isGasSending, setIsGasSending] = useState(false);
            const [sendSuccess, setSendSuccess] = useState(false);
            
            // NEW: State for temporary editing closed reason (Manual Save/Enter key)
            const [tempEditClosedReason, setTempEditClosedReason] = useState('');

            // QR Code Dynamic Token States (NEW)
            const [qrToken, setQrToken] = useState(() => localStorage.getItem('qr_token') || crypto.randomUUID());
            const [qrExpireEnabled, setQrExpireEnabled] = useState(false);
            const [qrExpireTime, setQrExpireTime] = useState(5); // Minutes
            const [qrTokenExpiry, setQrTokenExpiry] = useState(null);
            const [qrCountdown, setQrCountdown] = useState(0);

            const skipInputRef = useRef(null);
            const clearInputRef = useRef(null);
            const editInputRef = useRef(null);
            const scannerRef = useRef(null);
            const closeReasonInputRef = useRef(null);

            const lastAnnouncedMyQueueRef = useRef(null);
            const lastAnnouncedDisplayRef = useRef(null);
            const { requestWakeLock } = useWakeLock();
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-queue-app';

            const showToastFn = (message, type = 'success') => {
                setToast({ show: true, message, type });
                setTimeout(() => setToast(prev => ({ ...prev, show: false })), 2000);
            };
            
            // Helper function to generate new token
            const generateUniqueToken = () => {
                return crypto.randomUUID();
            };

            // Helper function to update the QR token and expiry in Firestore
            const updateQrTokenInFirestore = async (newQrToken, expiryMinutes, isManual = false) => {
                if (!services?.db || !user) return;
                
                const now = Date.now();
                const tokenExpiry = expiryMinutes > 0 ? now + (expiryMinutes * 60 * 1000) : null;

                try {
                    let settingsRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('main') : services.db.collection('settings').doc('main');
                    await settingsRef.set({ 
                        qrToken: newQrToken, 
                        qrTokenExpiry: tokenExpiry,
                        qrExpireTime: expiryMinutes, // Save the interval setting
                    }, { merge: true });
                    
                    setQrToken(newQrToken);
                    setQrTokenExpiry(tokenExpiry);
                    localStorage.setItem('qr_token', newQrToken);
                    if(isManual) showToastFn("อัปเดต QR Code ใหม่เรียบร้อย", 'success');

                } catch (err) {
                    console.error("Failed to update QR token:", err);
                    if(isManual) showToastFn("อัปเดต QR Code ไม่สำเร็จ", 'error');
                }
            };

            // Helper function to format timestamp
            const formatTime = (timestamp) => {
                if (!timestamp) return 'ยังไม่เคยดึงข้อมูล';
                return new Date(timestamp).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            };
            
            // NEW: Helper function to format timestamp to date/time string (DD/MM/YY HH:MM)
            const formatDateTime = (timestamp) => {
                if (!timestamp) return 'N/A';
                const date = new Date(timestamp);
                const dateString = date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit' });
                const timeString = date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                return `${dateString} ${timeString}`;
            };

            // Helper function to check if the link is a Google Drive link
            const isGoogleDriveLink = (url) => {
                return url && typeof url === 'string' && url.includes('drive.google.com/drive');
            };

            // Force body scroll settings based on view mode
            useEffect(() => {
                if (viewMode === 'kiosk') {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = 'auto';
                    window.scrollTo(0, 0);
                }
                return () => {
                    document.body.style.overflow = 'auto';
                };
            }, [viewMode]);

            // --- Handle External Link Mapping Logic ---
            const getLinkForQueue = (mappingString, queueNumber) => {
                if (!mappingString) return null;
                
                const lines = mappingString.split(/\r?\n/);
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    let parts;
                    if (line.includes(',')) parts = line.split(',');
                    else if (line.includes('\t')) parts = line.split('\t');
                    else if (line.includes('|')) parts = line.split('|');
                    else parts = line.split(/\s+/); 
                    
                    if (parts.length >= 2) {
                        const key = parts[0].trim();
                        const url = parts.slice(1).join('').trim();
                        
                        if (key.toUpperCase() === queueNumber.toUpperCase()) {
                            return url;
                        }
                    }
                }
                return null;
            };

            const handleOpenExternalLink = (mappingString, queueNumber, isToastRequired = true) => {
                const url = getLinkForQueue(mappingString, queueNumber);
                
                console.log(`[Linker] Attempting to open link for Q: ${queueNumber}`);
                if (url) {
                    let finalUrl = url;
                    if (!url.startsWith('http://') && !url.startsWith('https://')) {
                        finalUrl = 'https://' + url;
                    }
                    console.log(`[Linker] Found URL: ${finalUrl}`);
                    window.open(finalUrl, '_blank');
                    if (isToastRequired) {
                        showToastFn(`เปิดลิ้งค์สำหรับคิว ${queueNumber} แล้ว`, 'success');
                    }
                } else {
                    console.warn(`[Linker] No link found for Q: ${queueNumber}`);
                    if (isToastRequired) {
                        showToastFn(`ไม่พบลิ้งค์สำหรับคิว ${queueNumber} (กรุณาตั้งค่า)`, 'error');
                    }
                }
            };
            
            const testLinkMapping = () => {
                if (!testQueueId) {
                    showToastFn("กรุณาใส่เลขคิวทดสอบ", "error");
                    return;
                }
                const url = getLinkForQueue(externalLinkMapping, testQueueId);
                if (url) {
                    showToastFn(`พบค้นหา: ${url}`, "success");
                    // Optionally open the link on test
                    let finalUrl = url;
                    if (!url.startsWith('http://') && !url.startsWith('https://')) {
                        finalUrl = 'https://' + url;
                    }
                    window.open(finalUrl, '_blank');
                } else {
                    showToastFn(`ไม่พบข้อมูลสำหรับคิว ${testQueueId}`, "error");
                }
            };

            // --- GAS Integration Functions ---

            // Core function to fetch and process GAS data (used by both manual and auto sync)
            const performGasSync = async (isManualSync = false) => {
                if (!gasWebAppUrl || gasWebAppUrl.trim() === '') {
                    if (isManualSync) showToastFn("กรุณาระบุ GAS Web App URL", "error");
                    return;
                }
                
                try {
                    if (isManualSync) showToastFn("กำลังดึงข้อมูลจาก GAS...", "success");

                    // GAS doGet returns JSON: [[A1, B1], [A2, B2], ...]
                    const response = await fetch(gasWebAppUrl);
                    if (!response.ok) throw new Error("ไม่สามารถเชื่อมต่อ GAS ได้");
                    
                    const json = await response.json();
                    
                    // Convert Array to String Format (Key, Link)
                    if (Array.isArray(json)) {
                        const mappingString = json.map(row => {
                             if (Array.isArray(row) && row.length >= 2) {
                                 // Ensure both key and value are strings and join them with a comma
                                 return `${String(row[0]).trim()},${String(row[1]).trim()}`;
                             }
                             return null;
                        }).filter(Boolean).join('\n');

                        const currentTime = Date.now(); // Get current timestamp

                        // Update state
                        setExternalLinkMapping(prev => {
                            if (prev !== mappingString && isManualSync) {
                                // Only show success toast if data actually changed during manual sync
                                console.log("GAS mapping silently updated.");
                                showToastFn("อัปเดตข้อมูลจาก GAS เรียบร้อยแล้ว", "success");
                            }
                            return mappingString;
                        });

                        setLastGasSyncTime(currentTime); // Update sync time
                        
                        // Only save to Firestore if it's a manual sync (to prevent excessive writes)
                        if (isManualSync && user && services) {
                            let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('main') : services.db.collection('settings').doc('main');
                            await docRef.set({ externalLinkMapping: mappingString, lastGasSyncTime: currentTime }, { merge: true });
                        }
                    } else {
                        throw new Error("รูปแบบข้อมูลจาก GAS ไม่ถูกต้อง");
                    }
                    
                } catch (error) {
                    if (isManualSync) {
                        showToastFn("Error: " + error.message, "error");
                    } else {
                        // Suppress console errors for auto-sync unless it's critical
                        // console.error("Silent GAS Sync Error:", error); 
                    }
                }
            };

            // 1. Sync Data from GAS (Read A, B) - Manual Button Click (KEPT FOR CONSISTENCY BUT NOT USED IN NEW UI)
            const handleSyncGAS = () => performGasSync(true);


            // 2. Save Master Link to GAS (Write C1) 
            const handleSaveToGAS = async (link, title) => {
                if (!gasWebAppUrl) {
                    showToastFn("กรุณาระบุ Google Apps Script URL", "error");
                    return false;
                }
                
                setIsGasSending(true);
                setSendSuccess(false);

                try {
                    // Payload now includes the title to send to the script
                    const payload = { link: link, title: title, action: 'write' }; 
                    
                    const response = await fetch(gasWebAppUrl, {
                        method: 'POST',
                        body: JSON.stringify(payload),
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8', 
                        }
                    });

                    const text = await response.text();
                    
                    if (text.includes("Success")) {
                        setSendSuccess(true);
                        setLastSentLink(link); // Save the link that was successfully sent
                        // Save the link and title locally
                        let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('main') : services.db.collection('settings').doc('main');
                        await docRef.set({ masterLinkC1: link, masterLinkTitle: title, lastSentLink: link }, { merge: true }); // Save lastSentLink to Firestore
                        return true;
                    } else {
                        showToastFn("ส่งลิ้งค์ไม่สำเร็จ: " + text, "error");
                        console.error("GAS Write Error:", text);
                        return false;
                    }
                } catch (error) {
                    showToastFn("ส่งลิ้งค์ไม่สำเร็จ: " + error.message, "error");
                    console.error("GAS Write Error:", error);
                    return false;
                } finally {
                    setIsGasSending(false);
                    // REMOVED: Reset success state after a short delay to keep the status persistent
                    // setTimeout(() => setSendSuccess(false), 1500); 
                }
            };

            // --- Handle Audio Enable ---
            const handleEnableAudio = () => {
                initGlobalAudio();
                const silentAudio = "data:audio/mp3;base64,SUQzBAAAAAAAI1RTSVAAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD//////////////////////////////////wAAAAD/84QAAAAAExAAAAAAAAABAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA//OEWoAAAB9AAAACABAAAAAAAAAAAAAA";
                const audio = new Audio(silentAudio);
                
                audio.play().then(() => { 
                    setAudioEnabled(true); 
                    showToastFn("เปิดเสียงเรียบร้อยแล้ว", "success");
                }).catch(e => {
                    console.error("Enable audio failed", e);
                    setAudioEnabled(true); 
                });
            };

            // Cleanup auto recall timer on unmount
            useEffect(() => {
                return () => { if (autoRecallState.timer) clearTimeout(autoRecallState.timer); };
            }, [autoRecallState.timer]);

            // Keyboard Shortcuts
            useEffect(() => {
                if (viewMode !== 'admin' || !isAdminAuthenticated) return;

                const handleKeyDown = (e) => {
                    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) return;
                    if (showSkipPopup || showClearPopup || showConfirmPopup || showEditPopup || showScanner || showScannedAction || showRecallWait || showAutoRecallModal || showCloseReasonModal) return;

                    if (e.key === 'ArrowRight') {
                        const currentServing = queues.find(q => q.status === 'serving');
                        if (currentServing) {
                            showToastFn("ยังมีคิวที่กำลังให้บริการอยู่ (กด Enter เพื่อจบงาน)", 'error');
                            return;
                        }
                        const nextQueue = queues.find(q => q.status === 'waiting');
                        if (nextQueue) updateStatus(nextQueue.id, 'serving');
                        else showToastFn("ไม่มีคิวรอเรียก", 'error');
                    } 
                    
                    if (e.key === 'Enter') {
                        const currentServing = queues.find(q => q.status === 'serving');
                        // Add completedAt timestamp when status is set to 'completed'
                        if (currentServing) updateStatus(currentServing.id, 'completed', Date.now());
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [viewMode, isAdminAuthenticated, queues, showSkipPopup, showClearPopup, showConfirmPopup, showEditPopup, showScanner, showScannedAction, showRecallWait, showAutoRecallModal, showCloseReasonModal]);

            // Recall Countdown Logic
            useEffect(() => {
                let interval = null;
                if (showRecallWait && recallCountdown > 0) {
                    interval = setInterval(() => {
                        setRecallCountdown((prev) => prev - 1);
                    }, 1000);
                } else if (showRecallWait && recallCountdown === 0) {
                    setShowRecallWait(false);
                }
                return () => clearInterval(interval);
            }, [showRecallWait, recallCountdown]);


            // Scanner Logic
            useEffect(() => {
                if (showScanner) {
                    const timer = setTimeout(() => {
                        if (!scannerRef.current) {
                            const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 }, false);
                            html5QrcodeScanner.render((decodedText, decodedResult) => {
                                html5QrcodeScanner.clear().catch(e => console.error(e));
                                setShowScanner(false);
                                const scannedQ = queues.find(q => q.id === decodedText);
                                if (scannedQ) {
                                    setShowScannedAction({ queue: scannedQ });
                                } else {
                                    showToastFn("ไม่พบข้อมูลคิวนี้", "error");
                                }
                            }, (errorMessage) => {});
                            scannerRef.current = html5QrcodeScanner;
                        }
                    }, 100);
                    return () => clearTimeout(timer);
                } else {
                    if (scannerRef.current) {
                        scannerRef.current.clear().catch(e => console.error(e));
                        scannerRef.current = null;
                    }
                }
            }, [showScanner, queues]);

            useEffect(() => {
                try {
                    const { auth, db } = initFirebase();
                    setServices({ auth, db });
                    const unsubAuth = auth.onAuthStateChanged(async (u) => {
                        if (u) { setUser(u); } else {
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    try { await auth.signInWithCustomToken(__initial_auth_token); } catch { await auth.signInAnonymously(); }
                                } else { await auth.signInAnonymously(); }
                            } catch (authErr) { setErrorMsg("Auth Error: " + authErr.message); setConfigError(true); setLoading(false); }
                        }
                    });
                    const params = new URLSearchParams(window.location.search);
                    const mode = params.get('mode');
                    if (mode === 'kiosk') setViewMode('kiosk');
                    if (mode === 'display') setViewMode('display');
                    // NEW: Add QR-only mode
                    if (mode === 'qr-only') setViewMode('qr-only');
                    return () => unsubAuth();
                } catch (err) { setErrorMsg(err.message); setConfigError(true); setLoading(false); }
            }, []);

            useEffect(() => { if (showSkipPopup && skipInputRef.current) setTimeout(() => skipInputRef.current?.focus({ preventScroll: true }), 50); }, [showSkipPopup]);
            useEffect(() => { if (showClearPopup) { setClearPassword(''); setTimeout(() => clearInputRef.current?.focus({ preventScroll: true }), 50); } }, [showClearPopup]);
            useEffect(() => { if (showEditPopup) { setEditName(showEditPopup.queue.name); setTimeout(() => editInputRef.current?.focus({ preventScroll: true }), 50); } }, [showEditPopup]);
            useEffect(() => { if (showCloseReasonModal && closeReasonInputRef.current) setTimeout(() => closeReasonInputRef.current?.focus({ preventScroll: true }), 50); }, [showCloseReasonModal]);
            
            // Set temporary edit reason when settings open or closedReason changes
            useEffect(() => { setTempEditClosedReason(closedReason); }, [closedReason]);


            useEffect(() => {
                if (!services?.db || !user) return; 
                let collectionRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues') : services.db.collection('queues');
                const unsubQueues = collectionRef.onSnapshot(snapshot => {
                    const loaded = [];
                    snapshot.forEach(doc => loaded.push({ id: doc.id, ...doc.data() }));
                    loaded.sort((a, b) => a.createdAt - b.createdAt);
                    setQueues(loaded); setLoading(false);
                }, err => { if (err.code !== 'permission-denied') console.error(err); setLoading(false); });

                let settingsRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('main') : services.db.collection('settings').doc('main');
                const unsubSettings = settingsRef.onSnapshot(doc => {
                    if (doc.exists) { 
                        const data = doc.data(); 
                        if (data.queuePrefix) setQueuePrefix(data.queuePrefix); 
                        setSavedNotes(data.savedNotes || []); // Ensure array or empty
                        if (data.qrEnabled !== undefined) setQrEnabled(data.qrEnabled);
                        if (data.serviceOpen !== undefined) setServiceOpen(data.serviceOpen);
                        if (data.closedReason) setClosedReason(data.closedReason);
                        if (data.historyEnabled !== undefined) setHistoryEnabled(data.historyEnabled);
                        if (data.externalLinkEnabled !== undefined) setExternalLinkEnabled(data.externalLinkEnabled);
                        if (data.externalLinkMapping !== undefined) setExternalLinkMapping(data.externalLinkMapping);
                        if (data.externalLinkLabel !== undefined) setExternalLinkLabel(data.externalLinkLabel);
                        
                        if (data.adminSessionDuration !== undefined) {
                            const duration = parseInt(data.adminSessionDuration) || 60;
                            setAdminSessionDuration(duration);
                            // Also save to localStorage for AdminLogin component
                            localStorage.setItem(ADMIN_DURATION_KEY, duration.toString());
                        }
                        
                        // --- AI Time Estimation Setting Load ---
                        if (data.aiQueueTimeEnabled !== undefined) setAiQueueTimeEnabled(data.aiQueueTimeEnabled);
                        if (data.aiQueueTimeHistoryLimit !== undefined) setAiQueueTimeHistoryLimit(parseInt(data.aiQueueTimeHistoryLimit) || 5);
                        // ---------------------------------------
                        
                        // QR Settings (NEW)
                        if (data.qrExpireEnabled !== undefined) setQrExpireEnabled(data.qrExpireEnabled);
                        if (data.qrExpireTime !== undefined) setQrExpireTime(data.qrExpireTime);
                        if (data.qrToken) setQrToken(data.qrToken);
                        if (data.qrTokenExpiry !== undefined) setQrTokenExpiry(data.qrTokenExpiry);
                        
                        if (data.gasWebAppUrl !== undefined) setGasWebAppUrl(data.gasWebAppUrl);
                        if (data.masterLinkC1 !== undefined) setMasterLinkC1(data.masterLinkC1);
                        if (data.masterLinkTitle !== undefined) setMasterLinkTitle(data.masterLinkTitle); // NEW: Load master link title
                        if (data.lastSentLink !== undefined) setLastSentLink(data.lastSentLink); // NEW: Load last sent link
                        
                        // Check if the current link matches the last successfully sent link
                        if (data.masterLinkC1 === data.lastSentLink) {
                            setSendSuccess(true);
                        } else {
                            setSendSuccess(false);
                        }
                    }
                }, err => console.log("Settings sync skipped"));
                return () => { unsubQueues(); unsubSettings(); };
            }, [services, user]); 
            
            // --- AI Time Estimation Countdown Logic (Updated) ---
            useEffect(() => {
                let interval = null;
                
                if (aiQueueTimeEnabled && (viewMode === 'kiosk' || viewMode === 'display' || viewMode === 'admin')) {
                    
                    const calculateAndUpdateTime = () => {
                        const estimatedSeconds = getEstimatedTime(queues, myQueueId, {
                            enabled: aiQueueTimeEnabled,
                            limit: aiQueueTimeHistoryLimit
                        });
                        setEstimatedTimeSeconds(estimatedSeconds);
                    };

                    // Recalculate estimated time when queues change
                    calculateAndUpdateTime(); 
                    
                    // Start countdown interval
                    interval = setInterval(() => {
                        setEstimatedTimeSeconds(prev => (prev !== null && prev > 0) ? prev - 1 : (prev === 0 ? 0 : null));
                    }, 1000);
                    
                } else {
                    setEstimatedTimeSeconds(null);
                }

                return () => clearInterval(interval);
            }, [queues, myQueueId, aiQueueTimeEnabled, aiQueueTimeHistoryLimit, viewMode]);
            // --- END AI Time Estimation Countdown Logic ---

            // --- QR Code Auto-Update Logic (Display Mode/Admin Mode) ---
            useEffect(() => {
                let interval = null;
                const updateToken = () => {
                    if (services && user && qrExpireEnabled && qrExpireTime > 0) {
                        const now = Date.now();
                        const expiry = qrTokenExpiry || 0;
                        const expiryMs = qrExpireTime * 60 * 1000;
                        const timeSinceLastUpdate = now - (expiry - expiryMs);
                        
                        // If expired or within 1 second of interval starting time, generate new token
                        if (!qrTokenExpiry || expiry <= now || timeSinceLastUpdate >= expiryMs) {
                            const newToken = generateUniqueToken();
                            console.log(`Generating new QR token: ${newToken}`);
                            updateQrTokenInFirestore(newToken, qrExpireTime);
                        }
                    }
                };

                // Update countdown every second
                interval = setInterval(() => {
                    if (qrExpireEnabled && qrTokenExpiry) {
                        const now = Date.now();
                        const remaining = qrTokenExpiry - now;
                        setQrCountdown(Math.max(0, Math.floor(remaining / 1000)));

                        if (remaining <= 0) {
                             updateToken(); // Generate new token when countdown hits zero
                        }
                    } else {
                        setQrCountdown(0);
                    }
                }, 1000);

                // Run once on mount to check if token needs refresh
                updateToken();

                return () => clearInterval(interval);
            }, [services, user, qrExpireEnabled, qrExpireTime, qrTokenExpiry]);
            
            const formatCountdown = (seconds) => {
                const min = Math.floor(seconds / 60);
                const sec = seconds % 60;
                return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
            };
            
            // --- END QR Code Auto-Update Logic ---

            // --- Auto-Sync External Link Mapping Interval (5 seconds) ---
            useEffect(() => {
                // FIX: useGasForLink is now always true in state, so we check externalLinkEnabled
                const isGasLinkerActive = externalLinkEnabled && gasWebAppUrl;
                if (!services?.db || !user || !isGasLinkerActive) return;

                // Function to perform the sync silently for auto-run
                const silentSyncGAS = async () => {
                    if (!gasWebAppUrl || gasWebAppUrl.trim() === '') return;
                    
                    try {
                        const response = await fetch(gasWebAppUrl);
                        if (!response.ok) throw new Error("GAS connection failed");
                        
                        const json = await response.json();
                        const currentTime = Date.now(); // Get current timestamp
                        
                        if (Array.isArray(json)) {
                            const mappingString = json.map(row => {
                                 if (Array.isArray(row) && row.length >= 2) {
                                     // Ensure both key and value are strings and join them with a comma
                                     return `${String(row[0]).trim()},${String(row[1]).trim()}`;
                                 }
                                 return null;
                            }).filter(Boolean).join('\n');

                            // Only update state if mapping has changed 
                            setExternalLinkMapping(prev => {
                                if (prev !== mappingString) {
                                    // Log silent update, but don't toast
                                    console.log("GAS mapping silently updated.");
                                }
                                return mappingString;
                            });
                            
                            setLastGasSyncTime(currentTime); // Update sync time

                        } else {
                            console.warn("GAS data format invalid for silent sync.");
                        }
                    } catch (error) {
                        // Suppress constant console errors during normal operation if GAS is down/slow
                        // console.error("Silent GAS Sync Error:", error); 
                    }
                };

                // Run immediately on load (after settings are loaded)
                silentSyncGAS(); 

                const intervalId = setInterval(() => {
                    silentSyncGAS();
                }, 5000); // 5 seconds interval

                return () => clearInterval(intervalId);
            }, [services, user, externalLinkEnabled, gasWebAppUrl]);
            // --- END Auto-Sync External Link Mapping Interval ---

            useEffect(() => {
                if (!myQueueId || queues.length === 0) return;
                const myQ = queues.find(q => q.id === myQueueId);
                if (myQ && myQ.status === 'serving') {
                    const lastPlayed = lastAnnouncedMyQueueRef.current;
                    const isNewCall = !lastPlayed || lastPlayed.id !== myQ.id || lastPlayed.calledAt !== myQ.calledAt;
                    if (isNewCall) {
                        playBeepSound(); 
                        setTimeout(() => announceQueue(myQ.number, myQ.name, 'client'), 1000);
                        lastAnnouncedMyQueueRef.current = { id: myQ.id, calledAt: myQ.calledAt };
                    }
                }
            }, [queues, myQueueId]);

            useEffect(() => {
                if (viewMode !== 'display' || queues.length === 0) return;
                const currentServing = queues.find(q => q.status === 'serving');
                if (currentServing) {
                    const lastPlayed = lastAnnouncedDisplayRef.current;
                    const isNewCall = !lastPlayed || lastPlayed.id !== currentServing.id || lastPlayed.calledAt !== currentServing.calledAt;
                    if (isNewCall) {
                        setTimeout(() => announceQueue(currentServing.number, currentServing.name, 'display'), 500);
                        lastAnnouncedDisplayRef.current = { id: currentServing.id, calledAt: currentServing.calledAt };
                    }
                }
            }, [queues, viewMode]);

            const handleBookQueue = async (e) => {
                e.preventDefault();
                if (!customerName.trim() || !services || !user) return;
                
                // Kiosk Mode: Check QR Token Expiry
                const params = new URLSearchParams(window.location.search);
                const kioskToken = params.get('queue_token');
                
                if (qrExpireEnabled) {
                     // Check if token is present, if it matches the current token, and if it has not expired
                     if (!kioskToken || kioskToken !== qrToken || (qrTokenExpiry && Date.now() > qrTokenExpiry)) {
                         showToastFn("QR Code หมดอายุแล้ว กรุณาสแกนใหม่", 'error');
                         setCustomerName('');
                         return;
                     }
                }
                
                setIsSubmitting(true);
                await requestWakeLock();
                
                // Initialize audio on interaction
                initGlobalAudio();

                const prefixQueues = queues.filter(q => q.number.startsWith(queuePrefix));
                const maxNum = prefixQueues.reduce((max, q) => { const parts = q.number.split('-'); if (parts.length < 2) return max; const n = parseInt(parts[1]); return n > max ? n : max; }, 0);
                const nextNum = String(maxNum + 1).padStart(3, '0');
                const queueNumber = `${queuePrefix}-${nextNum}`;
                try {
                    let collectionRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues') : services.db.collection('queues');
                    // Add createdAt only (completedAt will be added when status changes to 'completed')
                    const ref = await collectionRef.add({ number: queueNumber, name: customerName, status: 'waiting', createdAt: Date.now(), calledAt: null, completedAt: null, skipCount: 0, note: '' });
                    localStorage.setItem('my_queue_id', ref.id);
                    
                    // Save to local history
                    const currentHistory = JSON.parse(localStorage.getItem('my_queue_history') || '[]');
                    const now = new Date();
                    const newHistory = [{
                        id: ref.id,
                        number: queueNumber,
                        date: now.toLocaleDateString('th-TH'),
                        time: now.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'}),
                        name: customerName,
                    }, ...currentHistory].slice(0, 10); // Keep last 10
                    localStorage.setItem('my_queue_history', JSON.stringify(newHistory));
                    
                    setMyQueueId(ref.id); setCustomerName('');
                    
                    // Ensure audio enabled state in UI
                    setAudioEnabled(true);

                } catch (err) { showToastFn(err.message, 'error'); } finally { setIsSubmitting(false); }
            };

            /**
             * Updates the status of a queue. Automatically handles setting timestamps.
             * @param {string} id - Queue ID.
             * @param {string} status - New status ('serving', 'completed', 'waiting', 'cancelled').
             * @param {number} [completedAt=null] - Optional timestamp for 'completed' status.
             */
            const updateStatus = async (id, status, completedAt = null) => {
                if (!user) return;
                try {
                    // Check if stopping auto recall is needed
                    if (autoRecallState.active) {
                        stopAutoRecall();
                    }

                    let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues').doc(id) : services.db.collection('queues').doc(id);
                    const updateData = { status }; 
                    
                    if (status === 'serving') {
                        updateData.calledAt = Date.now();
                        updateData.completedAt = null; // Clear completion time if recalling
                    } else if (status === 'completed') {
                        updateData.completedAt = completedAt || Date.now(); // Record actual completion time
                    } else if (status === 'waiting') {
                        // Reset timestamps if status is manually set back to waiting
                        updateData.calledAt = null;
                        updateData.completedAt = null;
                    } else if (status === 'cancelled') {
                        // Reset timestamps for cancelled
                        updateData.calledAt = null;
                        updateData.completedAt = null;
                    }
                    
                    await docRef.update(updateData);
                    if(showScannedAction) setShowScannedAction(null); 
                } catch (err) { console.error(err); }
            };

            const openSkipPopup = (queue) => { setQueueToSkip(queue); setSkipNote(''); setShowSkipPopup(true); };

            const handleConfirmSkip = async () => {
                if (!user || !queueToSkip) return;
                
                if (autoRecallState.active) stopAutoRecall();

                const noteToSave = skipNote.trim() === "" ? "ข้าม" : skipNote.trim();
                if (!savedNotes.includes(noteToSave)) {
                    try {
                        let settingsRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('main') : services.db.collection('settings').doc('main');
                        await settingsRef.set({ savedNotes: [...savedNotes, noteToSave] }, { merge: true });
                    } catch(e) {}
                }
                const currentSkipCount = queueToSkip.skipCount || 0;
                let newCreatedAt = queueToSkip.createdAt;
                const waitingList = queues.filter(q => q.status === 'waiting');
                // The priority logic is: if skipped for the first time, insert after the oldest waiting queue. 
                // If skipped multiple times, reset to the end of the queue.
                if (currentSkipCount === 0) { 
                    if (waitingList.length > 0) {
                        // Find the oldest *waiting* queue and insert this one after it
                        newCreatedAt = waitingList[0].createdAt - 1; 
                    } else {
                        newCreatedAt = Date.now(); 
                    }
                } else { 
                    newCreatedAt = Date.now(); 
                }
                
                try {
                    let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues').doc(queueToSkip.id) : services.db.collection('queues').doc(queueToSkip.id);
                    await docRef.update({ 
                        status: 'waiting', 
                        note: noteToSave, 
                        skipCount: currentSkipCount + 1, 
                        createdAt: newCreatedAt,
                        calledAt: null, // Clear calling time
                        completedAt: null, // Clear completion time
                    });
                    setShowSkipPopup(false); setQueueToSkip(null);
                    if(showScannedAction) setShowScannedAction(null);
                } catch (err) { showToastFn(err.message, 'error'); }
            };

            // Standard Single Recall
            const handleRecall = async (id) => {
                if (!user) return;
                
                // If manual recall is pressed while auto is running, stop auto first? 
                if (autoRecallState.active && autoRecallState.timer) {
                    stopAutoRecall();
                }
                
                // Start Cooldown Logic
                setRecallCountdown(5); // 5 seconds cooldown
                setShowRecallWait(true);

                try {
                    let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues').doc(id) : services.db.collection('queues').doc(id);
                    await docRef.update({ 
                        status: 'serving', 
                        calledAt: Date.now(),
                        completedAt: null, // Clear completion time on recall
                    });
                    setShowHistory(null);
                    if(showScannedAction) setShowScannedAction(null);
                } catch (err) { console.error(err); }
            };

            // --- Auto Recall Logic ---

            const startAutoRecall = (queueId) => {
                const interval = parseInt(autoRecallConfig.interval);
                if (interval < 7) {
                    showToastFn("ระยะห่างต้องไม่ต่ำกว่า 7 วินาที", "error");
                    setAutoRecallConfig(prev => ({...prev, interval: 7}));
                    return;
                }
                setShowAutoRecallModal(false);
                performAutoRecallStep(queueId, 1, parseInt(autoRecallConfig.count));
            };

            const performAutoRecallStep = async (queueId, currentStep, totalSteps) => {
                if (currentStep > totalSteps) {
                    stopAutoRecall();
                    return;
                }
                
                // Update UI State
                setAutoRecallState(prev => ({ ...prev, active: true, current: currentStep, total: totalSteps }));
                
                // Trigger Recall (Update Firestore)
                try {
                    let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues').doc(queueId) : services.db.collection('queues').doc(queueId);
                    await docRef.update({ 
                        status: 'serving', 
                        calledAt: Date.now(),
                        completedAt: null, // Clear completion time on recall
                    });
                } catch (err) { console.error("Auto recall error", err); }

                // Schedule Next Step if not finished
                if (currentStep < totalSteps) {
                    const timer = setTimeout(() => {
                        performAutoRecallStep(queueId, currentStep + 1, totalSteps);
                    }, parseInt(autoRecallConfig.interval) * 1000);
                    setAutoRecallState(prev => ({ ...prev, timer }));
                } else {
                    // Cleanup after last step delay (to show completed state briefly)
                    setTimeout(() => stopAutoRecall(), 2000);
                }
            };

            const stopAutoRecall = () => {
                if (autoRecallState.timer) clearTimeout(autoRecallState.timer);
                setAutoRecallState({ active: false, current: 0, total: 0, timer: null });
            };


            const handleDeleteConfirm = async () => {
                if (!user || !showConfirmPopup) return;
                try {
                    let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues').doc(showConfirmPopup.id) : services.db.collection('queues').doc(showConfirmPopup.id);
                    await docRef.delete();
                    setShowConfirmPopup(null);
                    showToastFn("ลบรายการเรียบร้อย", 'success');
                } catch (err) { showToastFn("ลบไม่สำเร็จ: " + err.message, 'error'); }
            };

            const handleEditSubmit = async () => {
                if (!user || !showEditPopup) return;
                if (!editName.trim()) return;
                try {
                    let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues').doc(showEditPopup.queue.id) : services.db.collection('queues').doc(showEditPopup.queue.id);
                    await docRef.update({ name: editName.trim() });
                    setShowEditPopup(null);
                    showToastFn("แก้ไขชื่อเรียบร้อย", 'success');
                } catch (err) { showToastFn("แก้ไขไม่สำเร็จ: " + err.message, 'error'); }
            };

            const handleClearQueuesSubmit = async () => {
                if (clearPassword !== 'Admin123') { showToastFn('รหัสผ่านไม่ถูกต้อง', 'error'); return; }
                if (!user) return;
                try {
                    const batch = services.db.batch();
                    let collectionRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues') : services.db.collection('queues');
                    const snapshot = await collectionRef.get();
                    snapshot.docs.forEach((doc) => batch.delete(doc.ref));

                    let settingsRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('main') : services.db.collection('settings').doc('main');
                    batch.set(settingsRef, { savedNotes: [] }, { merge: true });

                    await batch.commit();
                    setSavedNotes([]); setQueues([]); // Instant UI update
                    // ----------------------------------------------------
                    // FIX: Clear customer's booking history (localStorage)
                    // ----------------------------------------------------
                    localStorage.removeItem('my_queue_history');
                    localStorage.removeItem('my_queue_id'); // NEW: Ensure the current queue ID is also cleared
                    // ----------------------------------------------------
                    
                    setShowClearPopup(false);
                    // NEW: Ensure the history UI updates immediately by setting showHistory to null
                    setShowHistory(null);
                    showToastFn("ล้างข้อมูลและประวัติเรียบร้อยแล้ว", 'success');
                } catch (err) { showToastFn("Error clearing: " + err.message, 'error'); }
            };

            const confirmCloseService = () => {
                // FIXED: ใช้ค่าเริ่มต้น "ปิดให้บริการชั่วคราว" หาก tempClosedReason ว่าง
                const reason = tempClosedReason.trim() === '' ? 'ปิดให้บริการชั่วคราว' : tempClosedReason.trim();
                setClosedReason(reason);
                setServiceOpen(false);
                setShowCloseReasonModal(false);
                // Auto save
                if (user && services) {
                    let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('main') : services.db.collection('settings').doc('main');
                    docRef.set({ serviceOpen: false, closedReason: reason }, { merge: true });
                }
            };

            const handleSaveClosedReason = async (reasonToSave) => {
                 if (!user || !services) return;
                 const reason = reasonToSave.trim() === '' ? 'ปิดให้บริการชั่วคราว' : reasonToSave.trim();
                 setClosedReason(reason);
                 setTempEditClosedReason(reason); // Update temp state after successful save
                 try {
                     let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('main') : services.db.collection('settings').doc('main');
                     await docRef.set({ closedReason: reason }, { merge: true });
                     showToastFn("อัปเดตเหตุผลเรียบร้อย", 'success');
                 } catch (err) {
                     showToastFn("อัปเดตเหตุผลไม่สำเร็จ", 'error');
                 }
            }
            
            const handleServiceToggle = () => {
                if (serviceOpen) {
                    // Currently Open -> Want to Close
                    setTempClosedReason(closedReason === 'ปิดให้บริการ' ? '' : closedReason); // Set current reason to modal input
                    setShowCloseReasonModal(true);
                } else {
                    // Currently Closed -> Want to Open
                    setServiceOpen(true);
                    // Auto save
                    if (user && services) {
                        let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('main') : services.db.collection('settings').doc('main');
                        docRef.set({ serviceOpen: true }, { merge: true });
                    }
                }
            };

            const handleSaveSettings = async () => {
                if (!user || !services) return;
                
                // If QR expiration is enabled, ensure token is generated and saved if missing
                if (qrExpireEnabled && !qrToken) {
                    const newToken = generateUniqueToken();
                    await updateQrTokenInFirestore(newToken, qrExpireTime);
                }
                
                const durationToSave = parseInt(adminSessionDuration) > 0 ? parseInt(adminSessionDuration) : 60;
                const historyLimitToSave = parseInt(aiQueueTimeHistoryLimit) > 0 ? parseInt(aiQueueTimeHistoryLimit) : 5;


                try {
                    let docRef = (typeof __app_id !== 'undefined') ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('main') : services.db.collection('settings').doc('main');
                    await docRef.set({ 
                        queuePrefix: queuePrefix, 
                        qrEnabled: qrEnabled,
                        historyEnabled: historyEnabled,
                        externalLinkEnabled: externalLinkEnabled,
                        externalLinkMapping: externalLinkMapping,
                        externalLinkLabel: externalLinkLabel,
                        useGasForLink: true, // FIX: Always save as true since manual option is removed
                        gasWebAppUrl: gasWebAppUrl,
                        masterLinkC1: masterLinkC1,
                        masterLinkTitle: masterLinkTitle, // NEW: Save master link title
                        lastSentLink: lastSentLink, // NEW: Save last successful sent link for persistence
                        // QR Settings (NEW)
                        qrExpireEnabled: qrExpireEnabled,
                        qrExpireTime: parseInt(qrExpireTime) > 0 ? parseInt(qrExpireTime) : 5, // Ensure positive integer or default
                        // Admin Session Duration Setting Save
                        adminSessionDuration: durationToSave,
                        // --- AI Time Estimation Setting Save ---
                        aiQueueTimeEnabled: aiQueueTimeEnabled,
                        aiQueueTimeHistoryLimit: historyLimitToSave,
                        // ----------------------------------------
                    }, { merge: true });
                    
                    // Save to local storage immediately for use by AdminLogin
                    localStorage.setItem(ADMIN_DURATION_KEY, durationToSave.toString());
                    
                    setShowSettings(false);
                    showToastFn("บันทึกการตั้งค่าเรียบร้อย", 'success');
                } catch (err) { showToastFn("บันทึกไม่สำเร็จ: " + err.message, 'error'); }
            };

            const openKioskLink = () => { 
                const url = new URL(window.location.href); 
                url.searchParams.set('mode', 'kiosk'); 
                
                // Add token if expiration is enabled and token exists
                if(qrExpireEnabled && qrToken) {
                    url.searchParams.set('queue_token', qrToken);
                } else {
                    url.searchParams.delete('queue_token');
                }
                
                window.open(url.toString(), '_blank'); 
            };

            const openQROnlyLink = () => { 
                const url = new URL(window.location.href); 
                url.searchParams.set('mode', 'qr-only'); 
                
                // Add token if expiration is enabled and token exists
                if(qrExpireEnabled && qrToken) {
                    url.searchParams.set('queue_token', qrToken);
                } else {
                    url.searchParams.delete('queue_token');
                }
                
                window.open(url.toString(), '_blank'); 
            };

            const waitingQueues = queues.filter(q => q.status === 'waiting');
            const currentServing = queues.find(q => q.status === 'serving');
            const myQueue = queues.find(q => q.id === myQueueId);
            
            let historyList = [];
            if (showHistory === 'all') historyList = [...queues].sort((a, b) => b.createdAt - b.createdAt);
            else if (showHistory) historyList = queues.filter(q => q.status === showHistory).sort((a, b) => b.createdAt - b.createdAt);

            if (configError) return <SetupError errorMsg={errorMsg} />;
            if (loading) return <div className="h-screen flex items-center justify-center text-slate-400">กำลังเชื่อมต่อระบบ...</div>;

            // --- ADMIN SESSION TIMEOUT CHECK (Request 2) ---
            if (viewMode === 'admin') {
                const storedExpiry = localStorage.getItem(ADMIN_EXPIRY_KEY);
                const isExpired = storedExpiry && Date.now() > parseInt(storedExpiry);

                if (isExpired && isAdminAuthenticated) {
                    // Force re-login if expired
                    localStorage.removeItem(ADMIN_EXPIRY_KEY);
                    setIsAdminAuthenticated(false);
                    // Use setTimeout to allow the current render cycle to complete before showing toast
                    setTimeout(() => showToastFn("Admin Session หมดอายุแล้ว กรุณาเข้าสู่ระบบใหม่", "error"), 100); 
                }
            }
            
            if (viewMode === 'admin' && !isAdminAuthenticated) return <AdminLogin onLogin={() => setIsAdminAuthenticated(true)} durationMinutes={adminSessionDuration} />;
            // --- END ADMIN SESSION TIMEOUT CHECK ---

            // Generate full QR Code URL for Display Mode (and QR Only Mode)
            const kioskUrl = new URL(window.location.href);
            kioskUrl.search = '';
            kioskUrl.searchParams.set('mode', 'kiosk');
            if(qrExpireEnabled && qrToken) {
                 kioskUrl.searchParams.set('queue_token', qrToken);
            }
            // The URL used for the QR code image generation
            const qrCodeData = kioskUrl.toString(); 

            // ===============================================
            // NEW: QR-ONLY MODE LOGIC (FOR EMBEDDING)
            // ===============================================
            if (viewMode === 'qr-only') {
                 // The main container must be transparent to allow embedding with minimal fuss
                 return (
                    // Use min-h-screen and bg-transparent
                    <div className="min-h-screen w-screen bg-transparent text-slate-900 flex flex-col items-center justify-center p-4">
                        {/* FIXED: เพิ่ม bg-white คลุมทั้งบล็อก QR และข้อความกำกับ */}
                        <div className="bg-white p-6 rounded-3xl shadow-xl border border-white/20 text-center animate-fade-in max-w-sm w-full">
                            
                            <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center justify-center gap-2">
                                <Icons.QrCode size={24} className="text-indigo-600"/> สแกนเพื่อรับบัตรคิว
                            </h2>

                            <div className="bg-slate-100 p-4 rounded-xl inline-block mb-4">
                                <img 
                                    src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrCodeData)}`} 
                                    alt="Queue QR Code" 
                                    className="w-48 h-48 sm:w-64 sm:h-64" 
                                    key={qrToken}
                                />
                            </div>
                            
                            <p className="text-lg font-medium text-slate-800 mb-1">คิวปัจจุบัน: <span className="font-bold text-indigo-600">{currentServing ? currentServing.number : '--'}</span></p>
                            
                            {/* FIXED: แสดงสถานะการหมดอายุตามที่ตั้งค่า */}
                            {qrEnabled && qrExpireEnabled && qrTokenExpiry ? (
                                <div className="text-sm font-bold text-red-500 mt-2 flex items-center justify-center">
                                    <Icons.Clock size={16} className="inline-block mr-1"/> QR Code เปลี่ยนใหม่ใน: {formatCountdown(qrCountdown)}
                                </div>
                            ) : (qrEnabled && <div className="text-sm text-slate-500 mt-2">QR Code ไม่หมดอายุ (คงที่)</div>)}
                            
                            <div className="text-xs text-slate-400 mt-4">Powered by Q-Master System</div>

                        </div>
                    </div>
                );
            }

            if (viewMode === 'kiosk') {
                return (
                    // กล่องหลักสำหรับหน้า KIOSK
                    <div className="h-[100dvh] w-screen bg-slate-100 flex flex-col overflow-hidden fixed inset-0">
                        <Toast message={toast.message} type={toast.type} show={toast.show} />
                        
                        {/* 1. Alerts as part of layout flow - ปรับให้ใช้พื้นที่น้อยลง (p-3) */}
                        {myQueue && myQueue.status === 'serving' && (
                           <div className="bg-red-600 text-white p-3 animate-bounce-slow text-center shadow-lg flex flex-col items-center justify-center flex-shrink-0 z-50">
                              <div className="text-lg sm:text-xl font-black flex items-center justify-center gap-2">
                                 <Icons.Bell size={24} className="animate-pulse"/> 
                                 คิว {myQueue.number} ถึงคิวของคุณแล้ว
                              </div>
                              <div className="text-xs opacity-90 mt-1">กรุณาติดต่อช่องบริการทันที</div>
                           </div>
                        )}
                        
                        {/* New: Skipped Message Area - Alert Box (Top Overlay) - ปรับให้ใช้พื้นที่น้อยลง (p-3) */}
                        {myQueue && myQueue.status === 'waiting' && myQueue.skipCount > 0 && (
                           <div className="bg-amber-500 text-white p-3 animate-bounce-slow text-center shadow-lg flex flex-col items-center justify-center flex-shrink-0 z-50">
                              <div className="text-lg sm:text-xl font-black flex items-center justify-center gap-2">
                                 <Icons.Skip size={24} className="animate-pulse"/> 
                                 คุณถูกข้ามคิว
                              </div>
                              <div className="text-xs opacity-90 mt-1">เหตุผล: {myQueue.note} | กรุณารอเรียกอีกครั้ง</div>
                           </div>
                        )}

                        {/* Center content wrapper */}
                        <div className="flex-1 flex flex-col items-center justify-center p-4 w-full relative z-0">
                        {(!myQueue || myQueue.status === 'cancelled') ? (
                            <div className="bg-white w-full max-w-md rounded-3xl shadow-xl overflow-hidden animate-fade-in flex flex-col max-h-[90vh]">
                                <div className="bg-indigo-600 p-6 text-white text-center">
                                    <h1 className="text-2xl font-bold mb-2">รับบัตรคิว</h1>
                                    <p className="text-indigo-100 text-sm">กรอกชื่อเพื่อรับคิว ({queuePrefix})</p>
                                </div>
                                <div className="p-6 flex-1 overflow-y-auto flex flex-col justify-center">
                                    {/* Service Open Check */}
                                    {serviceOpen ? (
                                        <form onSubmit={handleBookQueue} className="space-y-6">
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-2">ชื่อของคุณ</label>
                                                <input autoFocus type="text" value={customerName} onChange={e => setCustomerName(e.target.value)} className="w-full px-4 py-4 text-lg border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="เช่น คุณสมชาย" disabled={isSubmitting} />
                                            </div>
                                            <button type="submit" disabled={isSubmitting} className={`w-full text-white font-bold py-4 rounded-xl text-lg shadow-lg shadow-indigo-200 transition-all flex items-center justify-center gap-2 ${isSubmitting ? 'bg-indigo-400' : 'bg-indigo-600 hover:bg-indigo-700 active:scale-95'}`}>
                                                {isSubmitting ? <><Icons.Loader size={24}/> กำลังบันทึก...</> : 'รับบัตรคิว'}
                                            </button>
                                            <div className="text-center text-slate-400 text-sm">รออยู่ <span className="text-indigo-600 font-bold">{queues.filter(q => q.status === 'waiting').length}</span> คิว</div>
                                            
                                            {/* Estimated Time (Display Mode: Target first waiting queue) */}
                                            {aiQueueTimeEnabled && estimatedTimeSeconds !== null && (
                                                <div className="text-center text-sm text-green-600 font-bold bg-green-50 p-3 rounded-lg border border-green-100 animate-fade-in">
                                                    <Icons.Time size={16} className="inline-block mr-1"/>
                                                    คิวถัดไปคาดว่าจะใช้เวลา: {formatSecondsToMinutes(estimatedTimeSeconds)}
                                                </div>
                                            )}
                                            
                                            {historyEnabled && (
                                                <button type="button" onClick={() => setShowMyHistory(true)} className="w-full flex items-center justify-center gap-2 text-slate-500 hover:text-indigo-600 mt-4 text-sm font-bold transition-colors">
                                                    <Icons.History size={16}/> ประวัติการจองของฉัน
                                                </button>
                                            )}
                                        </form>
                                    ) : (
                                        <div className="flex flex-col items-center justify-center h-full text-center space-y-6 py-10">
                                            <div className="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center text-red-500 animate-pulse">
                                                <Icons.Lock size={48} />
                                            </div>
                                            <div>
                                                <h2 className="2xl font-bold text-slate-800">ปิดให้บริการ</h2>
                                                <p className="text-slate-500 mt-2 text-lg">{closedReason}</p>
                                            </div>
                                            
                                            {/* FIXED: อนุญาตให้ดูประวัติได้แม้ปิดให้บริการ & ใช้สไตล์เหมือนปุ่มหลัก */}
                                            {historyEnabled && (
                                                <button type="button" onClick={() => setShowMyHistory(true)} className="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl text-lg shadow-lg shadow-indigo-200 hover:bg-indigo-700 active:scale-95 transition-all flex items-center justify-center gap-2 mt-4">
                                                    <Icons.History size={20}/> ดูประวัติการจอง
                                                </button>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : (
                            <div className="bg-white w-full max-w-md rounded-3xl shadow-xl overflow-hidden animate-fade-in relative flex flex-col max-h-[90vh]">
                                <div className="h-2 bg-gradient-to-r from-indigo-500 to-purple-500 flex-shrink-0"></div>
                                <button onClick={() => {if(myQueue?.status !== 'serving') {localStorage.removeItem('my_queue_id'); setMyQueueId(null);}}} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600 z-10"><Icons.Cross size={24}/></button>
                                <div className="p-6 text-center space-y-4 flex-1 overflow-y-auto flex flex-col justify-center">
                                    <div className="flex-shrink-0"><span className="bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-xs font-bold tracking-wide">YOUR QUEUE</span><h1 className="text-6xl sm:text-7xl font-black text-slate-800 mt-4 tracking-tighter">{myQueue.number}</h1></div>
                                    
                                    <div className={`flex-shrink-0 inline-flex items-center justify-center gap-2 px-6 py-2 rounded-full font-bold shadow-sm mx-auto w-fit ${myQueue.status === 'waiting' ? (myQueue.skipCount > 0 ? 'bg-amber-100 text-amber-700 border border-amber-200' : 'bg-amber-50 text-amber-600') : (myQueue.status === 'completed' ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-green-50 text-green-600 animate-pulse')}`}>
                                        {myQueue.status === 'waiting' ? (
                                            myQueue.skipCount > 0 ? (
                                                <><Icons.Skip size={20}/> ถูกข้าม: {myQueue.note}</>
                                            ) : (
                                                <><Icons.Clock size={20}/> กำลังรอเรียก...</>
                                            )
                                        ) : myQueue.status === 'completed' ? (
                                            <><Icons.Check size={20}/> เสร็จสิ้นการรับบริการ</>
                                        ) : (
                                            <><Icons.Volume size={20}/> ถึงคิวคุณแล้ว!</>
                                        )}
                                    </div>

                                    {/* Estimated Time (Kiosk Mode: Target my queue) */}
                                    {aiQueueTimeEnabled && myQueue.status === 'waiting' && estimatedTimeSeconds !== null && (
                                        <div className="text-center text-sm text-green-600 font-bold bg-green-50 p-3 rounded-lg border border-green-100 animate-fade-in">
                                            <Icons.Time size={16} className="inline-block mr-1"/>
                                            คาดว่าคิวจะถึงใน: {formatSecondsToMinutes(estimatedTimeSeconds)}
                                        </div>
                                    )}

                                    <div className="bg-slate-50 rounded-2xl p-4 border border-slate-100 space-y-2 flex-shrink-0">
                                        <div className="flex justify-between items-end border-b border-slate-200 pb-2">
                                            <div className="text-left">
                                                <div className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">คิวปัจจุบัน</div>
                                                <div className="text-2xl font-black text-indigo-600 leading-none">{currentServing ? currentServing.number : '--'}</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">รออีก (คิว)</div>
                                                <div className="text-2xl font-black text-slate-700 leading-none">{queues.filter(q => q.status === 'waiting' && q.createdAt < myQueue.createdAt).length}</div>
                                            </div>
                                        </div>
                                        <div className="flex justify-between items-center text-sm pt-1">
                                            <span className="text-slate-400">ชื่อผู้จอง</span>
                                            <span className="font-bold text-slate-700 truncate max-w-[150px]">{myQueue.name}</span>
                                        </div>
                                        
                                        {/* QR Code Button */}
                                        {qrEnabled && myQueue.status !== 'completed' && (
                                            <div className="pt-2 mt-2 border-t border-slate-200">
                                                <button onClick={() => setShowMyQR(true)} className="w-full py-2 bg-white border border-slate-200 hover:bg-slate-50 rounded-lg flex items-center justify-center gap-2 text-slate-600 font-bold text-sm transition-colors">
                                                    <Icons.QrCode size={18} /> แสดง QR Code
                                                </button>
                                            </div>
                                        )}

                                        {/* NEW: External Link Button (Only when Completed) */}
                                        {externalLinkEnabled && myQueue.status === 'completed' && (
                                            <div className="pt-2 mt-2 border-t border-slate-200">
                                                <button 
                                                    onClick={() => handleOpenExternalLink(externalLinkMapping, myQueue.number, true)} 
                                                    className="w-full py-3 bg-blue-600 border border-blue-700 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center gap-2 font-bold text-sm transition-colors shadow-md animate-bounce-slow"
                                                >
                                                    <Icons.Folder size={18} /> {externalLinkLabel || 'เปิดเอกสาร / โฟลเดอร์คิว'}
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Audio Enable Button (Small) - Hide when completed */}
                                    {!audioEnabled && myQueue.status !== 'completed' && (
                                        <button onClick={handleEnableAudio} className="flex-shrink-0 flex items-center justify-center gap-2 w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-600 py-2 rounded-xl font-bold text-sm transition-colors border border-indigo-200">
                                            <Icons.Speaker size={16}/> 🔔 เปิดเสียงแจ้งเตือน
                                        </button>
                                    )}

                                    {myQueue.status !== 'completed' && (
                                        <div className="flex-shrink-0 text-xs text-slate-400 bg-yellow-50 p-2 rounded text-center border border-yellow-100">
                                            ⚠️ กรุณาเปิดหน้านี้ค้างไว้เพื่อรับการแจ้งเตือนเมื่อถึงคิว
                                        </div>
                                    )}

                                    <button onClick={() => {localStorage.removeItem('my_queue_id'); setMyQueueId(null);}} className="flex-shrink-0 text-slate-400 text-sm hover:text-slate-600 underline mt-auto">จองคิวใหม่ / ออกจากหน้านี้</button>
                                </div>
                            </div>
                        )}
                        </div>
                        
                        {/* Footer (Q-Master Kiosk) */}
                        <div className="p-2 text-center text-slate-400 text-xs font-medium tracking-widest uppercase flex-shrink-0">Q-Master Kiosk</div>

                        {/* Customer History Modal */}
                        {showMyHistory && (
                            <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
                                 <div className="bg-white rounded-2xl w-full max-w-sm relative shadow-2xl flex flex-col max-h-[80vh]">
                                     <div className="p-4 border-b border-slate-100 flex justify-between items-center">
                                         <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2"><Icons.History size={20}/> ประวัติการจองของฉัน</h3>
                                         {/* Note: Customer history is ONLY stored in localStorage, which is cleared on global clear */}
                                         <button onClick={() => setShowMyHistory(false)} className="text-slate-400 hover:text-slate-600"><Icons.Cross size={24}/></button>
                                     </div>
                                     <div className="p-4 overflow-y-auto flex-1">
                                         {/* START FIX: Filter history to show only completed or cancelled queues */}
                                         {(() => {
                                             const localHistory = JSON.parse(localStorage.getItem('my_queue_history') || '[]');
                                             const displayHistory = localHistory.filter(h => {
                                                 const liveQ = queues.find(q => q.id === h.id);
                                                 // Only show history if its live status is completed or cancelled.
                                                 if (liveQ) {
                                                     return liveQ.status === 'completed' || liveQ.status === 'cancelled';
                                                 }
                                                 return false; 
                                             });

                                             if (displayHistory.length > 0) {
                                                 return (
                                                     <div className="space-y-2">
                                                         {displayHistory.map((h, i) => {
                                                             const liveQ = queues.find(q => q.id === h.id);
                                                             const isCompleted = liveQ && liveQ.status === 'completed';
                                                             const isCancelled = liveQ && liveQ.status === 'cancelled';
                                                             
                                                             return (
                                                                 <div 
                                                                     key={i} 
                                                                     onClick={() => setSelectedHistoryItem({...h, status: liveQ ? liveQ.status : 'unknown'})} 
                                                                     className="flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100 cursor-pointer hover:bg-slate-100 transition-colors"
                                                                 >
                                                                     <div>
                                                                         <div className="font-bold text-indigo-600 text-lg flex items-center gap-2">
                                                                            {h.number}
                                                                            {isCompleted ? <Icons.Check size={14} className="text-green-500"/> : isCancelled ? <Icons.Cross size={14} className="text-red-500"/> : null}
                                                                         </div>
                                                                         <div className="text-xs text-slate-400">{h.date} - {h.time}</div>
                                                                     </div>
                                                                     <div className="text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg></div>
                                                                 </div>
                                                             );
                                                         })}
                                                     </div>
                                                 );
                                             } else {
                                                 return (
                                                     <div className="text-center text-slate-400 py-8">ไม่มีประวัติการจองที่เสร็จสิ้นหรือยกเลิก</div>
                                                 );
                                             }
                                         })()}
                                         {/* END FIX: Filter history to show only completed or cancelled queues */}
                                     </div>
                                     <div className="p-4 border-t border-slate-100">
                                         <button onClick={() => setShowMyHistory(false)} className="w-full bg-slate-100 text-slate-600 py-2 rounded-lg font-bold hover:bg-slate-200">ปิด</button>
                                     </div>
                                 </div>
                            </div>
                        )}

                        {/* Customer History Detail Modal (Full Ticket View) */}
                        {selectedHistoryItem && (
                            <div className="fixed inset-0 z-[110] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
                                <div className="bg-white w-full max-w-md rounded-3xl shadow-xl overflow-hidden animate-fade-in relative flex flex-col max-h-[90vh]">
                                    <div className="h-2 bg-gradient-to-r from-gray-400 to-gray-600 flex-shrink-0"></div>
                                    <button onClick={() => setSelectedHistoryItem(null)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600 z-10"><Icons.Cross size={24}/></button>
                                    
                                    <div className="p-6 text-center space-y-4 flex-1 overflow-y-auto flex flex-col justify-center">
                                        <div className="flex-shrink-0"><span className="bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-xs font-bold tracking-wide">HISTORY TICKET</span><h1 className="text-6xl sm:text-7xl font-black text-slate-800 mt-4 tracking-tighter">{selectedHistoryItem.number}</h1></div>
                                        
                                        <div className="bg-slate-50 rounded-2xl p-4 border border-slate-100 space-y-2 flex-shrink-0">
                                            <div className="flex justify-between items-center text-sm pt-1">
                                                <span className="text-slate-400">วันที่จอง</span>
                                                <span className="font-bold text-slate-700">{selectedHistoryItem.date} {selectedHistoryItem.time}</span>
                                            </div>
                                            <div className="flex justify-between items-center text-sm pt-1">
                                                <span className="text-slate-400">ชื่อผู้จอง</span>
                                                <span className="font-bold text-slate-700 truncate max-w-[150px]">{selectedHistoryItem.name || '-'}</span>
                                            </div>

                                            {/* NEW: External Link Button (Only when Completed) */}
                                            {externalLinkEnabled && selectedHistoryItem.status === 'completed' && (
                                                <div className="pt-2 mt-2 border-t border-slate-200">
                                                    <button 
                                                        onClick={() => handleOpenExternalLink(externalLinkMapping, selectedHistoryItem.number, true)} 
                                                        className="w-full py-3 bg-blue-600 border border-blue-700 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center gap-2 font-bold text-sm transition-colors shadow-md"
                                                    >
                                                        <Icons.Folder size={18} /> {externalLinkLabel || 'เปิดเอกสาร / โฟลเดอร์คิว'}
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                        
                                        <button onClick={() => setSelectedHistoryItem(null)} className="w-full bg-slate-100 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-200 mt-4">ปิดหน้าต่าง</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* QR Modal Overlay */}
                        {showMyQR && (
                            <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
                                 <div className="bg-white p-6 rounded-2xl w-full max-w-sm relative text-center shadow-2xl">
                                     <button onClick={() => setShowMyQR(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icons.Cross size={24}/></button>
                                     <h3 className="text-xl font-bold text-slate-800 mb-2">QR Code ของคุณ</h3>
                                     <p className="text-slate-500 text-sm mb-6">สแกนเพื่อติดตามสถานะคิวบนมือถือ</p>
                                     <div className="bg-slate-100 p-4 rounded-xl inline-block mb-6">
                                         <img src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${myQueue.id}`} alt="QR Code" className="w-48 h-48 mix-blend-multiply mx-auto" />
                                     </div>
                                     <button onClick={() => setShowMyQR(false)} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700">ปิดหน้าต่าง</button>
                                 </div>
                            </div>
                        )}
                    </div>
                );
            }

            // ===============================================
            // DISPLAY MODE LOGIC (Restored old 2-column layout)
            // ===============================================

            const displayQueues = queues.filter(q => q.status === 'serving' || q.status === 'waiting');
            const currentDisplayServing = displayQueues.find(q => q.status === 'serving');
            // Filter out the serving queue from the waiting list, sort by createdAt (oldest first) and take the first 7
            const waitingForDisplay = displayQueues
                .filter(q => q.status === 'waiting' && q.id !== currentDisplayServing?.id)
                .sort((a, b) => a.createdAt - b.createdAt)
                .slice(0, 7); 
            
            // Note: qrCodeData generation is now global (line ~1088)

            if (viewMode === 'display') {
                
                // ----------------------------------------------------
                // START: NEW UI for "ปิดให้บริการ" (If no queues AND service is closed)
                // ----------------------------------------------------
                const isSystemClosed = !serviceOpen || (currentDisplayServing === undefined && waitingForDisplay.length === 0);
                
                if (isSystemClosed && !serviceOpen) {
                    return (
                        <div className="h-screen w-screen bg-slate-900 text-white p-8 flex flex-col items-center justify-center overflow-hidden">
                            {/* FIXED 1: ปรับ div หลักให้เป็น flex และจัดเนื้อหาให้อยู่กึ่งกลาง (justify-center) */}
                            <div className="text-center w-full max-w-4xl flex flex-col items-center justify-center h-full"> 
                                <div className="text-5xl font-black mb-8 text-red-500 flex items-center justify-center gap-4">
                                    <Icons.Power size={60} className="text-red-500 animate-pulse"/>
                                    ระบบปิดให้บริการชั่วคราว
                                </div>
                                <div className="text-[12rem] md:text-[18rem] font-black leading-none tracking-tight text-red-700/50 mb-10">
                                    CLOSED
                                </div>
                                {/* FIXED 2: ใช้ mx-auto เพื่อจัด span ให้อยู่กึ่งกลาง แต่ไม่ต้องเพิ่ม div หุ้ม */}
                                <span className="text-4xl md:text-5xl font-bold block text-white mx-auto">
                                    {closedReason || 'ปิดให้บริการเพื่อปรับปรุงระบบ'}
                                </span>
                                <div className="mt-8 text-2xl md:text-3xl text-red-300 font-bold">
                                    กรุณาติดต่อช่องบริการในภายหลัง
                                </div>
                            </div>
                            <div className="absolute bottom-4 left-4 text-xs text-slate-500">Q-Master Display Mode</div>
                        </div>
                    );
                }
                // ----------------------------------------------------
                // END: NEW UI for "ปิดให้บริการ"
                // ----------------------------------------------------
                
                 return (
                    // FIXED: 1. เปลี่ยน min-h-screen เป็น h-screen และเพิ่ม flex-col
                    <div className="h-screen bg-slate-900 text-white p-4 sm:p-8 flex flex-col w-full overflow-hidden">
                        
                        {/* FIXED: 2. ส่วนหัว ถูกย้ายมาอยู่ด้านบนสุดและใช้พื้นที่คงที่ (flex-shrink-0) */}
                        {/* FIXED: ใช้ max-w-full เพื่อให้ยืดเต็มจอ */}
                        <div className="w-full max-w-full mx-auto px-0 flex-shrink-0 text-center mb-4 sm:mb-6">
                            <h1 className="text-4xl sm:text-6xl font-black mb-2 text-indigo-400">ระบบแสดงคิวบริการ</h1>
                            <p className="text-xl text-slate-400">Queue & Calling Display</p>
                        </div>
                        
                        {/* FIXED: 3. Layout: ใช้ flex-1 และ gap-6 เพื่อให้ขยายเต็มพื้นที่ที่เหลือ และใช้ max-w-full */}
                        <div className="flex-1 w-full max-w-full mx-auto flex flex-col lg:flex-row gap-4 sm:gap-6 overflow-hidden"> 
                            
                            {/* LEFT COLUMN: CALLING NOW SECTION (เน้นใหญ่) */}
                            {/* FIXED: ให้ใช้พื้นที่ 2/3 (lg:w-2/3) และขยายความสูงเต็ม (h-full) */}
                            <div className="w-full lg:w-2/3 bg-gradient-to-br from-indigo-700 to-purple-800 rounded-3xl shadow-2xl flex flex-col items-center justify-center text-white relative overflow-hidden p-6 sm:p-10 h-full"> 
                                {!audioEnabled && (
                                    <button onClick={handleEnableAudio} className="absolute top-4 right-4 bg-white/20 px-4 py-2 rounded-full text-sm flex gap-2 z-50 hover:bg-white/30 transition-all">
                                        <Icons.Volume size={16}/> คลิกเพื่อเปิดเสียงพูด
                                    </button>
                                )}
                                
                                <div className="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl transform translate-x-1/2 -translate-y-1/2"></div>
                                
                                {/* FIXED 1: Dynamic Title based on service status (Removed serviceOpen check here as it's now handled by the outer block) */}
                                <h2 className="text-2xl sm:text-3xl font-medium text-indigo-200 mb-8 uppercase tracking-widest">
                                     หมายเลขคิวปัจจุบัน
                                </h2>
                                
                                {/* FIXED 1: Logic Block - Current Serving Queue UI */}
                                {currentDisplayServing ? (
                                    <div className="text-center w-full"> 
                                        {/* แก้ไข 1.1: ลดขนาดหมายเลขคิว */}
                                        <div className="text-7xl md:text-[8rem] lg:text-[12rem] font-black leading-none tracking-normal drop-shadow-lg text-white">
                                            {currentDisplayServing.number}
                                        </div>
                                        {/* แก้ไขตาม Request 1: เปลี่ยน py-3 ให้เป็น py-4 เพื่อเพิ่ม Padding บนล่าง */}
                                        <div className="mt-8 bg-white/20 backdrop-blur-md px-6 py-4 rounded-full inline-block mx-auto max-w-full">
                                            {/* แก้ไข 1.2: ลบ display-name-nowrap เพื่อไม่ให้ตัดชื่อ */}
                                            <span className="text-3xl md:text-5xl font-bold block whitespace-nowrap overflow-hidden text-ellipsis">คุณ {currentDisplayServing.name}</span>
                                        </div>
                                        <div className="mt-10 text-2xl md:text-4xl text-indigo-200 font-bold animate-pulse">เชิญเข้ารับบริการ</div>
                                    </div>
                                ) : (
                                    <div className="text-center opacity-40">
                                        <div className="text-8xl md:text-9xl font-black">---</div>
                                        <div className="text-2xl mt-4 text-indigo-200">ไม่มีคิวเรียก (รอคิวถัดไป)</div>
                                    </div>
                                )}
                                
                                {/* Estimated Time for next queue (Display Mode: Target first waiting queue) */}
                                {aiQueueTimeEnabled && !currentDisplayServing && estimatedTimeSeconds !== null && (
                                    <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white/20 backdrop-blur-md px-4 py-2 rounded-xl text-center text-sm text-green-300 font-bold border border-white/30 animate-fade-in w-11/12 max-w-sm">
                                        <Icons.Time size={16} className="inline-block mr-1 text-green-300"/>
                                        คิวถัดไปคาดว่าจะใช้เวลา: {formatSecondsToMinutes(estimatedTimeSeconds)}
                                    </div>
                                )}
                            </div>
                            
                            {/* RIGHT COLUMN: WAITING QUEUES LIST */}
                            {/* FIXED: เพิ่ม relative เพื่อให้ QR Code ที่ absolute ใช้งานได้ */}
                            <div className="w-full lg:w-1/3 bg-slate-800 rounded-3xl shadow-xl flex flex-col overflow-hidden flex-shrink-0 lg:h-full relative">
                                
                                <div className="p-4 sm:p-6 bg-slate-700 border-b border-slate-600 font-bold text-slate-300 flex items-center justify-between flex-shrink-0">
                                    <div className="text-xl flex items-center gap-2">
                                        <Icons.Clock size={24} className="text-indigo-400" /> คิวถัดไป
                                    </div>
                                    <span className="text-md font-normal text-indigo-300">{waitingForDisplay.length} รายการ</span>
                                </div>
                                
                                {/* FIXED: ทำให้ส่วนนี้ scroll ได้และใช้ flex-1 */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scroll"> 
                                    {waitingForDisplay.length > 0 ? (
                                        waitingForDisplay.map((q, index) => {
                                            const isSkipped = q.skipCount > 0 || q.note;
                                            return (
                                            <div key={q.id} className="flex flex-col p-4 bg-slate-700 rounded-xl border border-slate-600 shadow-lg">
                                                
                                                {/* Line 1: Queue Number (Left) and Queue Count (Right) */}
                                                <div className="flex items-end justify-between">
                                                    {/* แก้ไข 1.3: ลดขนาดหมายเลขคิวที่รอคิว */}
                                                    <div className="text-2xl font-black text-indigo-300 whitespace-nowrap">{q.number}</div>
                                                    <div className="text-sm text-slate-500">{index + 1} คิวถัดไป</div>
                                                </div>
                                                
                                                {/* Line 2: Customer Name (Left) and Date/Time (Right) */}
                                                <div className="flex items-end justify-between mt-1 pb-1">
                                                    {/* แก้ไข 1.4: ลดขนาดชื่อลูกค้าที่รอคิว */}
                                                    <div className="text-base font-medium text-slate-400 whitespace-nowrap overflow-hidden text-ellipsis max-w-[70%]">{q.name}</div>
                                                    {/* FIXED: แสดงวันที่และเวลา */}
                                                    <span className="text-xs text-indigo-200 block font-medium flex-shrink-0">{formatDateTime(q.createdAt)}</span>
                                                </div>
                                                
                                                {/* Line 3: Note (Full Width with Divider) */}
                                                {(q.note || q.skipCount > 0) && (
                                                    // ใช้ flex-shrink-0 เพื่อให้แน่ใจว่าข้อความหมายเหตุจะไม่ถูกบีบ
                                                    // border-t border-slate-600 เพื่อสร้างเส้นแบ่งจางๆ
                                                    <div className="mt-2 pt-2 border-t border-slate-600 flex-shrink-0"> 
                                                        <span className="text-sm font-bold text-red-400 block break-words">
                                                            {/* FIXED: ใช้ break-words เพื่อให้ข้อความยาว ๆ ขึ้นบรรทัดใหม่ได้ */}
                                                            {q.note ? `หมายเหตุ: ${q.note}` : `ถูกข้าม (${q.skipCount} ครั้ง)`}
                                                        </span>
                                                    </div>
                                                )}
                                                
                                            </div>
                                            );
                                        })
                                    ) : (
                                        <div className="text-center py-10 text-slate-500">ไม่มีคิวรอเรียก</div>
                                    )}
                                </div>

                                {/* แก้ไข 3: พื้นหลัง QR Code แบบเบลอ (backdrop-blur) */}
                                {(qrEnabled || qrExpireEnabled) && (
                                    <div className="absolute bottom-0 right-0 p-4 z-10"> 
                                        {/* แก้ไข 3: เพิ่ม backdrop-blur, bg-white/85, rounded-xl */}
                                        <div className="backdrop-blur-sm bg-white/85 rounded-xl shadow-2xl p-3 text-center border border-white/90">
                                            
                                            {/* FIXED: ข้อความกำกับ (เปลี่ยนสีเป็น slate-800) */}
                                            <div className="text-xs font-bold text-slate-800 mb-1">สแกนเพื่อจองคิว</div>
                                            
                                            <img 
                                                // FIXED: ใช้ qrCodeData ที่ encodeURIComponent แล้ว
                                                src={`https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(qrCodeData)}`} 
                                                alt="Queue QR Code" 
                                                // ลบ mix-blend-lighten, opacity ออก
                                                className="w-24 h-24 sm:w-28 sm:h-28 rounded-md mx-auto" 
                                                key={qrToken} // Re-render image when token changes, even if expiration is off
                                            />
                                            
                                            {/* FIXED: แสดงสถานะการหมดอายุ (เปลี่ยนสีเป็น red-600) */}
                                            {qrEnabled && qrExpireEnabled && qrTokenExpiry && (
                                                <div className="text-[10px] text-red-600 mt-1 font-mono flex items-center justify-center">
                                                    <Icons.Clock size={10} className="inline-block mr-0.5"/> หมดอายุใน: {formatCountdown(qrCountdown)}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                                {/* END NEW QR CODE LOCATION */}

                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 pb-10 flex flex-col justify-start">
                    <Toast message={toast.message} type={toast.type} show={toast.show} />
                    
                    {/* Auto Recall Modal */}
                    {showAutoRecallModal && (
                        <div className="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in">
                                <h2 className="font-bold text-xl mb-4 text-indigo-900 flex items-center gap-2"><Icons.Repeat size={24}/> ตั้งค่าเรียกอัตโนมัติ</h2>
                                <div className="space-y-4 mb-6">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">จำนวนครั้งที่จะเรียกซ้ำ</label>
                                        <input 
                                            type="number" 
                                            min="1" max="10"
                                            value={autoRecallConfig.count}
                                            onChange={(e) => setAutoRecallConfig(prev => ({...prev, count: e.target.value}))}
                                            className="w-full border border-slate-200 rounded-xl px-4 py-3 text-lg text-center"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">ระยะห่างแต่ละครั้ง (วินาที)</label>
                                        <input 
                                            type="number" 
                                            min="7" max="60"
                                            value={autoRecallConfig.interval}
                                            onChange={(e) => setAutoRecallConfig(prev => ({...prev, interval: e.target.value}))}
                                            className="w-full border border-slate-200 rounded-xl px-4 py-3 text-lg text-center"
                                        />
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowAutoRecallModal(false)} className="flex-1 py-3 text-slate-500 hover:bg-slate-100 rounded-xl">ยกเลิก</button>
                                    <button onClick={() => startAutoRecall(currentServing.id)} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700">เริ่มทันที</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Close Reason Modal */}
                    {showCloseReasonModal && (
                        <div className="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in border-t-4 border-red-500">
                                <h2 className="font-bold text-xl mb-4 text-red-600 flex items-center gap-2"><Icons.Lock size={24}/> ปิดให้บริการ</h2>
                                <label className="block text-sm font-medium text-slate-700 mb-2">ระบุเหตุผลการปิด (แสดงที่หน้าลูกค้า)</label>
                                <input 
                                    ref={closeReasonInputRef}
                                    type="text" 
                                    value={tempClosedReason} 
                                    onChange={(e) => setTempClosedReason(e.target.value)} 
                                    onKeyDown={e => { if (e.key === 'Enter') confirmCloseService(); }}
                                    className="w-full border border-slate-200 rounded-xl px-4 py-3 text-lg outline-none focus:ring-2 focus:ring-red-500 transition-all mb-6" 
                                    placeholder="เช่น พักเที่ยง, ปิดปรับปรุง" 
                                />
                                <div className="flex gap-2">
                                    <button onClick={() => { setShowCloseReasonModal(false); }} className="flex-1 py-3 text-slate-500 hover:bg-slate-100 rounded-xl">ยกเลิก</button>
                                    <button onClick={confirmCloseService} className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold shadow-lg shadow-red-200 hover:bg-red-700">ยืนยันปิด</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Recall Wait Popup (Single Recall) */}
                    {showRecallWait && (
                        <div className="fixed inset-0 z-[90] bg-black/70 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl p-8 text-center max-w-sm w-full animate-bounce-slow shadow-2xl">
                                <div className="text-6xl font-black text-indigo-600 mb-4">{recallCountdown}</div>
                                <h2 className="text-xl font-bold text-slate-800">กรุณารอสักครู่...</h2>
                                <p className="text-slate-500 text-sm mt-2">ระบบกำลังเรียกคิว เพื่อป้องกันเสียงซ้อนกัน</p>
                            </div>
                        </div>
                    )}

                    <div className="bg-white border-b border-slate-200 sticky top-0 z-50 px-2 py-2 sm:px-4 sm:py-3 shadow-sm">
                        <div className="max-w-7xl mx-auto flex justify-between items-center gap-2">
                            <div className="flex items-center gap-2 font-bold text-xl text-indigo-900 flex-shrink-0">
                                <div className="bg-indigo-600 text-white w-8 h-8 rounded flex items-center justify-center">Q</div>
                                <span className="hidden md:inline">Q-Master Admin</span>
                            </div>
                            <div className="flex gap-1 bg-slate-100 p-1 rounded-lg flex-shrink-0">
                                <button onClick={() => setViewMode('admin')} className={`px-3 py-1.5 rounded-md text-xs sm:text-sm font-bold ${viewMode==='admin'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>Admin</button>
                                <button onClick={() => setViewMode('display')} className={`px-3 py-1.5 rounded-md text-xs sm:text-sm font-bold ${viewMode==='display'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>Display</button>
                            </div>
                            <div className="flex gap-1 sm:gap-2 flex-shrink-0">
                                <button onClick={() => setShowScanner(true)} className="p-2 text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-full flex-shrink-0 transition-colors"><Icons.Scan size={20} className="sm:w-6 sm:h-6"/></button>
                                <button onClick={() => setShowSettings(true)} className="p-2 text-slate-500 hover:bg-slate-100 rounded-full flex-shrink-0"><Icons.Settings size={20} className="sm:w-6 sm:h-6"/></button>
                                <div className="relative group">
                                    <button onClick={openKioskLink} className="flex items-center gap-2 bg-indigo-600 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-indigo-700 transition-colors"><Icons.Link size={16}/> <span className="hidden sm:inline">Kiosk Link</span></button>
                                    <button 
                                        onClick={openQROnlyLink} 
                                        className="absolute top-full mt-1 right-0 w-44 bg-slate-700 text-white text-xs p-2 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50"
                                    >
                                        ลิงค์ QR Code สำหรับฝัง
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <main className="max-w-7xl mx-auto p-4 md:p-6 w-full">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-2 space-y-6">
                                {/* ส่วน Calling ที่แก้ไขแล้ว */}
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                                        {/* แก้ไข Icon Color เป็น text-indigo-600 */}
                                        <h2 className="font-semibold text-lg text-black mb-0 flex items-center gap-2">
                                            <Icons.Monitor className="w-5 h-5 text-indigo-600 overflow-visible" /> Calling
                                        </h2>
                                    </div>
                                    
                                    {currentServing ? (
                                        <div className="flex flex-col md:flex-row items-center justify-between gap-6 bg-indigo-50 rounded-xl p-6 border border-indigo-100">
                                            <div className="text-center md:text-left flex-shrink-0">
                                                <div className="text-xs font-bold text-indigo-400 uppercase">Serving Now</div>
                                                <div className="text-5xl font-black text-slate-800 mt-1 mb-2 whitespace-nowrap">{currentServing.number}</div>
                                                <div className="text-xl font-medium text-slate-600 whitespace-nowrap">คุณ {currentServing.name}</div>
                                            </div>
                                            <div className="flex flex-col gap-2 w-full md:w-auto md:ml-auto">
                                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                                    <div className="flex gap-1">
                                                        <button onClick={() => handleRecall(currentServing.id)} className="flex-1 flex items-center justify-center gap-1 bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-3 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all whitespace-nowrap"><Icons.Volume size={18}/> เรียก</button>
                                                        <button onClick={() => setShowAutoRecallModal(true)} className="flex items-center justify-center bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-2 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all" title="เรียกซ้ำอัตโนมัติ"><Icons.Repeat size={18}/></button>
                                                    </div>
                                                    <button onClick={(e) => { e.preventDefault(); openSkipPopup(currentServing); }} className="flex items-center justify-center gap-1 bg-amber-100 text-amber-700 hover:bg-amber-200 px-3 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all whitespace-nowrap"><Icons.Skip size={18}/> ข้าม</button>
                                                    <button onClick={() => updateStatus(currentServing.id, 'cancelled')} className="flex items-center justify-center gap-1 bg-white border border-red-200 text-red-500 hover:bg-red-50 px-3 py-2 rounded-xl font-bold text-sm active:scale-95 transition-all whitespace-nowrap"><Icons.Cross size={18}/> ยกเลิก</button>
                                                </div>
                                                {/* Pass Date.now() when status changes to 'completed' */}
                                                <button onClick={() => updateStatus(currentServing.id, 'completed', Date.now())} className="w-full flex items-center justify-center gap-2 bg-green-500 text-white px-4 py-2 rounded-xl font-bold text-lg shadow-lg shadow-green-200 hover:bg-green-600 active:scale-95 transition-all"><Icons.Check/> เสร็จสิ้น</button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="border-2 border-dashed border-slate-200 rounded-xl p-10 text-center text-slate-400">ไม่มีคิวรอเรียก</div>
                                    )}
                                </div>

                                {/* ส่วน Waiting ที่แก้ไขแล้ว */}
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                    <div className="p-6 border-b border-slate-100 h-16 flex justify-between items-center">
                                        {/* แก้ไข Icon Color เป็น text-indigo-600 */}
                                        <h2 className="font-semibold text-lg text-black mb-0 flex items-center gap-2">
                                            <Icons.Clock className="w-5 h-5 text-indigo-600" /> Waiting ({queues.filter(q => q.status === 'waiting').length})
                                        </h2>
                                    </div>
                                    <div className="divide-y divide-slate-50">
                                        {queues.filter(q => q.status === 'waiting').length > 0 ? queues.filter(q => q.status === 'waiting').map((q) => (
                                            <div key={q.id} className="p-4 flex flex-col sm:flex-row items-center justify-between hover:bg-slate-50 gap-4">
                                                <div className="flex items-center gap-4 w-full sm:w-auto">
                                                    <div className="w-14 h-14 bg-slate-100 rounded-lg flex-shrink-0 flex items-center justify-center font-bold text-xl text-slate-600">{q.number}</div>
                                                    <div>
                                                        <div className="font-bold text-slate-800 text-lg">{q.name}</div>
                                                        <div className="text-xs text-slate-400">
                                                            {/* FIXED: Show date and time from createdAt */}
                                                            <span className="block">{formatDateTime(q.createdAt)}</span>
                                                            {/* FIXED: Check if note exists OR skipCount > 0 and display red text */}
                                                            {(q.note || q.skipCount > 0) && (
                                                                <span className="text-red-500 font-bold bg-red-50 px-1 rounded block mt-0.5">
                                                                    {q.note ? `หมายเหตุ: ${q.note}` : `ถูกข้าม (${q.skipCount} ครั้ง)`}
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2 w-full sm:w-auto mt-2 sm:mt-0">
                                                    <button onClick={() => updateStatus(q.id, 'serving')} disabled={!!currentServing} className={`flex-1 sm:flex-none flex items-center justify-center gap-2 px-6 py-2 rounded-lg font-bold text-sm shadow-sm ${currentServing ? 'bg-slate-100 text-slate-400' : 'bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95'}`}>
                                                        <Icons.Bell size={18}/> เรียกคิว
                                                    </button>
                                                </div>
                                            </div>
                                        )) : <div className="p-10 text-center text-slate-400">ไม่มีคิวรอเรียก</div>}
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 sticky top-24">
                                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wide mb-4">ภาพรวมวันนี้ (กดเพื่อดูประวัติ)</h3>
                                    <div className="space-y-3">
                                        <button onClick={() => setShowHistory('all')} className="w-full flex justify-between items-center p-4 bg-slate-50 hover:bg-slate-100 rounded-xl transition-colors">
                                            <span className="text-slate-600 font-medium">ทั้งหมด</span>
                                            <span className="text-2xl font-black text-slate-800">{queues.length}</span>
                                        </button>
                                        <button onClick={() => setShowHistory('completed')} className="w-full flex justify-between items-center p-4 bg-green-50 hover:bg-green-100 rounded-xl transition-colors text-green-700"><span className="font-medium flex items-center gap-2"><Icons.History size={16}/> เสร็จสิ้น</span><span className="text-2xl font-black">{queues.filter(q => q.status==='completed').length}</span></button>
                                        <button onClick={() => setShowHistory('cancelled')} className="w-full flex justify-between items-center p-4 bg-red-50 hover:bg-red-100 rounded-xl transition-colors text-red-700"><span className="font-medium flex items-center gap-2"><Icons.History size={16}/> ยกเลิก</span><span className="text-2xl font-black">{queues.filter(q => q.status==='cancelled').length}</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>

                    {showScanner && (
                        <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-[70]">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl animate-fade-in relative">
                                <button onClick={() => setShowScanner(false)} className="absolute top-2 right-2 text-slate-400 hover:text-slate-600"><Icons.Cross size={24}/></button>
                                <h2 className="font-bold text-xl mb-4 text-center">สแกน QR Code</h2>
                                <div id="reader" className="w-full bg-slate-100 rounded-lg overflow-hidden min-h-[300px]"></div>
                                <p className="text-xs text-center text-slate-400 mt-2">วาง QR Code ให้อยู่ในกรอบ</p>
                            </div>
                        </div>
                    )}

                    {showScannedAction && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[80]">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in">
                                <h2 className="font-bold text-2xl mb-1 text-indigo-600">{showScannedAction.queue.number}</h2>
                                <p className="text-slate-500 mb-6 font-medium">คุณ {showScannedAction.queue.name}</p>
                                
                                <div className="grid grid-cols-2 gap-3">
                                    {showScannedAction.queue.status === 'waiting' && (
                                        <>
                                            <button onClick={() => updateStatus(showScannedAction.queue.id, 'serving')} className="col-span-2 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">เรียกคิว</button>
                                            <button onClick={() => openSkipPopup(showScannedAction.queue)} className="py-3 bg-amber-100 text-amber-700 rounded-xl font-bold hover:bg-amber-200">ข้าม</button>
                                            <button onClick={() => updateStatus(showScannedAction.queue.id, 'cancelled')} className="py-3 bg-red-50 text-red-600 rounded-xl font-bold hover:bg-red-100">ยกเลิก</button>
                                        </>
                                    )}
                                    {showScannedAction.queue.status === 'serving' && (
                                        <>
                                            <button onClick={() => updateStatus(showScannedAction.queue.id, 'completed', Date.now())} className="col-span-2 py-3 bg-green-500 text-white rounded-xl font-bold hover:bg-green-600">เสร็จสิ้น</button>
                                            <button onClick={() => handleRecall(showScannedAction.queue.id)} className="py-3 bg-indigo-100 text-indigo-700 rounded-xl font-bold hover:bg-indigo-200">เรียกซ้ำ</button>
                                            <button onClick={() => openSkipPopup(showScannedAction.queue)} className="py-3 bg-amber-100 text-amber-700 rounded-xl font-bold hover:bg-amber-200">ข้าม</button>
                                        </>
                                    )}
                                    {(showScannedAction.queue.status === 'completed' || showScannedAction.queue.status === 'cancelled') && (
                                        <button onClick={() => handleRecall(showScannedAction.queue.id)} className="col-span-2 py-3 bg-indigo-100 text-indigo-700 rounded-xl font-bold hover:bg-indigo-200">เรียกคิวอีกครั้ง</button>
                                    )}
                                </div>
                                <button onClick={() => setShowScannedAction(null)} className="mt-4 text-slate-400 text-sm underline">ปิดหน้าต่าง</button>
                            </div>
                        </div>
                    )}

                    {showSkipPopup && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in">
                                <h2 className="font-bold text-xl mb-4 text-amber-600 flex items-center gap-2"><Icons.Skip size={24}/> ข้ามคิว {queueToSkip?.number}</h2>
                                <label className="block text-sm font-medium text-slate-700 mb-2">ระบุหมายเหตุการข้าม</label>
                                <input 
                                    ref={skipInputRef}
                                    type="text" 
                                    value={skipNote} 
                                    onChange={e => setSkipNote(e.target.value)} 
                                    onKeyDown={e => { if (e.key === 'Enter') handleConfirmSkip(); }}
                                    className="w-full border border-slate-200 rounded-xl px-4 py-3 text-lg outline-none focus:ring-2 focus:ring-amber-500 transition-all mb-4" 
                                    placeholder="เช่น ไม่พร้อม, เข้าห้องน้ำ" 
                                />
                                
                                {savedNotes.length > 0 && (
                                    <div className="mb-4">
                                        <div className="text-xs text-slate-400 mb-2">เลือกข้อความเดิม:</div>
                                        <div className="flex flex-wrap gap-2">
                                            {savedNotes.map((note, idx) => (
                                                <button key={idx} onClick={() => setSkipNote(note)} className="text-xs bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded-md text-slate-600 transition-colors">
                                                    {note}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                <div className="flex gap-2">
                                    <button onClick={() => setShowSkipPopup(false)} className="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-xl">ยกเลิก</button>
                                    <button onClick={handleConfirmSkip} className="flex-1 py-2 bg-amber-500 text-white rounded-xl font-bold hover:bg-amber-600">ยืนยันข้าม</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showSettings && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            {/* FIXED: จำกัดความสูงของ Modal Container */}
                            <div className="bg-white rounded-3xl w-full max-w-md shadow-2xl animate-fade-in flex flex-col max-h-[90vh] h-[90dvh] overflow-hidden ring-1 ring-black/5">
                                <div className="p-6 border-b border-slate-100 bg-white z-10 flex-shrink-0">
                                    <h2 className="font-bold text-lg text-slate-800">ตั้งค่าระบบ</h2>
                                </div>
                                
                                <div className="p-6 overflow-y-auto custom-scroll space-y-6 bg-white flex-1">
                                    {/* Service Toggle */}
                                    <div className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                        <div className="flex items-center gap-3">
                                            {/* FIXED: แก้ไข string constant ที่ขาดหายไป */}
                                            <div className={`p-2.5 rounded-xl ${serviceOpen ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                                <Icons.Power size={20} />
                                            </div>
                                            <div className="text-left">
                                                <div className="text-sm font-bold text-slate-800">สถานะบริการ</div>
                                                <div className={`text-xs font-medium ${serviceOpen ? 'text-green-600' : 'text-red-500'}`}>
                                                    {serviceOpen ? 'เปิดให้บริการ' : 'ปิดให้บริการ'}
                                                </div>
                                            </div>
                                        </div>
                                        <ToggleSwitch checked={serviceOpen} onChange={handleServiceToggle} />
                                    </div>

                                    {/* FIXED: เพิ่มช่องแก้ไขเหตุผลเมื่อปิดให้บริการ (ใช้ TempEditState) */}
                                    {!serviceOpen && (
                                        <div className="bg-red-50 rounded-2xl p-4 border border-red-100 animate-fade-in space-y-3">
                                            <label className="block text-xs font-bold text-red-700 mb-2 ml-1">แก้ไขเหตุผลการปิดให้บริการ</label>
                                            <input 
                                                type="text" 
                                                value={tempEditClosedReason} 
                                                onChange={e => setTempEditClosedReason(e.target.value)} 
                                                onKeyDown={e => { if (e.key === 'Enter') handleSaveClosedReason(tempEditClosedReason); }}
                                                className="w-full border border-red-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-red-500" 
                                                placeholder="เหตุผลการปิดให้บริการ" 
                                            />
                                            {/* FIXED: เพิ่มปุ่มบันทึกสำหรับเหตุผล พร้อม Logic สีปุ่ม */}
                                            {/* ตรวจสอบว่าค่าปัจจุบัน (tempEditClosedReason) แตกต่างจากค่าที่บันทึกใน Firestore (closedReason) หรือไม่ */}
                                            {(() => {
                                                const isUnsaved = tempEditClosedReason !== closedReason;
                                                const buttonClass = isUnsaved 
                                                    ? 'bg-red-600 text-white hover:bg-red-700 shadow-lg shadow-red-200' 
                                                    : 'bg-slate-300 text-slate-600 cursor-default';
                                                
                                                return (
                                                    <button 
                                                        onClick={() => isUnsaved && handleSaveClosedReason(tempEditClosedReason)} 
                                                        disabled={!isUnsaved}
                                                        className={`w-full py-2 rounded-lg font-bold transition-all text-sm mt-2 ${buttonClass}`}
                                                    >
                                                        <Icons.Check size={16} className="inline-block mr-2"/> {isUnsaved ? 'บันทึกเหตุผล' : 'บันทึกแล้ว'}
                                                    </button>
                                                );
                                            })()}
                                        </div>
                                    )}
                                    
                                    <div>
                                        <label className="block text-xs font-bold text-slate-700 mb-2 ml-1">ตัวอักษรนำหน้าคิว (Prefix)</label>
                                        <input type="text" value={queuePrefix || ''} onChange={e => setQueuePrefix(e.target.value.toUpperCase())} className="w-full border border-slate-200 rounded-xl px-4 py-3 text-center text-xl font-bold uppercase focus:ring-2 focus:ring-indigo-500 outline-none transition-all bg-slate-50" maxLength={2} />
                                    </div>
                                    
                                    {/* --- NEW: Admin Session Duration Setting Input (Request 2) --- */}
                                    <div className="bg-slate-50 rounded-2xl p-4 border border-slate-100">
                                        <h3 className="text-sm font-bold text-slate-700 flex items-center gap-3 mb-2">
                                            <Icons.Lock size={20} className="text-slate-400"/> ระยะเวลา Admin Session
                                        </h3>
                                        <label className="block text-xs font-bold text-slate-500 mb-1 ml-1">Admin Session หมดอายุใน (นาที)</label>
                                        <input 
                                            type="number" 
                                            min="1" 
                                            value={adminSessionDuration} 
                                            onChange={e => setAdminSessionDuration(Math.max(1, parseInt(e.target.value) || 1))} 
                                            className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500" 
                                            placeholder="60" 
                                        />
                                        <p className="text-[10px] text-slate-400 mt-1">
                                            เมื่อหมดเวลา ต้องใส่รหัสผ่านใหม่เมื่อรีเฟรชหน้าเว็บ
                                        </p>
                                    </div>
                                    {/* --- END NEW: Admin Session Duration Setting Input --- */}

                                    {/* --- NEW: AI Queue Time Estimation Setting (Request 3) --- */}
                                    <div className="bg-green-50 rounded-2xl p-4 border border-green-100 space-y-4">
                                        <div className="flex items-center justify-between">
                                            <h3 className="text-sm font-bold text-green-700 flex items-center gap-3">
                                                <Icons.Time size={20} className="text-green-500"/> คาดการณ์เวลาคิว (AI Time)
                                            </h3>
                                            <ToggleSwitch checked={aiQueueTimeEnabled} onChange={() => setAiQueueTimeEnabled(!aiQueueTimeEnabled)} />
                                        </div>
                                        {aiQueueTimeEnabled && (
                                            <div className="mt-4 space-y-3 border-t border-green-200 pt-4 animate-fade-in">
                                                <div>
                                                    <label className="block text-xs font-bold text-green-700 mb-1 ml-1">จำนวนคิวที่ใช้คำนวณย้อนหลัง (Limit)</label>
                                                    <input 
                                                        type="number" 
                                                        min="3" 
                                                        value={aiQueueTimeHistoryLimit} 
                                                        onChange={e => setAiQueueTimeHistoryLimit(Math.max(3, parseInt(e.target.value) || 3))} 
                                                        className="w-full border border-green-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-green-500" 
                                                        placeholder="5" 
                                                    />
                                                    <p className="text-[10px] text-green-600 mt-1">ใช้ประวัติ {aiQueueTimeHistoryLimit} คิวล่าสุดที่เสร็จสิ้นเพื่อหาค่าเฉลี่ยเวลาให้บริการ</p>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    {/* --- END NEW: AI Queue Time Estimation Setting --- */}
                                    
                                    <div className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                        <span className="text-sm font-bold text-slate-700 flex items-center gap-3"><Icons.QrCode size={20} className="text-slate-400"/> ระบบ QR Code</span>
                                        <ToggleSwitch checked={qrEnabled} onChange={() => setQrEnabled(!qrEnabled)} />
                                    </div>

                                    {/* QR Expiration Settings (NEW) */}
                                    <div className="bg-slate-50 rounded-2xl p-4 border border-slate-100">
                                        <div className="flex items-center justify-between mb-4">
                                            <span className="text-sm font-bold text-slate-700 flex items-center gap-3"><Icons.Clock size={20} className="text-slate-400"/> QR Code มีอายุ/เปลี่ยนใหม่</span>
                                            <ToggleSwitch checked={qrExpireEnabled} onChange={() => setQrExpireEnabled(!qrExpireEnabled)} />
                                        </div>
                                        {qrExpireEnabled && (
                                            <div className="mt-4 space-y-3 border-t border-slate-200 pt-4 animate-fade-in">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1 ml-1">เปลี่ยน QR Code ทุก (นาที)</label>
                                                    <input 
                                                        type="number" 
                                                        min="1" 
                                                        value={qrExpireTime} 
                                                        onChange={e => setQrExpireTime(Math.max(1, parseInt(e.target.value) || 1))} 
                                                        className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500" 
                                                        placeholder="5" 
                                                    />
                                                </div>
                                                <button 
                                                    onClick={() => updateQrTokenInFirestore(generateUniqueToken(), qrExpireTime, true)} 
                                                    className="w-full py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors text-sm"
                                                >
                                                    สร้าง QR Code ใหม่ทันที
                                                </button>
                                                {qrEnabled && qrTokenExpiry && (
                                                     <div className="text-xs text-slate-500 text-center">
                                                         QR Code จะหมดอายุใน: {formatCountdown(qrCountdown)}
                                                     </div>
                                                )}
                                            </div>
                                        )}
                                    </div>

                                    {/* History Toggle */}
                                    <div className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                        <span className="text-sm font-bold text-slate-700 flex items-center gap-3"><Icons.History size={20} className="text-slate-400"/> ประวัติการจองลูกค้า</span>
                                        <ToggleSwitch checked={historyEnabled} onChange={() => setHistoryEnabled(!historyEnabled)} />
                                    </div>

                                    {/* External Link Toggle (Simplified UI) */}
                                    <div className="bg-slate-50 rounded-2xl p-4 border border-slate-100">
                                        <div className="flex items-center justify-between mb-4">
                                            <span className="text-sm font-bold text-slate-700 flex items-center gap-3"><Icons.Folder size={20} className="text-slate-400"/> ระบบลิ้งค์เอกสาร</span>
                                            <ToggleSwitch checked={externalLinkEnabled} onChange={() => setExternalLinkEnabled(!externalLinkEnabled)} />
                                        </div>
                                        
                                        {externalLinkEnabled && (
                                            <div className="mt-4 space-y-4 border-t border-slate-200 pt-4 animate-fade-in">
                                                
                                                {/* 1. Master Link Title */}
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1 ml-1">ชื่อลิ้งค์ / โฟลเดอร์</label>
                                                    <input 
                                                        type="text" 
                                                        value={masterLinkTitle || ''} 
                                                        onChange={e => setMasterLinkTitle(e.target.value)} 
                                                        className="w-full border border-slate-200 rounded-lg px-3 py-2 text-xs outline-none focus:ring-2 focus:ring-indigo-500" 
                                                        placeholder="เช่น โฟลเดอร์คิวลูกค้าวันนี้" 
                                                    />
                                                </div>

                                                {/* --- 2. C1 LINK INPUT --- */}
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1 ml-1">ลิ้งค์</label>
                                                    <div className="flex gap-2">
                                                        <input 
                                                            type="url" 
                                                            value={masterLinkC1 || ''} 
                                                            onChange={e => {setMasterLinkC1(e.target.value); setSendSuccess(false);}} // Reset success state on change
                                                            className="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-xs outline-none focus:ring-2 focus:ring-indigo-500" 
                                                            placeholder="เช่น https://drive.google.com/..." 
                                                        />
                                                        
                                                        {/* Conditional Send Button */}
                                                        {isGoogleDriveLink(masterLinkC1) && (
                                                            <button 
                                                                onClick={() => handleSaveToGAS(masterLinkC1, masterLinkTitle)}
                                                                disabled={isGasSending || (sendSuccess && masterLinkC1 === lastSentLink)}
                                                                className={`flex-shrink-0 py-2 px-3 rounded-lg text-xs font-bold transition-colors w-[100px] flex items-center justify-center gap-1 ${
                                                                    isGasSending ? 'bg-slate-400 text-white cursor-not-allowed' :
                                                                    (sendSuccess && masterLinkC1 === lastSentLink) ? 'bg-green-500 text-white cursor-default' :
                                                                    'bg-green-500 hover:bg-green-600 text-white'
                                                                }`}
                                                            >
                                                                {isGasSending ? <><Icons.Loader size={12}/> กำลังส่ง...</> : 
                                                                (sendSuccess && masterLinkC1 === lastSentLink) ? <><Icons.Check size={12}/> ส่งเรียบร้อย</> : 'ส่งลิ้งค์'}
                                                            </button>
                                                        )}
                                                    </div>
                                                    <p className="text-[10px] text-slate-400 mt-1">ลิ้งค์นี้จะถูกส่งไปที่คอลัมน์ C1 ใน Google Sheet (หากระบุ GAS URL)</p>
                                                </div>
                                                {/* --- END C1 LINK INPUT --- */}
                                                
                                                {/* 3. GAS Web App URL (Conditional Visibility) */}
                                                {isGoogleDriveLink(masterLinkC1) && (
                                                    <div className="animate-fade-in">
                                                        <label className="block text-xs font-bold text-slate-500 mb-1 ml-1 flex items-center gap-1"><Icons.GoogleScript size={12}/> Google Apps Script URL (Web App) (อ่าน/ส่ง)</label>
                                                        <input 
                                                            type="text" 
                                                            value={gasWebAppUrl || ''} 
                                                            onChange={e => setGasWebAppUrl(e.target.value)} 
                                                            className="w-full border border-slate-200 rounded-xl px-3 py-2 text-xs focus:ring-2 focus:ring-indigo-500 outline-none transition-all" 
                                                            placeholder="https://script.google.com/..." 
                                                        />
                                                        <p className="text-[10px] text-slate-400 mt-1">ใช้สำหรับดึงลิ้งค์ (A-B) และส่งลิ้งค์ (C1)</p>
                                                    </div>
                                                )}

                                                {/* 4. Link Button Label */}
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1 ml-1">ข้อความบนปุ่มลิ้งค์</label>
                                                    <input 
                                                        type="text" 
                                                        value={externalLinkLabel || ''} 
                                                        onChange={e => setExternalLinkLabel(e.target.value)} 
                                                        className="w-full border border-slate-200 rounded-xl px-3 py-2 text-xs focus:ring-2 focus:ring-indigo-500 outline-none transition-all" 
                                                        placeholder="เปิดเอกสาร" 
                                                    />
                                                </div>

                                                {/* 5. Link Test (Keep the test functionality) */}
                                                <div className="flex gap-2 items-center">
                                                    <input 
                                                        type="text" 
                                                        value={testQueueId} 
                                                        onChange={(e) => setTestQueueId(e.target.value.toUpperCase())}
                                                        placeholder="เลขคิวทดสอบ (เช่น A-001)"
                                                        className="flex-1 border border-slate-200 rounded-lg px-3 py-1.5 text-xs"
                                                    />
                                                    <button 
                                                        onClick={testLinkMapping}
                                                        className="bg-blue-100 text-blue-600 hover:bg-blue-200 px-3 py-1.5 rounded-lg text-xs font-bold transition-colors"
                                                    >
                                                        ทดสอบลิ้งค์
                                                    </button>
                                                </div>
                                                
                                                {/* Auto-Sync Status Display */}
                                                <div className="bg-white p-3 rounded-xl border border-slate-200 text-center space-y-2">
                                                    <div className="flex items-center justify-center gap-2">
                                                        {/* START: Centered, with Loader Icon */}
                                                        {externalLinkEnabled && gasWebAppUrl && (
                                                            <Icons.Sync size={16} className="text-amber-500 animate-spin" />
                                                        )}
                                                        <h4 className="text-sm font-bold text-indigo-700">
                                                            สถานะการอ่านลิ้งค์จาก Sheet (A-B)
                                                        </h4>
                                                        {/* END: Centered, with Loader Icon */}
                                                        
                                                        {/* NEW: Button to view data table */}
                                                        {externalLinkMapping && (
                                                            <button 
                                                                onClick={() => setShowLinkDataModal(true)} 
                                                                className="ml-auto p-1 text-slate-500 hover:text-indigo-600 hover:bg-slate-100 rounded-full transition-colors"
                                                                title="ดูข้อมูลที่ดึงมาทั้งหมด"
                                                            >
                                                                <Icons.Sheet size={18} />
                                                            </button>
                                                        )}
                                                    </div>
                                                    
                                                    {/* NEW: Display Last Sync Time */}
                                                    <p className="text-xs text-slate-600">
                                                        ดึงข้อมูลล่าสุด: <span className={`font-bold ${lastGasSyncTime ? 'text-green-600' : 'text-red-500'}`}>{formatTime(lastGasSyncTime)}</span>
                                                    </p>
                                                    <p className="text-xs text-slate-600">
                                                        ระบบจะดึงข้อมูลอัตโนมัติทุก <span className="font-bold text-indigo-600">5 วินาที</span>
                                                    </p>
                                                    <div className="text-[10px] text-slate-400 font-mono h-12 overflow-hidden whitespace-pre-wrap border border-slate-100 bg-slate-50 p-1 rounded-md mx-auto max-w-full text-left">
                                                        {externalLinkMapping.substring(0, 100) || 'รอการดึงข้อมูล...'}
                                                    </div>
                                                    <p className="text-[10px] text-slate-400">แสดงผลลัพธ์ที่ดึงมาบางส่วน (คีย์, ลิ้งค์...)</p>
                                                </div>

                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="p-6 border-t border-slate-100 bg-white flex gap-3 z-10 flex-shrink-0">
                                    <button onClick={() => setShowSettings(false)} className="flex-1 py-3 text-slate-500 hover:bg-slate-100 rounded-xl font-bold transition-colors text-sm">ยกเลิก</button>
                                    <button onClick={handleSaveSettings} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all transform active:scale-95 text-sm">บันทึก</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* NEW: Link Data Modal (Table View) */}
                    {showLinkDataModal && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[110]">
                            <div className="bg-white rounded-3xl w-full max-w-xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
                                <div className="p-6 border-b border-slate-100 flex justify-between items-center">
                                    <h2 className="font-bold text-xl text-slate-800 flex items-center gap-2">
                                        <Icons.Sheet size={24} className="text-indigo-600"/> ข้อมูลลิ้งค์จาก Google Sheet (A-B)
                                    </h2>
                                    <button onClick={() => setShowLinkDataModal(false)} className="text-slate-400 hover:text-slate-600"><Icons.Cross size={24}/></button>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto p-6">
                                    <div className="text-sm text-slate-500 mb-4">
                                        ดึงข้อมูลล่าสุดเมื่อ: <span className={`font-bold ${lastGasSyncTime ? 'text-green-600' : 'text-red-500'}`}>{formatTime(lastGasSyncTime)}</span>
                                    </div>
                                    {externalLinkMapping ? (
                                        <table className="min-w-full divide-y divide-slate-200">
                                            <thead>
                                                <tr className="text-left text-xs font-bold text-slate-500 uppercase tracking-wider bg-slate-50">
                                                    <th className="p-3 w-1/4">Queue Key (A)</th>
                                                    <th className="p-3 w-3/4">Link (B)</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100 text-sm">
                                                {externalLinkMapping.split('\n').map((line, index) => {
                                                    const parts = line.split(',');
                                                    const key = parts[0].trim();
                                                    const link = parts.slice(1).join('').trim();
                                                    
                                                    if (!key) return null; // Skip empty lines or lines without key
                                                    
                                                    return (
                                                        <tr key={index} className="hover:bg-indigo-50/50">
                                                            <td className="p-3 font-mono font-bold text-slate-800 whitespace-nowrap">{key}</td>
                                                            <td className="p-3 text-xs text-slate-600 truncate max-w-[200px] hover:overflow-visible hover:whitespace-normal">
                                                                <a href={link.startsWith('http') ? link : `https://${link}`} target="_blank" className="text-blue-600 hover:underline">{link}</a>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    ) : (
                                        <div className="text-center text-slate-400 py-10">ไม่พบข้อมูลลิ้งค์</div>
                                    )}
                                </div>
                                <div className="p-4 border-t border-slate-100">
                                    <button onClick={() => setShowLinkDataModal(false)} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700">ปิด</button>
                                </div>
                            </div>
                        </div>
                    )}


                    {showHistory && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl animate-fade-in h-[80vh] flex flex-col">
                                <div className="p-6 border-b border-slate-100 flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <h2 className="font-bold text-xl flex items-center gap-2">
                                            <Icons.History/> 
                                            {showHistory === 'all' ? 'ประวัติทั้งหมด' : (showHistory === 'completed' ? 'รายการเสร็จสิ้น' : 'รายการยกเลิก')}
                                        </h2>
                                        {showHistory === 'all' && (
                                            <button onClick={() => setShowClearPopup(true)} className="text-xs text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 border border-red-200 px-3 py-1.5 rounded-lg flex items-center gap-1 transition-colors">
                                                <Icons.Trash size={12}/> ล้างข้อมูล
                                            </button>
                                        )}
                                    </div>
                                    <button onClick={() => setShowHistory(null)} className="p-2 hover:bg-slate-100 rounded-full transition-colors"><Icons.Cross/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                    {historyList.length > 0 ? historyList.map(q => (
                                        <div key={q.id} className="flex justify-between items-center p-4 bg-slate-50 rounded-xl">
                                            <div>
                                                <div className="font-bold text-slate-700 flex items-center gap-2">
                                                    {q.number} - {q.name}
                                                    <button onClick={() => setShowEditPopup({ queue: q })} className="text-slate-400 hover:text-indigo-600"><Icons.Edit size={16}/></button>
                                                </div>
                                                <div className="text-xs text-slate-400">
                                                    {/* Using createdAt for display here too */}
                                                    {formatDateTime(q.createdAt)} • <span className={`uppercase font-bold ${q.status==='completed'?'text-green-500':(q.status==='cancelled'?'text-red-500':'text-amber-500')}`}>{q.status}</span>
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => handleRecall(q.id)} className="text-sm bg-white border border-slate-200 px-3 py-1 rounded-lg hover:bg-indigo-50 hover:text-indigo-600 shadow-sm">เรียกซ้ำ</button>
                                                <button onClick={() => setShowConfirmPopup({ id: q.id, type: 'delete' })} className="text-sm bg-white border border-red-200 text-red-400 px-2 py-1 rounded-lg hover:bg-red-50 hover:text-red-600 shadow-sm"><Icons.Trash size={16}/></button>
                                            </div>
                                        </div>
                                    )) : <div className="text-center text-slate-400 mt-10">ไม่มีข้อมูล</div>}
                                </div>
                            </div>
                        </div>
                    )}

                    {showClearPopup && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[60]">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in border-t-4 border-red-500">
                                <h2 className="font-bold text-xl mb-4 text-red-600 flex items-center gap-2"><Icons.Trash size={24}/> ยืนยันการล้างคิว</h2>
                                <p className="text-sm text-slate-600 mb-4">การกระทำนี้ไม่สามารถกู้คืนได้ **ประวัติการจองของลูกค้าทั้งหมดจะหายไป** กรุณาใส่รหัสผ่านเพื่อยืนยัน</p>
                                <label className="block text-sm font-medium text-slate-700 mb-2">รหัสผ่าน Admin</label>
                                <input 
                                    ref={clearInputRef}
                                    type="password" 
                                    value={clearPassword} 
                                    onChange={e => setClearPassword(e.target.value)} 
                                    onKeyDown={e => { if (e.key === 'Enter') handleClearQueuesSubmit(); }}
                                    className="w-full border border-slate-200 rounded-xl px-4 py-3 text-lg outline-none focus:ring-2 focus:ring-red-500 transition-all mb-4 text-center" 
                                    placeholder="ใส่รหัสผ่าน" 
                                />
                                <div className="flex gap-2">
                                    <button onClick={() => setShowClearPopup(false)} className="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-xl">ยกเลิก</button>
                                    <button onClick={handleClearQueuesSubmit} className="flex-1 py-2 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700">ลบทั้งหมด</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showConfirmPopup && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[60]">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in">
                                <h2 className="font-bold text-xl mb-4 text-slate-800">ยืนยันการลบ</h2>
                                <p className="text-slate-600 mb-6">ต้องการลบรายการนี้ใช่หรือไม่?</p>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowConfirmPopup(null)} className="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-xl">ยกเลิก</button>
                                    <button onClick={handleDeleteConfirm} className="flex-1 py-2 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700">ลบ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showEditPopup && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[60]">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in">
                                <h2 className="font-bold text-xl mb-4 text-indigo-800 flex items-center gap-2"><Icons.Edit size={24}/> แก้ไขชื่อ</h2>
                                <input 
                                    ref={editInputRef}
                                    type="text" 
                                    value={editName} 
                                    onChange={e => setEditName(e.target.value)} 
                                    onKeyDown={e => { if (e.key === 'Enter') handleEditSubmit(); }}
                                    className="w-full border border-slate-200 rounded-xl px-4 py-3 text-lg outline-none focus:ring-2 focus:ring-indigo-500 transition-all mb-4" 
                                    placeholder="ชื่อใหม่" 
                                />
                                <div className="flex gap-2">
                                    <button onClick={() => setShowEditPopup(null)} className="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-xl">ยกเลิก</button>
                                    <button onClick={handleEditSubmit} className="flex-1 py-2 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">บันทึก</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
