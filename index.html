<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Q-Master Queue System</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; -webkit-tap-highlight-color: transparent; }
        .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }
        .animate-bounce-slow { animation: bounce 2s infinite; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ป้องกันการเด้งของหน้าจอใน iOS */
        html, body { overscroll-behavior-y: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // ==========================================
        // 1. ตั้งค่า FIREBASE Config (ค่าของคุณ)
        // ==========================================
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBsN1ACDYvJzoVc6mhtu9n-HNi1KDNFV24",
            authDomain: "project-6337867036145290950.firebaseapp.com",
            projectId: "project-6337867036145290950",
            storageBucket: "project-6337867036145290950.firebasestorage.app",
            messagingSenderId: "298203222498",
            appId: "1:298203222498:web:b3ef416d58b79c748ba9bb",
            measurementId: "G-1LJY6YJQBZ"
        };

        const initFirebase = () => {
            let config;
            if (YOUR_FIREBASE_CONFIG.apiKey === "วาง_API_KEY_ที่นี่" || YOUR_FIREBASE_CONFIG.apiKey === "") {
                 if (typeof __firebase_config !== 'undefined') {
                    config = JSON.parse(__firebase_config);
                 } else {
                    throw new Error("PLEASE_SETUP_FIREBASE");
                 }
            } else {
                config = YOUR_FIREBASE_CONFIG;
            }

            if (!firebase.apps.length) {
                try {
                    firebase.initializeApp(config);
                } catch (e) {
                    console.error("Firebase init failed", e);
                    throw e;
                }
            }
            return {
                auth: firebase.auth(),
                db: firebase.firestore()
            };
        };

        // --- Icons ---
        const Icon = ({ d, size=24, className="" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d}/></svg>
        );
        const Icons = {
            User: (p) => <Icon d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2 M12 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8" {...p} />,
            Monitor: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>,
            Bell: (p) => <Icon d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9 M10.3 21a1.94 1.94 0 0 0 3.4 0" {...p} />,
            Check: (p) => <Icon d="M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4 12 14.01l-3-3" {...p} />,
            Clock: (p) => <Icon d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20 M12 6v6l4 2" {...p} />,
            Users: (p) => <Icon d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8 M22 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75" {...p} />,
            Cross: (p) => <Icon d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20 M15 9l-6 6 M9 9l6 6" {...p} />,
            Volume: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>,
            Link: (p) => <Icon d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6 M15 3h6v6 M10 14L21 3" {...p} />,
            Alert: (p) => <Icon d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z M12 9v4 M12 17h.01" {...p} />,
            Loader: (p) => <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width={24} height={24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56" /></svg>,
            Settings: (p) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={p.size || 24} height={p.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}>
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2 0l-.45.45a2 2 0 0 0 0 2l.08.18a2 2 0 0 1 0 2l-.25.43a2 2 0 0 1-1.73 1l-.18.08a2 2 0 0 0 0 2v.44a2 2 0 0 0 2 2h.18a2 2 0 0 1 1.73 1l.25.43a2 2 0 0 1 0 2l.08.18a2 2 0 0 0 2 0l.45-.45a2 2 0 0 0 0-2l.18-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73v.18a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.18.08a2 2 0 0 0 2 0l.45-.45a2 2 0 0 0 0-2l-.08-.18a2 2 0 0 1 0-2l.25-.43a2 2 0 0 1 1.73-1l.18-.08a2 2 0 0 0 0-2v-.44a2 2 0 0 0-2-2h-.18a2 2 0 0 1-1.73-1l-.25-.43a2 2 0 0 1 0-2l-.08-.18a2 2 0 0 0-2 0l-.45.45a2 2 0 0 0 0 2l-.18.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                    <circle cx="12" cy="12" r="3" />
                </svg>
            ),
            Trash: (p) => <Icon d="M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" {...p} />,
            History: (p) => <Icon d="M3 3v5h5 M3.05 13A9 9 0 1 0 6 5.3L3 8" {...p} />
        };

        // --- Sound Helper: Play Beep Sound (ติ๊ด-ติ๊ด) ---
        // ใช้สำหรับลูกค้า (Kiosk) เท่านั้น
        const playBeepSound = () => {
            if ("vibrate" in navigator) {
                try { navigator.vibrate([200, 100, 200]); } catch(e){}
            }

            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            
            const ctx = new AudioContext();
            const beep = (startTime, freq) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(freq, startTime);
                gain.gain.setValueAtTime(0.1, startTime);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.1);
                osc.start(startTime);
                osc.stop(startTime + 0.1);
            };

            const now = ctx.currentTime;
            // เสียงติ๊ดสูง
            beep(now, 800);
            beep(now + 0.15, 800);
            // เพิ่มจังหวะปิดท้าย
            beep(now + 0.3, 1000);

            setTimeout(() => { if(ctx.state !== 'closed') ctx.close(); }, 1500);
        };

        // --- TTS Helper: พูดสาย ---
        // mode: 'display' = "ขอเชิญหมายเลข... คุณ... เข้ารับบริการ", 'client' = "หมายเลข... ถึงคิวของคุณแล้ว"
        const announceQueue = (queueNumber, customerName, mode = 'display') => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // หยุดเสียงเก่าก่อน

                const parts = queueNumber.split('-');
                let numberText = "";
                
                // อ่านเลขทีละตัว
                if (parts[0]) {
                    if (parts[0] === 'A') numberText += "เอ ";
                    else if (parts[0] === 'B') numberText += "บี ";
                    else numberText += parts[0] + " ";
                }

                if (parts[1]) {
                    for (let char of parts[1]) {
                        if (char === '0') numberText += "ศูนย์ ";
                        else if (char === '1') numberText += "หนึ่ง ";
                        else if (char === '2') numberText += "สอง ";
                        else if (char === '3') numberText += "สาม ";
                        else if (char === '4') numberText += "สี่ ";
                        else if (char === '5') numberText += "ห้า ";
                        else if (char === '6') numberText += "หก ";
                        else if (char === '7') numberText += "เจ็ด ";
                        else if (char === '8') numberText += "แปด ";
                        else if (char === '9') numberText += "เก้า ";
                    }
                }

                let spokenText = "";
                
                if (mode === 'display') {
                    // รูปแบบสำหรับจอรวม: "ขอเชิญหมายเลข A 0 0 1 คุณสมชาย เข้ารับบริการค่ะ"
                    spokenText = "ขอเชิญหมายเลข " + numberText;
                    if (customerName) {
                        spokenText += " คุณ" + customerName;
                    }
                    spokenText += " เข้ารับบริการค่ะ"; 
                } else {
                    // รูปแบบสำหรับลูกค้า: "หมายเลข A 0 0 1 ถึงคิวของคุณแล้ว"
                    spokenText = "หมายเลข " + numberText;
                    if (customerName) {
                       // spokenText += " คุณ" + customerName;
                    }
                    spokenText += " ถึงคิวของคุณแล้วค่ะ";
                }

                const utterance = new SpeechSynthesisUtterance(spokenText);
                utterance.lang = 'th-TH';
                utterance.rate = 0.85; 
                utterance.volume = 1;
                window.speechSynthesis.speak(utterance);
            }
        };

        const SetupError = ({ errorMsg }) => (
            <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                <div className="bg-white max-w-lg w-full rounded-2xl shadow-xl p-8 text-center border-t-4 border-red-500">
                    <div className="flex justify-center mb-4 text-red-500"><Icons.Alert size={64}/></div>
                    <h1 className="text-2xl font-bold text-slate-800 mb-2">เกิดข้อผิดพลาดในการเชื่อมต่อ</h1>
                    <p className="text-slate-600 mb-6 font-mono text-sm bg-slate-100 p-2 rounded break-all">{errorMsg}</p>
                    <a href="https://console.firebase.google.com/" target="_blank" className="inline-block bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-colors">ไปที่ Firebase Console</a>
                </div>
            </div>
        );

        // --- Wake Lock Hook (ป้องกันหน้าจอดับ) ---
        const useWakeLock = () => {
            const wakeLockRef = useRef(null);
            
            const requestWakeLock = async () => {
                if ('wakeLock' in navigator) {
                    try {
                        wakeLockRef.current = await navigator.wakeLock.request('screen');
                        console.log('Wake Lock active');
                    } catch (err) {
                        console.error(`${err.name}, ${err.message}`);
                    }
                }
            };

            const releaseWakeLock = async () => {
                if (wakeLockRef.current) {
                    await wakeLockRef.current.release();
                    wakeLockRef.current = null;
                }
            };

            // Re-request wake lock if visibility changes (e.g., user switches tabs and comes back)
            useEffect(() => {
                const handleVisibilityChange = () => {
                    if (wakeLockRef.current !== null && document.visibilityState === 'visible') {
                        requestWakeLock();
                    }
                };
                document.addEventListener('visibilitychange', handleVisibilityChange);
                return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
            }, []);

            return { requestWakeLock, releaseWakeLock };
        };

        function App() {
            const [viewMode, setViewMode] = useState('admin');
            const [queues, setQueues] = useState([]);
            const [myQueueId, setMyQueueId] = useState(() => localStorage.getItem('my_queue_id'));
            const [customerName, setCustomerName] = useState('');
            const [loading, setLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [services, setServices] = useState(null);
            const [user, setUser] = useState(null); 
            const [configError, setConfigError] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            const [audioEnabled, setAudioEnabled] = useState(false);
            
            const [queuePrefix, setQueuePrefix] = useState('A'); 
            const [showSettings, setShowSettings] = useState(false);
            const [showHistory, setShowHistory] = useState(null); 
            
            const lastAnnouncedMyQueueRef = useRef(null);
            const lastAnnouncedDisplayRef = useRef(null);
            const { requestWakeLock } = useWakeLock();
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-queue-app';

            useEffect(() => {
                try {
                    const { auth, db } = initFirebase();
                    setServices({ auth, db });
                    const unsubAuth = auth.onAuthStateChanged(async (u) => {
                        if (u) {
                            setUser(u); 
                        } else {
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    try { await auth.signInWithCustomToken(__initial_auth_token); } 
                                    catch { await auth.signInAnonymously(); }
                                } else { await auth.signInAnonymously(); }
                            } catch (authErr) {
                                setErrorMsg("Auth Error: " + authErr.message);
                                setConfigError(true);
                                setLoading(false);
                            }
                        }
                    });
                    const params = new URLSearchParams(window.location.search);
                    const mode = params.get('mode');
                    if (mode === 'kiosk') setViewMode('kiosk');
                    if (mode === 'display') setViewMode('display');
                    return () => unsubAuth();
                } catch (err) {
                    setErrorMsg(err.message);
                    setConfigError(true);
                    setLoading(false);
                }
            }, []);

            useEffect(() => {
                if (!services?.db || !user) return; 
                
                let collectionRef = (typeof __app_id !== 'undefined') 
                    ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues')
                    : services.db.collection('queues');

                const unsubQueues = collectionRef.onSnapshot(snapshot => {
                    const loaded = [];
                    snapshot.forEach(doc => loaded.push({ id: doc.id, ...doc.data() }));
                    loaded.sort((a, b) => a.createdAt - b.createdAt);
                    setQueues(loaded);
                    setLoading(false);
                }, err => { if (err.code !== 'permission-denied') console.error(err); setLoading(false); });

                let settingsRef = (typeof __app_id !== 'undefined')
                    ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('main')
                    : services.db.collection('settings').doc('main');

                const unsubSettings = settingsRef.onSnapshot(doc => {
                    if (doc.exists && doc.data().queuePrefix) {
                        setQueuePrefix(doc.data().queuePrefix);
                    }
                }, err => console.log("Settings sync skipped"));

                return () => {
                    unsubQueues();
                    unsubSettings();
                };
            }, [services, user]); 

            // ==========================================
            // LOGIC: ลูกค้า (Kiosk / Client Mode)
            // ==========================================
            useEffect(() => {
                if (!myQueueId || queues.length === 0) return;
                const myQ = queues.find(q => q.id === myQueueId);
                
                if (myQ && myQ.status === 'serving') {
                    const lastPlayed = lastAnnouncedMyQueueRef.current;
                    const isNewCall = !lastPlayed || lastPlayed.id !== myQ.id || lastPlayed.calledAt !== myQ.calledAt;

                    if (isNewCall) {
                        // REMOVED NOTIFICATION LOGIC HERE
                        
                        // 2. เสียงเตือนสำหรับลูกค้า
                        // เล่นเสียงติ๊ดๆ ก่อน
                        playBeepSound(); 
                        
                        // รอให้ติ๊ดจบ (ประมาณ 0.8 วิ) แล้วค่อยพูด
                        setTimeout(() => {
                            announceQueue(myQ.number, myQ.name, 'client'); 
                        }, 1000);
                        
                        lastAnnouncedMyQueueRef.current = { id: myQ.id, calledAt: myQ.calledAt };
                    }
                }
            }, [queues, myQueueId]);

            // ==========================================
            // LOGIC: จอรวม (Display Mode)
            // ==========================================
            useEffect(() => {
                if (viewMode !== 'display' || queues.length === 0) return;
                const currentServing = queues.find(q => q.status === 'serving');
                
                if (currentServing) {
                    const lastPlayed = lastAnnouncedDisplayRef.current;
                    const isNewCall = !lastPlayed || lastPlayed.id !== currentServing.id || lastPlayed.calledAt !== currentServing.calledAt;

                    if (isNewCall) {
                        // ไม่เล่นเสียงติ๊ด (playBeepSound) ที่หน้า Display ตามคำขอ
                        // ไม่ส่ง Notification
                        // พูดทันที
                        setTimeout(() => {
                            announceQueue(currentServing.number, currentServing.name, 'display');
                        }, 500);
                        
                        lastAnnouncedDisplayRef.current = { id: currentServing.id, calledAt: currentServing.calledAt };
                    }
                }
            }, [queues, viewMode]);

            const enableAudio = () => {
                const audio = new Audio('');
                audio.play().then(() => { 
                    setAudioEnabled(true); 
                    if (viewMode === 'kiosk') {
                        playBeepSound();
                        setTimeout(() => announceQueue("A-000", "ทดสอบ", "client"), 1000);
                    } else {
                        announceQueue("A-000", "ทดสอบ", "display");
                    }
                }).catch(() => setAudioEnabled(true));
            };

            const handleBookQueue = async (e) => {
                e.preventDefault();
                if (!customerName.trim() || !services || !user) return;
                setIsSubmitting(true);
                
                // REMOVED Notification.requestPermission()

                // เรียกใช้ Wake Lock เพื่อไม่ให้หน้าจอดับ (สำคัญมากสำหรับ iOS/Android เพื่อให้เสียงดังได้ตลอด)
                await requestWakeLock();

                // Unlock Audio context
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    try {
                        const ctx = new AudioContext();
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        gain.gain.value = 0; 
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.start(0);
                        osc.stop(0.1);
                        setTimeout(() => ctx.close(), 200);
                    } catch(e) { console.log("Audio unlock failed", e); }
                }

                const prefixQueues = queues.filter(q => q.number.startsWith(queuePrefix));
                const maxNum = prefixQueues.reduce((max, q) => {
                    const parts = q.number.split('-');
                    if (parts.length < 2) return max;
                    const n = parseInt(parts[1]);
                    return n > max ? n : max;
                }, 0);
                
                const nextNum = String(maxNum + 1).padStart(3, '0');
                const queueNumber = `${queuePrefix}-${nextNum}`;

                try {
                    let collectionRef = (typeof __app_id !== 'undefined') 
                        ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues')
                        : services.db.collection('queues');

                    const ref = await collectionRef.add({
                        number: queueNumber,
                        name: customerName,
                        status: 'waiting',
                        createdAt: Date.now(),
                        timestamp: new Date().toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})
                    });
                    localStorage.setItem('my_queue_id', ref.id);
                    setMyQueueId(ref.id);
                    setCustomerName('');
                } catch (err) { alert(err.message); } 
                finally { setIsSubmitting(false); }
            };

            const updateStatus = async (id, status) => {
                if (!user) return;
                try {
                    let docRef = (typeof __app_id !== 'undefined')
                        ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues').doc(id)
                        : services.db.collection('queues').doc(id);
                    
                    const updateData = { status };
                    if (status === 'serving') {
                        updateData.calledAt = Date.now();
                    }
                    
                    await docRef.update(updateData);
                } catch (err) { console.error(err); }
            };

            const handleRecall = async (id) => {
                if (!user) return;
                try {
                    let docRef = (typeof __app_id !== 'undefined')
                        ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues').doc(id)
                        : services.db.collection('queues').doc(id);
                    
                    await docRef.update({ 
                        status: 'serving', 
                        calledAt: Date.now() 
                    });
                    setShowHistory(null);
                } catch (err) { console.error(err); }
            };

            const handleClearQueues = async () => {
                if (!confirm("คุณแน่ใจหรือไม่ที่จะลบข้อมูลคิวทั้งหมด? (ไม่สามารถกู้คืนได้)")) return;
                if (!user) return;
                try {
                    const batch = services.db.batch();
                    let collectionRef = (typeof __app_id !== 'undefined')
                        ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('queues')
                        : services.db.collection('queues');
                    
                    const snapshot = await collectionRef.get();
                    snapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    alert("ล้างข้อมูลเรียบร้อยแล้ว");
                } catch (err) { alert("Error clearing: " + err.message); }
            };

            const handleSaveSettings = async () => {
                if (!user || !services) return;
                try {
                    let docRef = (typeof __app_id !== 'undefined')
                        ? services.db.collection('artifacts').doc(appId).collection('public').doc('data').collection('settings').doc('main')
                        : services.db.collection('settings').doc('main');
                    
                    await docRef.set({ queuePrefix: queuePrefix }, { merge: true });
                    setShowSettings(false);
                } catch (err) {
                    alert("บันทึกการตั้งค่าไม่สำเร็จ: " + err.message);
                }
            };

            const openKioskLink = () => {
                const url = new URL(window.location.href);
                url.searchParams.set('mode', 'kiosk');
                window.open(url.toString(), '_blank');
            };

            const waitingQueues = queues.filter(q => q.status === 'waiting');
            const currentServing = queues.find(q => q.status === 'serving');
            const myQueue = queues.find(q => q.id === myQueueId);
            const historyList = showHistory ? queues.filter(q => q.status === showHistory) : [];

            if (configError) return <SetupError errorMsg={errorMsg} />;
            if (loading) return <div className="h-screen flex items-center justify-center text-slate-400">กำลังเชื่อมต่อระบบ...</div>;

            if (viewMode === 'kiosk') {
                return (
                    <div className="min-h-screen bg-slate-100 flex flex-col items-center justify-center p-4">
                        <div className="absolute top-4 text-slate-400 text-sm font-bold tracking-widest uppercase">Q-Master Kiosk</div>
                        {(!myQueue || myQueue.status === 'completed' || myQueue.status === 'cancelled') ? (
                            <div className="bg-white w-full max-w-md rounded-3xl shadow-xl overflow-hidden animate-fade-in">
                                <div className="bg-indigo-600 p-8 text-white text-center">
                                    <h1 className="text-3xl font-bold mb-2">รับบัตรคิว</h1>
                                    <p className="text-indigo-100">กรอกชื่อเพื่อรับคิว ({queuePrefix})</p>
                                </div>
                                <div className="p-8">
                                    <form onSubmit={handleBookQueue} className="space-y-6">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-2">ชื่อของคุณ</label>
                                            <input autoFocus type="text" value={customerName} onChange={e => setCustomerName(e.target.value)} className="w-full px-4 py-4 text-lg border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="เช่น คุณสมชาย" disabled={isSubmitting} />
                                        </div>
                                        <button type="submit" disabled={isSubmitting} className={`w-full text-white font-bold py-4 rounded-xl text-lg shadow-lg shadow-indigo-200 transition-all flex items-center justify-center gap-2 ${isSubmitting ? 'bg-indigo-400' : 'bg-indigo-600 hover:bg-indigo-700 active:scale-95'}`}>
                                            {isSubmitting ? <><Icons.Loader size={24}/> กำลังบันทึก...</> : 'รับบัตรคิว'}
                                        </button>
                                        <div className="text-center text-slate-400 text-sm">รออยู่ <span className="text-indigo-600 font-bold">{waitingQueues.length}</span> คิว</div>
                                    </form>
                                </div>
                            </div>
                        ) : (
                            <div className="bg-white w-full max-w-md rounded-3xl shadow-xl overflow-hidden animate-fade-in relative">
                                <div className="h-2 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                                <div className="p-8 text-center space-y-8">
                                    <div><span className="bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-xs font-bold tracking-wide">YOUR QUEUE</span><h1 className="text-6xl sm:text-7xl font-black text-slate-800 mt-4 tracking-tighter">{myQueue.number}</h1></div>
                                    <div className={`inline-flex items-center gap-2 px-6 py-3 rounded-full font-bold shadow-sm ${myQueue.status === 'waiting' ? 'bg-amber-50 text-amber-600' : 'bg-green-50 text-green-600 animate-pulse'}`}>
                                        {myQueue.status === 'waiting' ? <><Icons.Clock size={20}/> กำลังรอเรียก...</> : <><Icons.Volume size={20}/> ถึงคิวคุณแล้ว!</>}
                                    </div>
                                    
                                    <div className="bg-slate-50 rounded-2xl p-6 border border-slate-100 space-y-4">
                                        <div className="flex justify-between items-end border-b border-slate-200 pb-3">
                                            <div className="text-left">
                                                <div className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">คิวปัจจุบัน</div>
                                                <div className="text-3xl font-black text-indigo-600 leading-none">
                                                    {currentServing ? currentServing.number : '--'}
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">รออีก (คิว)</div>
                                                <div className="text-3xl font-black text-slate-700 leading-none">
                                                    {queues.filter(q => q.status === 'waiting' && q.createdAt < myQueue.createdAt).length}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex justify-between items-center text-sm pt-1">
                                            <span className="text-slate-400">ชื่อผู้จอง</span>
                                            <span className="font-bold text-slate-700 truncate max-w-[150px]">{myQueue.name}</span>
                                        </div>
                                    </div>
                                    

                                    {myQueue.status === 'serving' && (
                                        <div className="text-green-600 font-bold animate-bounce-slow text-lg">
                                            เชิญเข้ารับบริการครับ
                                        </div>
                                    )}
                                    <button onClick={() => {localStorage.removeItem('my_queue_id'); setMyQueueId(null);}} className="text-slate-400 text-sm hover:text-slate-600 underline">จองคิวใหม่ / ออกจากหน้านี้</button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            if (viewMode === 'display') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 lg:p-8 bg-slate-100">
                        <div className="flex flex-col lg:flex-row gap-6 w-full max-w-[95vw] min-h-screen lg:h-[85vh] lg:min-h-0">
                            <div className="flex-1 bg-gradient-to-br from-indigo-600 to-purple-700 rounded-3xl shadow-2xl flex flex-col items-center justify-center text-white relative overflow-hidden p-8 min-h-[50vh] lg:min-h-0">
                                {!audioEnabled && <button onClick={enableAudio} className="absolute top-4 right-4 bg-white/20 px-4 py-2 rounded-full text-sm flex gap-2 z-50 hover:bg-white/30 transition-all"><Icons.Volume size={16}/> คลิกเพื่อเปิดเสียงพูด</button>}
                                <div className="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl transform translate-x-1/2 -translate-y-1/2"></div>
                                <h2 className="text-2xl font-medium opacity-80 mb-8 uppercase tracking-widest">Calling Queue</h2>
                                {currentServing ? (
                                    <div className="text-center animate-bounce-slow w-full">
                                        <div className="text-8xl md:text-[10rem] lg:text-[12rem] font-black leading-none tracking-tighter drop-shadow-lg">{currentServing.number}</div>
                                        <div className="mt-8 bg-white/20 backdrop-blur-md px-12 py-6 rounded-full inline-block max-w-full"><span className="text-3xl md:text-4xl font-bold truncate block">{currentServing.name}</span></div>
                                        <div className="mt-10 text-2xl md:text-3xl text-indigo-200 font-bold animate-pulse">เชิญเข้ารับบริการ</div>
                                    </div>
                                ) : (
                                    <div className="text-center opacity-40"><div className="text-8xl md:text-9xl font-black">---</div><div className="text-2xl mt-4">Waiting...</div></div>
                                )}
                            </div>
                            <div className="w-full lg:w-[35rem] bg-white rounded-3xl shadow-xl border border-slate-100 flex flex-col overflow-hidden h-[40vh] lg:h-auto">
                                <div className="p-6 bg-slate-50 border-b border-slate-100 font-bold text-slate-600 flex items-center gap-2"><Icons.Clock size={20} className="text-indigo-500"/> Next Queue</div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar">
                                    {waitingQueues.slice(0, 7).map((q) => (
                                        <div key={q.id} className="flex items-center justify-between p-5 bg-white border border-slate-100 rounded-xl shadow-sm">
                                            <div className="flex items-center gap-4 w-full">
                                                <div className="w-24 h-16 bg-slate-100 rounded-xl flex-shrink-0 flex items-center justify-center font-bold text-2xl text-slate-600 whitespace-nowrap">{q.number}</div>
                                                <div className="min-w-0 flex-1"><div className="font-bold text-slate-800 text-xl truncate">{q.name}</div><div className="text-sm text-slate-400">Waiting</div></div>
                                            </div>
                                        </div>
                                    ))}
                                    {waitingQueues.length === 0 && <div className="text-center py-10 text-slate-300">No waiting queues</div>}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 pb-10">
                    <div className="bg-white border-b border-slate-200 sticky top-0 z-50 px-4 py-3 shadow-sm">
                        <div className="max-w-7xl mx-auto flex flex-wrap justify-between items-center gap-4">
                            <div className="flex items-center gap-2 font-bold text-xl text-indigo-900"><div className="bg-indigo-600 text-white w-8 h-8 rounded flex items-center justify-center">Q</div><span className="hidden sm:inline">Q-Master Admin</span></div>
                            <div className="flex gap-2 bg-slate-100 p-1 rounded-lg">
                                <button onClick={() => setViewMode('admin')} className={`px-4 py-1.5 rounded-md text-sm font-bold ${viewMode==='admin'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>Admin</button>
                                <button onClick={() => setViewMode('display')} className={`px-4 py-1.5 rounded-md text-sm font-bold ${viewMode==='display'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>Display</button>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setShowSettings(true)} className="p-2 text-slate-500 hover:bg-slate-100 rounded-full flex-shrink-0"><Icons.Settings/></button>
                                <button onClick={openKioskLink} className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md"><Icons.Link size={16}/> <span className="hidden sm:inline">Kiosk Link</span></button>
                            </div>
                        </div>
                    </div>

                    <main className="max-w-7xl mx-auto p-4 md:p-6">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-2 space-y-6">
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                                        <h2 className="font-bold text-slate-800 flex items-center gap-2"><Icons.Monitor className="text-indigo-600"/> Calling</h2>
                                        <button onClick={handleClearQueues} className="text-xs text-red-400 hover:text-red-600 border border-red-200 px-3 py-1 rounded-full flex items-center gap-1"><Icons.Trash size={12}/> ล้างคิวทั้งหมด</button>
                                    </div>
                                    
                                    {currentServing ? (
                                        <div className="flex flex-col md:flex-row items-center justify-between gap-6 bg-indigo-50 rounded-xl p-6 border border-indigo-100">
                                            <div className="text-center md:text-left">
                                                <div className="text-xs font-bold text-indigo-400 uppercase">Serving Now</div>
                                                <div className="text-5xl font-black text-slate-800 mt-1 mb-2">{currentServing.number}</div>
                                                <div className="text-xl font-medium text-slate-600">คุณ {currentServing.name}</div>
                                            </div>
                                            <div className="flex flex-wrap gap-3 w-full md:w-auto">
                                                <button onClick={() => handleRecall(currentServing.id)} className="flex-1 min-w-[100px] flex items-center justify-center gap-2 bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-4 py-4 rounded-xl font-bold active:scale-95 transition-all"><Icons.Volume size={20}/> เรียกซ้ำ</button>
                                                <button onClick={() => updateStatus(currentServing.id, 'completed')} className="flex-1 min-w-[100px] flex items-center justify-center gap-2 bg-green-500 text-white px-8 py-4 rounded-xl font-bold shadow-lg shadow-green-200 active:scale-95"><Icons.Check/> เสร็จสิ้น</button>
                                                <button onClick={() => updateStatus(currentServing.id, 'cancelled')} className="flex-1 min-w-[100px] flex items-center justify-center gap-2 bg-white border border-red-200 text-red-500 px-6 py-4 rounded-xl font-bold active:scale-95"><Icons.Cross/> ยกเลิก</button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="border-2 border-dashed border-slate-200 rounded-xl p-10 text-center text-slate-400">ยังไม่มีการเรียกคิว</div>
                                    )}
                                </div>

                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                    <div className="p-6 border-b border-slate-100 h-16 flex justify-between items-center"><h2 className="font-bold text-slate-800 flex items-center gap-2"><Icons.Users className="text-indigo-600"/> Waiting ({waitingQueues.length})</h2></div>
                                    <div className="divide-y divide-slate-50">
                                        {waitingQueues.length > 0 ? waitingQueues.map((q) => (
                                            <div key={q.id} className="p-4 flex flex-col sm:flex-row items-center justify-between hover:bg-slate-50 gap-4">
                                                <div className="flex items-center gap-4 w-full sm:w-auto">
                                                    <div className="w-14 h-14 bg-slate-100 rounded-lg flex-shrink-0 flex items-center justify-center font-bold text-xl text-slate-600">{q.number}</div>
                                                    <div><div className="font-bold text-slate-800 text-lg">{q.name}</div><div className="text-xs text-slate-400">{q.timestamp}</div></div>
                                                </div>
                                                <button onClick={() => updateStatus(q.id, 'serving')} disabled={!!currentServing} className={`w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-2 rounded-lg font-bold text-sm shadow-sm ${currentServing ? 'bg-slate-100 text-slate-400' : 'bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95'}`}><Icons.Bell size={18}/> เรียกคิว</button>
                                            </div>
                                        )) : <div className="p-10 text-center text-slate-400">ไม่มีคิวรอเรียก</div>}
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 sticky top-24">
                                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wide mb-4">ภาพรวมวันนี้ (กดเพื่อดูประวัติ)</h3>
                                    <div className="space-y-3">
                                        <div className="flex justify-between items-center p-4 bg-slate-50 rounded-xl"><span className="text-slate-600 font-medium">ทั้งหมด</span><span className="text-2xl font-black text-slate-800">{queues.length}</span></div>
                                        <button onClick={() => setShowHistory('completed')} className="w-full flex justify-between items-center p-4 bg-green-50 hover:bg-green-100 rounded-xl transition-colors text-green-700"><span className="font-medium flex items-center gap-2"><Icons.History size={16}/> เสร็จสิ้น</span><span className="text-2xl font-black">{queues.filter(q => q.status==='completed').length}</span></button>
                                        <button onClick={() => setShowHistory('cancelled')} className="w-full flex justify-between items-center p-4 bg-red-50 hover:bg-red-100 rounded-xl transition-colors text-red-700"><span className="font-medium flex items-center gap-2"><Icons.History size={16}/> ยกเลิก</span><span className="text-2xl font-black">{queues.filter(q => q.status==='cancelled').length}</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>

                    {showSettings && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in">
                                <h2 className="font-bold text-xl mb-4">ตั้งค่าระบบ</h2>
                                <label className="block text-sm font-medium text-slate-700 mb-2">ตัวอักษรนำหน้าคิว (Prefix)</label>
                                <input type="text" value={queuePrefix} onChange={e => setQueuePrefix(e.target.value.toUpperCase())} className="w-full border border-slate-200 rounded-xl px-4 py-2 mb-6 text-center text-2xl font-bold uppercase" maxLength={2} />
                                <div className="flex gap-2">
                                    <button onClick={() => setShowSettings(false)} className="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-xl">ยกเลิก</button>
                                    <button onClick={handleSaveSettings} className="flex-1 py-2 bg-indigo-600 text-white rounded-xl font-bold">บันทึก</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showHistory && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl animate-fade-in h-[80vh] flex flex-col">
                                <div className="p-6 border-b border-slate-100 flex justify-between items-center">
                                    <h2 className="font-bold text-xl flex items-center gap-2"><Icons.History/> ประวัติ: {showHistory === 'completed' ? 'เสร็จสิ้น' : 'ยกเลิก'}</h2>
                                    <button onClick={() => setShowHistory(null)}><Icons.Cross/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                    {historyList.length > 0 ? historyList.map(q => (
                                        <div key={q.id} className="flex justify-between items-center p-4 bg-slate-50 rounded-xl">
                                            <div>
                                                <div className="font-bold text-slate-700">{q.number} - {q.name}</div>
                                                <div className="text-xs text-slate-400">{q.timestamp}</div>
                                            </div>
                                            <button onClick={() => handleRecall(q.id)} className="text-sm bg-white border border-slate-200 px-3 py-1 rounded-lg hover:bg-indigo-50 hover:text-indigo-600 shadow-sm">เรียกซ้ำ</button>
                                        </div>
                                    )) : <div className="text-center text-slate-400 mt-10">ไม่มีข้อมูล</div>}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
